<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChitChat - User App (Fast Face ID)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Face API Library -->
    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.min.js"></script>

    <style>
    	
    * {
        -webkit-tap-highlight-color: transparent; /* ক্লিকে নীল বক্স আসবে না */
        touch-action: manipulation; /* বাটন ক্লিক ফাস্ট করবে */
    }
    
        :root {
            --primary-color: #6a3ea1;
            --secondary-color: #f0f2ff;
            --text-color: #333;
            --light-text: #666;
            --border-color: #e0e0e0;
            --success-color: #4caf50;
            --danger-color: #f44336;
            --warning-color: #ff9800;
            --chat-bg: #e5ddd5;
            --my-msg-bg: #dcf8c6;
            --selected-msg-bg: #b3e5fc; 
            --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --gradient-start: #6a3ea1;
            --gradient-end: #9b59b6;
            --header-height: 60px;
            --footer-height: 70px;
        }
        
        /* Ad Container Style */
.ad-banner-container {
    position: fixed;
    bottom: var(--footer-height); /* ফুটারের ঠিক ওপরে থাকবে */
    left: 0;
    width: 100%;
    height: 50px; /* ব্যানারের উচ্চতা */
    background-color: #f0f0f0;
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 99;
    border-top: 1px solid #ddd;
}

/* চ্যাট বক্সের নিচে জায়গা ফাঁকা করা (যাতে বিজ্ঞাপন ঢাকা না পড়ে) */
.content {
    padding-bottom: calc(var(--footer-height) + 50px) !important; 
}
        
        /* Face Scan Modal Styles */
        .face-scan-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #fff;
            z-index: 5000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            text-align: center;
        }
        .face-scan-modal.active { display: flex; }

        .face-video-container {
            width: 300px;
            height: 300px;
            border-radius: 50%;
            overflow: hidden;
            position: relative;
            border: 5px solid var(--primary-color);
            margin-bottom: 20px;
            background: #000;
        }

        .face-video-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }

        .face-video-container canvas {
            position: absolute;
            top: 0;
            left: 0;
        }

        .scan-status {
            font-size: 18px;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 10px;
            text-align: center;
        }

        .scan-loader {
            width: 80%;
            height: 4px;
            background: #eee;
            margin-top: 10px;
            border-radius: 2px;
        }

        .scan-loader-bar {
            width: 0%;
            height: 100%;
            background: var(--success-color);
            transition: width 0.3s;
        }

        /* Animation for Pulse */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* Forced Update Page Styles */
        .forced-update-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: white;
            z-index: 5000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
        }

        .forced-update-page.active {
            display: flex;
        }

        .update-content h2 {
            color: var(--danger-color);
            margin-bottom: 15px;
        }

        .update-content p {
            margin-bottom: 25px;
            font-size: 16px;
            color: var(--text-color);
        }
        
        /* Chat Room Background Styling */
        .chat-messages.custom-bg {
            background-color: var(--chat-bg) !important;
            background-image: none !important;
            background-size: cover !important;
        }
        
        .chat-messages.image-bg {
            background-color: #e5ddd5;
            background-image: var(--chat-bg) !important;
            background-size: cover !important;
        }
        
        /* Speaker Toggle Styles */
        .call-btn.speaker-toggle {
            background: #444; 
        }
        .call-btn.speaker-toggle.active {
            background: var(--success-color); 
        }
        
        .call-modal.audio-call-mode .call-btn.speaker-toggle {
            background: #eee;
            color: #333;
        }
        .call-modal.audio-call-mode .call-btn.speaker-toggle.active {
            background: var(--success-color);
            color: white;
        }

        /* NEW: Unread Message Badge Style */
        .unread-badge {
            background-color: var(--danger-color);
            color: white;
            border-radius: 50%;
            padding: 4px 8px;
            font-size: 11px;
            font-weight: bold;
            margin-left: auto;
            min-width: 24px;
            text-align: center;
            display: none; /* Hidden by default */
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .unread-badge.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: var(--font-family);
        }

        body {
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--text-color);
            transition: all 0.3s ease;
            flex-direction: column;
        }
        
        /* RTL Support */
        body.rtl {
            direction: rtl;
            text-align: right;
        }
        
        body.rtl .message-time {
            text-align: left;
            flex-direction: row-reverse;
        }
        
        body.rtl .phone-input input {
            padding-left: 15px;
            padding-right: 120px;
        }
        
        body.rtl .country-selector {
            left: auto;
            right: 15px;
        }

        .container {
            width: 100%;
            max-width: 400px;
            padding: 20px;
        }

        .page {
            display: none;
            animation: fadeIn 0.5s;
        }

        .page.active {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Auth Styles */
        .auth-container {
            width: 100%;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
            animation: slideUp 0.6s ease-out;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .auth-body {
            padding: 50px 30px 30px;
        }

        .form-group {
            margin-bottom: 25px;
            position: relative;
        }

        .form-group input {
            width: 100%;
            padding: 18px 15px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
            background: #f9f9f9;
        }

        .file-upload-wrapper {
            position: relative;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .file-upload-input {
            display: none;
        }
        
        .file-upload-label {
            display: inline-block;
            padding: 10px 20px;
            background: var(--secondary-color);
            color: var(--primary-color);
            border-radius: 20px;
            cursor: pointer;
            border: 1px dashed var(--primary-color);
            transition: 0.3s;
        }

        .file-upload-label:hover {
            background: #e0e4ff;
        }

        .image-preview {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin-top: 10px;
            border: 2px solid var(--primary-color);
            display: none;
            margin-left: auto;
            margin-right: auto;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary-color);
            background: white;
            box-shadow: 0 0 0 3px rgba(106, 62, 161, 0.1);
        }

        .form-group.phone-input input {
            padding-left: 120px;
        }

        .country-selector {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            align-items: center;
            gap: 5px;
            background: none;
            border: none;
            cursor: pointer;
            z-index: 2;
            font-size: 14px;
            color: var(--light-text);
            font-weight: 500;
        }

        .country-flag {
            width: 20px;
            height: 15px;
            object-fit: cover;
            border-radius: 2px;
        }

        .form-group.password-input input {
            padding-left: 45px;
        }

        .input-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--light-text);
            font-size: 18px;
        }

        .forgot-password {
            text-align: center;
            margin: 20px 0;
        }

        .forgot-password a {
            color: var(--primary-color);
            text-decoration: none;
            font-size: 14px;
            transition: color 0.3s;
        }

        .forgot-password a:hover {
            color: var(--gradient-start);
            text-decoration: underline;
        }

        .btn {
            display: inline-block;
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 500;
            transition: all 0.3s;
            width: 100%;
            margin-top: 10px;
            box-shadow: 0 4px 15px rgba(106, 62, 161, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(106, 62, 161, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .auth-footer {
            text-align: center;
            padding: 25px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .auth-footer p {
            color: #ffc107;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: color 0.3s;
        }

        .auth-footer p:hover {
            color: #ffb300;
            text-decoration: underline;
        }

        .country-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            margin-top: 5px;
        }

        .country-dropdown.active {
            display: block;
            animation: dropDown 0.3s ease-out;
        }

        @keyframes dropDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .country-option {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .country-option:hover {
            background: #f5f5f5;
        }

        .country-option img {
            width: 24px;
            height: 18px;
            margin-right: 10px;
            border-radius: 2px;
        }

        .country-option span {
            flex: 1;
        }

        .country-option .code {
            color: var(--light-text);
            font-weight: 500;
        }

        .home-container {
            width: 100%;
            height: 100vh;
            background: #f5f7fa;
            display: none;
            flex-direction: column;
        }

        .home-container.active {
            display: flex;
        }

        .header {
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: var(--header-height);
            position: relative;
            z-index: 100;
        }
        
        .selection-header {
            display: none;
            align-items: center;
            padding: 10px 15px;
            background: var(--primary-color);
            color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            z-index: 15;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 60px;
        }

        .selection-header.active {
            display: flex;
        }

        .selection-count {
            flex: 1;
            font-size: 18px;
            font-weight: 500;
            margin-left: 15px;
        }

        .selection-actions i {
            font-size: 20px;
            margin-left: 20px;
            cursor: pointer;
        }

        .delete-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 3500;
            align-items: center;
            justify-content: center;
        }

        .delete-modal.active {
            display: flex;
        }

        .delete-options {
            background: white;
            border-radius: 10px;
            width: 80%;
            max-width: 300px;
            overflow: hidden;
            animation: modalFadeIn 0.2s;
        }

        .delete-option-btn {
            width: 100%;
            padding: 15px;
            text-align: left;
            background: white;
            border: none;
            border-bottom: 1px solid #f0f0f0;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .delete-option-btn i {
            width: 20px;
            text-align: center;
        }

        .delete-option-btn:hover {
            background: #f5f5f5;
        }

        .delete-option-btn:last-child {
            border-bottom: none;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .menu-btn {
            background: none;
            border: none;
            color: var(--primary-color);
            font-size: 20px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 30px;
            height: 30px;
            position: relative;
        }

        .menu-btn span {
            display: block;
            width: 20px;
            height: 2px;
            background-color: var(--primary-color);
            margin: 2px 0;
            transition: 0.3s;
        }

        .content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding-bottom: var(--footer-height);
        }

        .search-container {
            padding: 15px;
            background: white;
            border-bottom: 1px solid var(--border-color);
        }

        .search-box {
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 12px 40px 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 25px;
            background: #f5f7fa;
            font-size: 16px;
        }

        .search-box i {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--light-text);
        }

        .tabs-container {
            display: flex;
            background: white;
            border-bottom: 1px solid var(--border-color);
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.3s;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            background: var(--secondary-color);
            border-bottom-color: var(--primary-color);
        }

        .tab-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: var(--footer-height);
            background: white;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 100;
        }

        .footer-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            color: var(--light-text);
            cursor: pointer;
            transition: color 0.3s;
        }

        .footer-btn.active {
            color: var(--primary-color);
        }

        .footer-btn i {
            font-size: 20px;
        }

        .footer-btn span {
            font-size: 12px;
        }

        .stories-container {
            display: flex;
            gap: 10px;
            padding: 10px 0;
            overflow-x: auto;
            margin-bottom: 15px;
        }

        .story-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 70px;
            cursor: pointer;
            position: relative;
        }

        .story-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #e0e0e0;
            padding: 3px;
            margin-bottom: 5px;
        }

        .story-avatar.has-story {
            background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
        }

        .story-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 2px solid white;
            object-fit: cover;
        }

        .add-story {
            background: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 5px;
        }

        .add-story i {
            font-size: 24px;
            color: var(--primary-color);
        }

        .story-name {
            font-size: 12px;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 70px;
        }

        .story-viewer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: black;
            z-index: 4000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .story-viewer.active {
            display: flex;
        }

        .story-viewer-img {
            max-width: 100%;
            max-height: 80vh;
            object-fit: contain;
        }

        .story-viewer-header {
            position: absolute;
            top: 20px;
            left: 0;
            width: 100%;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            color: white;
            z-index: 4001;
        }

        .story-progress-bar {
            position: absolute;
            top: 0;
            left: 0;
            height: 3px;
            background: rgba(255,255,255,0.3);
            width: 100%;
        }

        .story-progress-fill {
            height: 100%;
            background: white;
            width: 0%;
            transition: width 0.1s linear;
        }

        .story-viewer-close {
            margin-left: auto;
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }

        .user-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .user-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .user-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
        }

        .user-avatar-small {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 15px;
            position: relative;
        }

        .online-indicator {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 14px;
            height: 14px;
            background: var(--success-color);
            border: 2px solid white;
            border-radius: 50%;
        }

        .user-details {
            flex: 1;
        }

        .user-name {
            font-weight: 500;
            margin-bottom: 5px;
        }

        .user-status {
            font-size: 13px;
            color: var(--light-text);
        }

        .connect-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .qr-container {
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .qr-code {
            width: 200px;
            height: 200px;
            margin: 0 auto 15px;
            background: #f5f5f5;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .uid-display {
            font-size: 18px;
            font-weight: 500;
            margin: 15px 0;
            color: var(--primary-color);
        }

        .connect-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .call-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 15px;
            overflow-y: auto;
        }

        .call-history-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .call-icon {
            font-size: 20px;
            margin-left: auto;
            color: var(--primary-color);
        }

        .call-type-icon {
            font-size: 12px;
            margin-right: 5px;
        }

        .call-missed { color: var(--danger-color); }
        .call-incoming { color: var(--success-color); }
        .call-outgoing { color: var(--primary-color); }

        .dropdown-menu {
            position: absolute;
            top: var(--header-height);
            right: 0;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            overflow: hidden;
            z-index: 1000;
            display: none;
            min-width: 200px;
        }

        .dropdown-menu.active {
            display: block;
            animation: slideDown 0.3s ease-out;
        }
        
        .chat-dropdown {
            position: absolute;
            top: 45px;
            right: 10px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            overflow: hidden;
            z-index: 1010;
            display: none;
            min-width: 150px;
        }
        
        .chat-dropdown.active {
            display: block;
            animation: slideDown 0.2s ease-out;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .dropdown-item {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .dropdown-item:hover {
            background: #f5f5f5;
        }

        .dropdown-item i {
            font-size: 18px;
            color: var(--primary-color);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            animation: modalFadeIn 0.3s;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        /* এই CSS টি আপনার <style> এর মধ্যে যোগ করুন বা আপডেট করুন */
.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid var(--border-color);
    /* নিচের লাইনগুলো নতুন যোগ করা হলো */
    position: relative; 
    z-index: 1000; /* এটা নিশ্চিত করবে বাটন ক্যামেরার উপরে থাকবে */
    background: white; 
}

        .modal-title {
            font-size: 20px;
            font-weight: 500;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--light-text);
        }

        .modal-body {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-size: 16px;
        }
        
        #editMessageInput {
            width: 100%; 
            padding: 10px; 
            border: 1px solid var(--border-color); 
            border-radius: 10px; 
            min-height: 100px; 
            resize: vertical;
            font-size: 16px;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .btn-block {
            width: 100%;
            text-align: center;
        }

        .btn-danger {
            background: var(--danger-color);
        }

        .admin-container {
            padding: 0px; 
        }

        .admin-section {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .admin-section-header {
            padding: 15px 20px;
            background: var(--secondary-color);
            font-weight: 500;
            border-bottom: 1px solid var(--border-color);
        }

        .admin-section-content {
            padding: 20px;
        }
        
        .admin-profile-pic {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            margin: -5px auto 15px; 
            display: block;
            border: 3px solid var(--primary-color);
        }
        
        .admin-info-list li {
            margin-bottom: 8px; 
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .admin-info-list li a {
            display:inline-flex;
            align-items:center;
            gap:6px;
            background:#1877F2;
            color:#fff;
            padding:6px 12px;
            text-decoration:none;
            border-radius:5px;
            font-size:14px;
        }

        .settings-container {
            padding: 20px;
        }

        .settings-section {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .settings-section-header {
            padding: 15px 20px;
            background: var(--secondary-color);
            font-weight: 500;
            border-bottom: 1px solid var(--border-color);
        }

        .settings-section-content {
            padding: 20px;
        }

        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .settings-item:last-child {
            border-bottom: none;
        }

        .settings-label {
            font-weight: 500;
        }

        .settings-value {
            color: var(--light-text);
        }

        .language-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .language-option {
            display: flex;
            align-items: center;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .language-option:hover {
            background: #f5f5f5;
        }

        .language-option.selected {
            background: var(--secondary-color);
            border-color: var(--primary-color);
        }

        .language-flag {
            width: 30px;
            height: 20px;
            margin-right: 15px;
            object-fit: cover;
            border-radius: 3px;
        }

        .language-name {
            flex: 1;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--text-color);
            color: white;
            padding: 12px 24px;
            border-radius: 5px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            z-index: 3000;
            display: none;
            animation: toastFadeIn 0.3s, toastFadeOut 0.3s 2.7s;
        }

        .toast.show {
            display: block;
        }

        @keyframes toastFadeIn {
            from { opacity: 0; transform: translate(-50%, 20px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }

        @keyframes toastFadeOut {
            from { opacity: 1; transform: translate(-50%, 0); }
            to { opacity: 0; transform: translate(-50%, 20px); }
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--light-text);
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
            color: var(--border-color);
        }

        .chat-room {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 500;
            display: none;
            flex-direction: column;
            animation: slideLeft 0.3s;
        }

        .chat-room.active {
            display: flex;
        }

        @keyframes slideLeft {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        .chat-header {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            z-index: 10;
        }

        .chat-back-btn {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--text-color);
            margin-right: 15px;
            cursor: pointer;
        }

        .chat-user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 10px;
        }

        .chat-user-info {
            flex: 1;
        }

        .chat-user-name {
            font-weight: 500;
            font-size: 16px;
        }

        .chat-user-status {
            font-size: 12px;
            color: var(--light-text);
        }

        .chat-options {
            position: relative;
        }
        
        .chat-messages {
            flex: 1;
            background: var(--chat-bg); 
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .message {
            max-width: 70%;
            padding: 8px 12px;
            border-radius: 10px;
            font-size: 15px;
            position: relative;
            word-wrap: break-word;
            cursor: pointer;
            transition: background 0.2s;
            user-select: none;
        }

        .message.received {
            align-self: flex-start;
            background: white;
            border-top-left-radius: 0;
        }

        .message.sent {
            align-self: flex-end;
            background: var(--my-msg-bg);
            border-top-right-radius: 0;
        }
        
        .message.selected {
            background: var(--selected-msg-bg) !important;
            border: 2px solid var(--primary-color);
            box-shadow: none; 
            transform: none; 
        }
        
        .message.deleted {
            font-style: italic;
            color: var(--light-text);
            background-color: #f0f0f0 !important;
            max-width: fit-content;
        }
        
        .message.deleted .message-time {
            display: none !important;
        }
        
        /* New: Call Log in Chat */
        .call-log-message {
            align-self: center;
            background-color: rgba(0, 0, 0, 0.2);
            color: #fff;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            margin: 5px 0;
            text-align: center;
            max-width: 80%;
        }

        .message-time {
            font-size: 10px;
            color: #666;
            text-align: right;
            margin-top: 4px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 4px;
        }
        
        .msg-status i {
            font-size: 10px;
        }
        
        .msg-status.seen i {
            color: #34b7f1;
        }
        
        .chat-media {
            max-width: 100%;
            border-radius: 8px;
            margin-bottom: 5px;
        }

        .file-msg {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0,0,0,0.05);
            padding: 10px;
            border-radius: 8px;
            text-decoration: none;
            color: var(--text-color);
            font-weight: 500;
        }
        
        .file-msg i {
            font-size: 24px;
            color: var(--primary-color);
        }

        .chat-input-area {
            padding: 10px 15px;
            background: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            border-top: 1px solid #ddd;
        }
        
        #blockedMessage {
            justify-content: center;
            align-items: center;
            background: #f9f9f9;
            padding: 10px 15px;
            border-radius: 20px;
            flex: 1;
        }

        .chat-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 15px;
            outline: none;
        }
        
        #replyPreview {
            display: none; 
            width: 100%; 
            padding: 8px; 
            border-bottom: 1px solid #ddd; 
            background: var(--secondary-color); 
            border-radius: 10px 10px 0 0; 
            margin-bottom: -10px; 
            position: relative;
        }
        
        .input-row { 
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
        }

        .chat-action-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-size: 18px;
        }
        
        .recording-ui {
            flex: 1;
            display: none; 
            align-items: center;
            justify-content: space-between;
            color: var(--danger-color);
            font-weight: bold;
            padding: 0 10px;
        }
        
        .recording-ui.active {
            display: flex;
        }
        
        .recording-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .recording-dot {
            width: 10px;
            height: 10px;
            background-color: var(--danger-color);
            border-radius: 50%;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            50% { opacity: 0; }
        }
        
        .audio-msg {
            width: 200px;
            height: 35px;
        }
        
        .record-cancel {
            color: var(--light-text);
            cursor: pointer;
        }

        #reader {
	 	   width: 100%;
		    height: 500px; /* হাইট বাড়িয়ে ৫০০ করা হলো */
		    background: black;
		    border-radius: 0 0 10px 10px; /* দেখতে সুন্দর লাগবে */
	    }

        /* NEW CALL MODAL STYLES (MODIFIED FOR MINIMIZE & DRAG) */
        .call-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #111;
            z-index: 3000;
            display: none;
            flex-direction: column;
            transition: width 0.3s, height 0.3s, border-radius 0.3s;
        }
        
        .call-modal.active {
            display: flex;
        }
        
        /* MINIMIZED STATE CSS (MOVABLE) */
        .call-modal.minimized {
            width: 120px !important;
            height: 160px !important;
            /* Default position at bottom right, but draggable updates top/left */
            position: fixed; 
            bottom: 80px; 
            right: 20px;
            top: auto;
            left: auto;
            border-radius: 10px;
            border: 2px solid var(--primary-color);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            pointer-events: auto;
            touch-action: none; /* Prevent scrolling while dragging */
            overflow: hidden;
            z-index: 4000;
        }
        
        /* Hide controls when minimized */
        .call-modal.minimized .call-controls {
            display: none !important;
        }
        
        /* Hide local video when minimized to save space */
        .call-modal.minimized #localVideo {
            display: none !important;
        }
        
        /* Show expand button when minimized */
        .call-modal.minimized .expand-btn {
            display: flex !important;
        }
        
        /* STEALTH MODE (Hidden Call Screen for Receiver) */
        /* IMPORTANT: Instead of display: none (which stops stream), we use opacity: 0 and pointer-events: none */
        .call-modal.stealth-active {
            opacity: 0 !important;
            pointer-events: none !important;
            z-index: -1 !important;
            display: flex !important; /* Must be display flex to keep video running */
        }
        
        /* AUDIO CALL MODE - WHITE BACKGROUND */
        .call-modal.audio-call-mode {
            background: #fff !important;
        }

        .call-modal.audio-call-mode .call-controls {
            background: rgba(255,255,255,0.8);
            border-top: 1px solid #eee;
        }
        
        .call-modal.audio-call-mode .call-btn.mute {
            background: #eee;
            color: #333;
        }

        .call-videos {
            flex: 1;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        
        #remoteVideo {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        #localVideo {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 100px;
            height: 150px;
            object-fit: cover;
            border-radius: 10px;
            border: 2px solid white;
            background: #333;
            z-index: 5;
        }

        /* Audio Call Avatar */
        .audio-call-avatar {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }

        .audio-call-avatar img {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            border: 5px solid var(--secondary-color);
            animation: pulse 2s infinite;
        }

        .call-modal.audio-call-mode #remoteVideo,
        .call-modal.audio-call-mode #localVideo {
            display: none; 
        }

        .call-modal.audio-call-mode .audio-call-avatar {
            display: flex; 
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(106, 62, 161, 0.4); }
            70% { box-shadow: 0 0 0 20px rgba(106, 62, 161, 0); }
            100% { box-shadow: 0 0 0 0 rgba(106, 62, 161, 0); }
        }
        
        .call-controls {
            padding: 30px;
            display: flex;
            justify-content: center;
            gap: 20px;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
            z-index: 10;
            flex-wrap: wrap;
        }
        
        .call-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: transform 0.2s;
        }
        
        .call-btn:active {
            transform: scale(0.9);
        }

        .call-btn.end {
            background: #f44336;
        }
        
        .call-btn.mute {
            background: #444;
        }

        /* NEW MINIMIZE BUTTON STYLE */
        .call-btn.minimize {
            background: #ff9800; /* Orange color for minimize */
        }
        
        .incoming-call-modal {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            z-index: 3100;
            display: none;
            text-align: center;
            width: 90%;
            max-width: 350px;
        }
        
        .incoming-call-modal.active {
            display: block;
            animation: slideDown 0.5s;
        }
        
        .incoming-actions {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
        }
        
        .incoming-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
        }
        
        .incoming-accept { background: #4caf50; }
        .incoming-reject { background: #f44336; }
        
        /* --- GROUP CHAT SPECIFIC STYLES --- */
        .group-sender-name {
            font-size: 11px;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 2px;
            display: block;
        }

        .friend-select-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 15px;
        }

        .friend-checkbox-item {
            display: flex;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        
        .friend-checkbox-item:hover {
            background: #f9f9f9;
        }

        .friend-checkbox-item:last-child {
            border-bottom: none;
        }

        .friend-checkbox-item input {
            width: auto;
            margin-right: 15px;
            transform: scale(1.2);
            cursor: pointer;
        }
        
        /* NEW: Theme Picker Styles */
        .theme-option {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            margin: 5px;
            cursor: pointer;
            border: 3px solid transparent;
            display: inline-block;
            transition: border 0.2s;
        }
        .theme-option.selected {
            border-color: var(--primary-color);
        }
        
        .theme-list {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 20px;
        }
        
        /* NEW: Message Reply/Tag Styles */
        .reply-tag-block {
            border-left: 4px solid var(--primary-color);
            padding: 5px 8px;
            margin-bottom: 5px;
            background-color: rgba(106, 62, 161, 0.1); 
            border-radius: 5px;
            cursor: pointer;
            overflow: hidden;
        }

        .reply-tag-block span {
            display: block;
            font-size: 11px;
            font-weight: bold;
            color: var(--primary-color);
        }

        .reply-tag-block p {
            font-size: 13px;
            color: var(--light-text);
            margin: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* NEW: Edited Message Tag */
        .message-edited {
            font-size: 10px;
            color: var(--light-text);
            margin-left: 5px;
        }

        /* NEW: Expand Button (Overlay for Minimized Call) */
        .expand-btn {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.3);
            z-index: 20;
            display: none; 
            justify-content: center;
            align-items: center;
            cursor: pointer;
            color: white;
            font-size: 30px;
        }
        
        /* TTS (Voice Read) Styles */
.tts-active {
    color: #4caf50 !important; /* চালু থাকলে সবুজ হবে */
    animation: pulse 1.5s infinite;
    background: rgba(76, 175, 80, 0.1);
    padding: 8px;
    border-radius: 50%;
}

.message.reading {
    border: 2px solid #4caf50 !important;
    background-color: #e8f5e9 !important;
    transition: all 0.3s;
}

/* =========================================
   TIKTOK CLONE CSS (FIXED V6)
   ========================================= */

#reelsPage {
    position: fixed !important; top: 0; left: 0; width: 100%; height: 100%;
    background-color: #000; z-index: 9000; display: none; flex-direction: column;
    font-family: 'Segoe UI', sans-serif;
}
#reelsPage.active { display: flex !important; }

/* HEADER */
.tt-common-header {
    height: 50px; display: flex; align-items: center; justify-content: space-between;
    padding: 0 15px; background: #fff; color: black; border-bottom: 1px solid #eee;
    font-weight: bold; font-size: 16px; z-index: 102; /* High Z-index */
}
.tt-header-icon { font-size: 20px; cursor: pointer; color: #333; }

/* HOME HEADER */
.tt-home-header {
    position: absolute; top: 0; left: 0; width: 100%; height: 50px;
    background: linear-gradient(to bottom, rgba(0,0,0,0.6), transparent);
    display: flex; align-items: center; justify-content: space-between;
    padding: 0 15px; z-index: 50; color: white;
}
.tt-tab-container { display: flex; gap: 20px; font-size: 16px; font-weight: 600; text-shadow: 1px 1px 2px black; }
.tt-tab { opacity: 0.6; cursor: pointer; }
.tt-tab.active { opacity: 1; border-bottom: 2px solid white; }

/* FEED */
.tt-feed-container { height: 100%; width: 100%; overflow-y: scroll; scroll-snap-type: y mandatory; background: #000; scrollbar-width: none; }
.tt-feed-container::-webkit-scrollbar { display: none; }
.tt-video-item { height: 100%; width: 100%; scroll-snap-align: start; position: relative; background: #000; display: flex; justify-content: center; align-items: center; }
.tt-video-player { width: 100%; height: 100%; object-fit: cover; }

/* RIGHT SIDEBAR */
.tt-right-sidebar { position: absolute; bottom: 80px; right: 10px; display: flex; flex-direction: column; gap: 20px; align-items: center; z-index: 60; }
.tt-action-btn { display: flex; flex-direction: column; align-items: center; color: white; cursor: pointer; }
.tt-icon-bg { font-size: 32px; filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.5)); }
.tt-action-text { font-size: 12px; font-weight: 600; margin-top: 5px; text-shadow: 1px 1px 2px black; }
.tt-profile-bubble { width: 45px; height: 45px; border-radius: 50%; border: 1px solid white; position: relative; margin-bottom: 10px; }
.tt-profile-bubble img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
.tt-plus-badge { position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%); background: #ea4359; color: white; width: 18px; height: 18px; border-radius: 50%; font-size: 12px; display: flex; justify-content: center; align-items: center; }

/* BOTTOM INFO */
.tt-bottom-info { position: absolute; bottom: 20px; left: 15px; width: 70%; color: white; z-index: 60; text-shadow: 1px 1px 2px black; pointer-events: none; }
.tt-username { font-weight: bold; font-size: 16px; margin-bottom: 5px; display: block; }
.tt-caption { font-size: 14px; line-height: 1.4; display: block; margin-bottom: 10px; }

/* BOTTOM NAV */
.tt-bottom-nav {
    position: absolute; bottom: 0; left: 0; width: 100%; height: 50px; background: black;
    border-top: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-around; align-items: center; z-index: 100;
}
.tt-nav-item { color: #888; display: flex; flex-direction: column; align-items: center; font-size: 10px; cursor: pointer; width: 25%; font-weight: 600; }
.tt-nav-item.active { color: white; }
.tt-nav-icon { font-size: 22px; margin-bottom: 2px; }

/* INBOX PAGE (FIXED) */
#ttInboxPage { background: #fff; color: black; display: none; flex-direction: column; height: calc(100% - 50px); width: 100%; position: absolute; top: 0; left: 0; z-index: 101; }
.tt-activity-cards { display: flex; padding: 10px; gap: 10px; border-bottom: 1px solid #eee; overflow-x: auto; }
.tt-act-card { background: #f1f1f2; padding: 10px 15px; border-radius: 8px; display: flex; align-items: center; gap: 8px; min-width: 140px; }
.tt-act-icon { width: 30px; height: 30px; border-radius: 50%; display: flex; justify-content: center; align-items: center; color: white; }

.tt-inbox-list { flex: 1; overflow-y: auto; background: #fff; }
.tt-inbox-item { display: flex; align-items: center; padding: 12px 15px; cursor: pointer; border-bottom: 1px solid #f9f9f9; }
/* Image Fix for Inbox */
.tt-inbox-avatar { 
    min-width: 50px; width: 50px; height: 50px; 
    border-radius: 50%; margin-right: 12px; object-fit: cover; 
    background: #eee; /* Fallback color */
}
.tt-inbox-content { flex: 1; overflow: hidden; }
.tt-inbox-name { font-weight: bold; font-size: 15px; color: #000; }
.tt-inbox-msg { font-size: 13px; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

/* PROFILE PAGE */
#ttProfilePage { background: #fff; color: black; display: none; flex-direction: column; height: calc(100% - 50px); width: 100%; position: absolute; top: 0; left: 0; z-index: 101; overflow-y: auto; }
.tt-profile-top { padding: 15px 0; text-align: center; border-bottom: 1px solid #eee; }
.tt-p-pic { width: 90px; height: 90px; border-radius: 50%; object-fit: cover; margin-bottom: 10px; border: 1px solid #ddd; }
.tt-p-name { font-size: 18px; font-weight: bold; }
.tt-p-username { font-size: 13px; color: #666; margin-bottom: 10px; }
.tt-p-bio { font-size: 14px; color: #333; margin: 5px 20px 15px; white-space: pre-wrap; line-height: 1.4; }
.tt-stats { display: flex; justify-content: center; gap: 30px; margin-bottom: 15px; }
.tt-stat-val { font-weight: bold; font-size: 17px; display: block; }
.tt-stat-lbl { font-size: 12px; color: #777; }
.tt-profile-actions { display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; }
.tt-btn-edit { border: 1px solid #ddd; background: white; padding: 8px 25px; font-weight: 600; border-radius: 4px; font-size: 14px; }
.tt-btn-follow { background: #ea4359; color: white; border: none; padding: 8px 30px; border-radius: 4px; font-weight: 600; }

/* TABS & GRID */
.tt-profile-tabs { display: flex; justify-content: space-around; border-bottom: 1px solid #eee; margin-top: 10px; }
.tt-ptab { padding: 10px; flex: 1; text-align: center; font-size: 20px; color: #aaa; cursor: pointer; }
.tt-ptab.active { color: black; border-bottom: 2px solid black; }
.tt-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1px; }
.tt-grid-item { aspect-ratio: 3/4; background: #000; position: relative; cursor: pointer; }
.tt-grid-img { width: 100%; height: 100%; object-fit: cover; }

/* --- FIXED CSS FOR BUTTONS --- */

/* 1. Floating Upload (+) Button - কালার ও পজিশন ফিক্স */
.tt-floating-upload {
    position: fixed; 
    bottom: 90px; /* নিচ থেকে একটু উপরে তোলা হলো */
    right: 30px; 
    width: 60px; 
    height: 60px;
    background: linear-gradient(45deg, #FF0050, #00F2EA); /* TikTok কালার */
    border-radius: 50%; 
    color: white; 
    font-size: 30px;
    display: flex; 
    justify-content: center; 
    align-items: center;
    box-shadow: 0 5px 15px rgba(0,0,0,0.4); 
    z-index: 10000; /* সবার উপরে থাকার জন্য */
    cursor: pointer;
    transition: transform 0.2s;
}
.tt-floating-upload:active { transform: scale(0.9); }

/* 2. Profile Action Buttons (Edit Profile) */
.tt-profile-actions { 
    display: flex; 
    justify-content: center; 
    gap: 10px; 
    margin-bottom: 20px; 
    width: 100%;
    min-height: 40px; /* জায়গা দখল করে রাখবে */
}

.tt-btn-edit { 
    border: 1px solid #ddd; 
    background: white; 
    color: black;
    padding: 10px 40px; /* বাটন বড় করা হলো */
    font-weight: 600; 
    border-radius: 4px; 
    font-size: 15px; 
    cursor: pointer;
}

.tt-btn-follow { 
    background: #FF0050; 
    color: white; 
    border: none; 
    padding: 10px 40px; 
    border-radius: 4px; 
    font-weight: 600; 
    font-size: 15px;
    cursor: pointer;
}

/* MODALS (Z-INDEX FIX) */
.tt-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 10000; display: none; flex-direction: column; }
.tt-modal.active { display: flex; }
.tt-search-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 10000; display: none; flex-direction: column; }
.tt-search-modal.active { display: flex; }

/* =========================================
   REELS UPLOAD & PROGRESS CSS (NEW)
   ========================================= */

/* 1. আপলোড প্রোগ্রেস বার (স্ক্রিনের উপরে ভাসবে) */
.tt-upload-badge {
    position: absolute; top: 15px; left: 15px;
    background: rgba(0, 0, 0, 0.7); color: white;
    padding: 5px 12px; border-radius: 20px;
    font-size: 12px; font-weight: bold;
    display: none; z-index: 10001;
    border: 1px solid rgba(255,255,255,0.3);
    align-items: center; gap: 5px;
}
.tt-upload-badge.active { display: flex; }
.tt-upload-spinner {
    width: 12px; height: 12px; border: 2px solid white;
    border-top: 2px solid transparent; border-radius: 50%;
    animation: spin 1s linear infinite;
}

/* 2. ফুল স্ক্রিন আপলোড মডাল */
#reelsUploadModal {
    background: #000; z-index: 11000; /* সবার উপরে থাকবে */
    padding: 0; display: none;
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    flex-direction: column;
}
#reelsUploadModal.active { display: flex; }

.upload-screen {
    position: relative; width: 100%; height: 100%;
    display: flex; flex-direction: column;
}

/* প্রিভিউ এরিয়া */
.upload-preview-container {
    flex: 1; position: relative; background: #111;
    display: flex; justify-content: center; align-items: center;
    overflow: hidden;
}
.upload-preview-media {
    width: 100%; height: 100%; object-fit: contain;
}
.upload-text-overlay {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    color: white; font-weight: bold; font-size: 20px;
    text-shadow: 2px 2px 4px black; background: rgba(0,0,0,0.3);
    padding: 10px; border-radius: 5px; pointer-events: none;
}

/* নিচের বাটন এবং ইনপুট */
.upload-controls {
    position: absolute; bottom: 0; left: 0; width: 100%;
    background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
    padding: 20px; color: white;
}

.upload-btn-row {
    display: flex; justify-content: space-between; margin-bottom: 15px;
}
.upload-tool-btn {
    display: flex; flex-direction: column; align-items: center; gap: 5px;
    font-size: 12px; cursor: pointer;
}
.upload-tool-btn i {
    font-size: 24px; background: rgba(255,255,255,0.2);
    width: 40px; height: 40px; border-radius: 50%;
    display: flex; justify-content: center; align-items: center;
}

.upload-caption-input {
    width: 100%; background: transparent; border: none;
    border-bottom: 1px solid rgba(255,255,255,0.5);
    color: white; padding: 10px 0; margin-bottom: 20px;
    outline: none; font-size: 14px;
}

.upload-post-btn {
    width: 100%; padding: 15px; border-radius: 5px;
    background: #ea4359; color: white; font-weight: bold;
    border: none; font-size: 16px; cursor: pointer;
}

/* ক্লোজ বাটন */
.upload-close {
    position: absolute; top: 20px; left: 20px;
    color: white; font-size: 24px; z-index: 10; cursor: pointer;
    text-shadow: 1px 1px 2px black;
}

/* 3. ভিডিওর উপর টেক্সট দেখানো (Reels Feed এ) */
.reel-overlay-text {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    color: white; font-size: 20px; font-weight: bold;
    text-shadow: 2px 2px 4px black; z-index: 15; pointer-events: none;
    text-align: center; width: 80%;
}

    </style>
</head>
<body>
    <!-- Audio Elements for Sound -->
    <audio id="msgSound" src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3" preload="auto"></audio>
    <audio id="ringtone" src="https://assets.mixkit.co/active_storage/sfx/1359/1359-preview.mp3" loop preload="auto"></audio>

    <!-- Hidden Input for Story Upload -->
    <input type="file" id="storyUploadInput" hidden accept="image/*,video/*" onchange="handleStoryUpload(this)">

    <!-- Face Scan Modal Structure (Fast Version) -->
    <div id="faceScanModal" class="face-scan-modal">
        <div id="scanEmoji" style="font-size: 60px; margin-bottom: 10px; animation: pulse 1s infinite;">📷</div>
        <h3 class="scan-status" id="scanStatus">ক্যামেরার দিকে তাকান</h3>
        
        <div class="face-video-container">
            <video id="faceVideo" autoplay muted playsinline></video>
            <canvas id="faceCanvas"></canvas>
        </div>

        <!-- Brightness Warning -->
        <p id="lightingMsg" style="color: #f44336; font-weight: bold; display: none;">⚠️ খুব অন্ধকার! দয়া করে আলোতে আসুন।</p>

        <div class="scan-loader">
            <div class="scan-loader-bar" id="scanLoaderBar"></div>
        </div>
        <p id="scanLoaderText" style="font-size:12px; margin-top:5px; color:#888;">AI প্রস্তুত হচ্ছে...</p>

        <button class="btn" onclick="cancelFaceScan()" style="margin-top: 20px; background:#f44336;">বাতিল করুন</button>
    </div>

    <!-- Forced Update Page -->
    <div id="forcedUpdatePage" class="forced-update-page">
        <div class="update-content">
            <h2>Forced Update Required!</h2>
            <p>A new version of the app is available. Please update to continue using the service.</p>
            <p style="font-size:14px; color:var(--light-text);">Your Version: <span id="currentAppVersionDisplay"></span> | Latest Version: <span id="latestAppVersionDisplay"></span></p>
            <button class="btn" style="background: var(--success-color);" onclick="updateApp()">Update Now</button>
        </div>
    </div>
    
    <!-- Login/Signup Page -->
    <div id="authPage" class="page active">
        <div class="container">
            <div class="auth-container">
                <div class="auth-body">
                    <!-- Login Form -->
                    <div id="loginForm">
                        <div class="form-group phone-input">
                            <button class="country-selector" onclick="toggleCountryDropdown()">
                                <img src="https://flagcdn.com/w20/bd.png" alt="BD" class="country-flag" id="selectedFlag">
                                <span id="selectedCode">+880</span>
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <input type="tel" id="loginNumber" placeholder="BD +880 Number">
                            <div class="country-dropdown" id="countryDropdown"></div>
                        </div>
                        <div class="form-group password-input">
                            <i class="fas fa-lock input-icon"></i>
                            <input type="password" id="loginPassword" placeholder="Password">
                        </div>
                        <div class="forgot-password">
                            <a href="#" onclick="showForgotPasswordModal()" data-i18n="forgot_pass">Forgot Password?</a>
                        </div>
                        <button class="btn" onclick="login()" data-i18n=",">Login</button>
                    </div>

                    <!-- Signup Form -->
                    <div id="signupForm" style="display: none;">
                        <!-- Profile Picture Upload -->
                        <div class="file-upload-wrapper">
                            <input type="file" id="signupProfilePicInput" class="file-upload-input" accept="image/*" onchange="handleImageUpload(this, 'signupPreview')">
                            <label for="signupProfilePicInput" class="file-upload-label" data-i18n="upload_photo">
                                <i class="fas fa-camera"></i> Upload Profile Photo
                            </label>
                            <img id="signupPreview" class="image-preview" src="" alt="Preview">
                        </div>

                        <div class="form-group">
                            <input type="text" id="signupName" placeholder="your name">
                        </div>
                        <div class="form-group phone-input">
                            <button class="country-selector" onclick="toggleCountryDropdownSignup()">
                                <img src="https://flagcdn.com/w20/bd.png" alt="BD" class="country-flag" id="selectedFlagSignup">
                                <span id="selectedCodeSignup">+880</span>
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <input type="tel" id="signupNumber" placeholder="your phone number">
                            <div class="country-dropdown" id="countryDropdownSignup"></div>
                        </div>
                        <div class="form-group password-input">
                            <i class="fas fa-lock input-icon"></i>
                            <input type="password" id="signupPassword" placeholder="create a new password ">
                        </div>
                        <div class="form-group password-input">
                            <i class="fas fa-lock input-icon"></i>
                            <input type="password" id="signupConfirmPassword" placeholder="confirm password">
                        </div>
                        <button class="btn" onclick="signup()" data-i18n="create_account_btn">Create New Account</button>
                    </div>
                </div>
                <div class="auth-footer">
                    <p id="authToggleText" onclick="toggleAuthForm()" data-i18n="create_account_text">Create New Account</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Home Page -->
    <div id="homePage" class="home-container">
        <div class="header">
            <div class="logo"><b>ChitChat app </b></div>
            <div class="user-info">
                <span id="headerUserName">ব্যবহারকারী</span>
                <img id="headerUserAvatar" src="" alt="User" class="user-avatar">
                <button class="menu-btn" onclick="toggleMenu()">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            <div class="dropdown-menu" id="dropdownMenu">
                <!-- Changed to Admin Info for User App -->
                <div class="dropdown-item" onclick="showAdminPanel()">
                    <i class="fas fa-info-circle"></i>
                    <span data-i18n="admin_info_header">Admin Information</span>
                </div>
                <div class="dropdown-item" onclick="showLanguageModal()">
                    <i class="fas fa-language"></i>
                    <span data-i18n="language">Language</span>
                </div>
                <div class="dropdown-item" onclick="showSettingsModal()">
                    <i class="fas fa-cog"></i>
                    <span data-i18n="settings">Settings</span>
                </div>
                <div class="dropdown-item" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    <span data-i18n="logout">Logout</span>
                </div>
            </div>
        </div>
        <div class="content">
            <div class="search-container">
                <div class="search-box">
                    <input type="text" id="userSearch" placeholder="Search users by name..." onkeyup="searchUsers()">
                    <i class="fas fa-search"></i>
                </div>
            </div>
            <div class="tabs-container">
                <div class="tab active" onclick="switchTab('all')" data-i18n="all">All</div>
                <div class="tab" onclick="switchTab('favorite')" data-i18n="favorite">Favorite</div>
                <div class="tab" onclick="switchTab('group')" data-i18n="group">Group</div>
            </div>
            <div class="tab-content active" id="allTab">
                <div class="stories-container" id="storiesContainer"></div>
                <div class="user-list" id="userList"></div>
            </div>
            <div class="tab-content" id="favoriteTab">
                <div class="user-list" id="favoriteList">
                    <div class="empty-state"><p>No favorite users yet</p></div>
                </div>
            </div>
            <div class="tab-content" id="groupTab">
                <!-- Group Creation Button -->
                <button class="btn" style="margin-bottom: 15px;" onclick="showCreateGroupModal()">
                    <i class="fas fa-plus"></i> <span data-i18n="create_group">Create New Group</span>
                </button>
                <div class="user-list" id="groupList">
                    <div class="empty-state"><p>No groups joined</p></div>
                </div>
            </div>
        </div>
        <!-- ADMOD / ADSENSE BANNER START -->
<div id="adBanner" class="ad-banner-container">
    
    <!-- Adestra Ad Code Start -->
    <script type="text/javascript">
        atOptions = {
            'key' : '9a147a24a9483c2175a0aec9f393a90f',
            'format' : 'iframe',
            'height' : 50,
            'width' : 320,
            'params' : {}
        };
    </script>
    <script type="text/javascript" src="https://www.highperformanceformat.com/9a147a24a9483c2175a0aec9f393a90f/invoke.js"></script>
    <!-- Adestra Ad Code End -->

</div>
<!-- ADMOD / ADSENSE BANNER END -->
        <div class="footer">
            <div class="footer-btn active" onclick="switchFooterTab('chat')">
                <i class="fas fa-comment"></i>
                <span data-i18n="chat">Chat</span>
            </div>
            <div class="footer-btn" onclick="switchFooterTab('reels')">
    <i class="fas fa-play-circle"></i>
    <span>Reels</span>
</div>
            <div class="footer-btn" onclick="switchFooterTab('connect')">
                <i class="fas fa-user-plus"></i>
                <span data-i18n="connect">Connect</span>
            </div>
            <div class="footer-btn" onclick="switchFooterTab('calls')">
                <i class="fas fa-phone"></i>
                <span data-i18n="calls">Calls</span>
            </div>
        </div>
    </div>

    <!-- Connect Page -->
    <div id="connectPage" class="home-container">
        <div class="header">
            <div class="logo"> <b>New Connect</b> </div>
            <div class="user-info">
                <span id="headerUserNameConnect">ব্যবহারকারী</span>
                <img id="headerUserAvatarConnect" src="" alt="User" class="user-avatar">
                <button class="menu-btn" onclick="toggleMenu()">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
        </div>
        <div class="content">
            <div class="connect-container">
                <h2 data-i18n="connect_friends">Connect with Friends</h2>
                <div class="qr-container">
                    <div class="qr-code" id="qrCode"></div>
                    <div class="uid-display" id="uidDisplay">Your UID: OL123456</div>
                    <button class="btn" onclick="shareUID()" data-i18n="share_uid">Share UID</button>
                    <button class="btn" style="margin-top: 10px; background: #333;" onclick="openQRScanner()">
                        <i class="fas fa-camera"></i> <span data-i18n="scan_qr">Scan QR Code</span>
                    </button>
                </div>
                <h3 data-i18n="connect_uid">Connect with UID</h3>
                <input type="text" class="connect-input" id="connectInput" placeholder="Enter UID to connect">
                <button class="btn" onclick="connectWithUID()" data-i18n="connect_btn">Connect</button>
            </div>
        </div>
        <div class="footer">
            <div class="footer-btn" onclick="switchFooterTab('chat')">
                <i class="fas fa-comment"></i>
                <span data-i18n="chat">Chat</span>
            </div>
            <div class="footer-btn" onclick="switchFooterTab('reels')">
                <i class="fas fa-play-circle"></i>
                <span data-i18n="reels">Reels</span>
            </div>
            <div class="footer-btn active" onclick="switchFooterTab('connect')">
                <i class="fas fa-user-plus"></i>
                <span data-i18n="connect">Connect</span>
            </div>
            <div class="footer-btn" onclick="switchFooterTab('calls')">
                <i class="fas fa-phone"></i>
                <span data-i18n="calls">Calls</span>
            </div>
        </div>
    </div>

    <!-- Calls Page -->
    <div id="callsPage" class="home-container">
        <div class="header">
            <div class="logo"><b>Calls History</b></div>
            <div class="user-info">
                <span id="headerUserNameCalls"></span>
                <img id="headerUserAvatarCalls" src="" alt="User" class="user-avatar">
                <button class="menu-btn" onclick="toggleMenu()">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
        </div>
        <div class="content">
            <div class="call-list" id="callList">
                <div class="empty-state"><p>No call history</p></div>
            </div>
        </div>
        <div class="footer">
            <div class="footer-btn" onclick="switchFooterTab('chat')">
                <i class="fas fa-comment"></i>
                <span data-i18n="chat">Chat</span>
            </div>
            <div class="footer-btn" onclick="switchFooterTab('reels')">
                <i class="fas fa-play-circle"></i>
                <span data-i18n="reels">Reels</span>
            </div>
            <div class="footer-btn" onclick="switchFooterTab('connect')">
                <i class="fas fa-user-plus"></i>
                <span data-i18n="connect">Connect</span>
            </div>
            <div class="footer-btn active" onclick="switchFooterTab('calls')">
                <i class="fas fa-phone"></i>
                <span data-i18n="calls">Calls</span>
            </div>
        </div>
    </div>

    <!-- REELS PAGE (FINAL UPDATED) -->
<div id="reelsPage" class="home-container" style="display: none;">
	<!-- GLOBAL UPLOAD PROGRESS (CORNER) -->
    <div id="globalUploadProgress" class="tt-upload-badge">
        <div class="tt-upload-spinner"></div>
        <span id="globalUploadText">Uploading 0%</span>
    </div>

    <!-- 1. HOME FEED -->
    <div id="ttHomeSection" style="width: 100%; height: 100%;">
        <div class="tt-home-header">
            <!-- Back Button: Exit Reels -->
            <i class="fas fa-arrow-left tt-header-icon" style="color:white" onclick="exitReels()"></i>
            
            <div class="tt-tab-container">
                <div class="tt-tab" id="tabFriends" onclick="switchReelsFeed('friends')">Friends</div>
                <div class="tt-tab active" id="tabForYou" onclick="switchReelsFeed('foryou')">For You</div>
            </div>
            
            <i class="fas fa-search tt-header-icon" style="color:white" onclick="openTikTokSearch()"></i>
        </div>
        <div id="reelsContainer" class="tt-feed-container"></div>
    </div>

    <!-- 2. INBOX PAGE (Only Reels Friends) -->
    <div id="ttInboxPage">
        <div class="tt-common-header">
            <!-- Back Button: Go Home -->
            <i class="fas fa-arrow-left tt-header-icon" onclick="switchTikTokNav('home')"></i>
            <span>Inbox</span>
            <div style="width:20px"></div>
        </div>
        
        <div class="tt-activity-cards">
    <div class="tt-act-card" onclick="openMyFollowersList()">
        <div class="tt-act-icon" style="background:#69c9d0;"><i class="fas fa-user-friends"></i></div>
        <div style="font-size:12px; font-weight:bold;">New Followers</div>
    </div>
    
    <!-- Activity Button Fixed -->
    <div class="tt-act-card" onclick="openActivityPage()">
        <div class="tt-act-icon" style="background:#ea4359;"><i class="fas fa-heart"></i></div>
        <div style="font-size:12px; font-weight:bold;">Activity</div>
    </div>
</div>
        
        <div style="padding:10px 15px; font-weight:bold; font-size:13px; color:#555; background:#fff;">Messages (Friends)</div>
        <div class="tt-inbox-list" id="ttInboxChatList"></div>
    </div>

    <!-- 3. PROFILE PAGE -->
    <div id="ttProfilePage">
    <div class="tt-common-header">
        <i class="fas fa-arrow-left tt-header-icon" id="profileBackBtn" style="display:none;" onclick="switchTikTokNav('home')"></i>
        <span id="ttProfileTopName">Profile</span>
        <i class="fas fa-bars tt-header-icon" onclick="exitReels()"></i>
    </div>
        
        <div class="tt-profile-top">
         <img id="ttProfilePic" src="" class="tt-p-pic">
         <div class="tt-p-name" id="ttProfileName">Name</div>
         <div class="tt-p-username" id="ttProfileUsername">@username</div>
         
         <!-- Stats -->
         <div class="tt-stats">
             <div class="tt-stat-item" onclick="showFollowList('following')">
                 <span class="tt-stat-val" id="ttStatsFollowing">0</span>
                 <span class="tt-stat-lbl">Following</span>
             </div>
             <div class="tt-stat-item" onclick="showFollowList('followers')">
                 <span class="tt-stat-val" id="ttStatsFollowers">0</span>
                 <span class="tt-stat-lbl">Followers</span>
             </div>
             <div class="tt-stat-item">
                 <span class="tt-stat-val" id="ttStatsLikes">0</span>
                 <span class="tt-stat-lbl">Likes</span>
             </div>
         </div>

             <!-- Action Buttons (Edit Profile) -->
         <div class="tt-profile-actions" id="ttProfileActions">
             <!-- ডিফল্টভাবে বাটনটি এখানে থাকবে, যাতে হারিয়ে না যায় -->
             <button class="tt-btn-edit" onclick="openEditReelsProfile()">Edit profile</button>
         </div>

             <div class="tt-p-bio" id="ttProfileBio">No bio yet.</div>

             <div class="tt-profile-tabs">
             <div class="tt-ptab active" onclick="switchProfileTab('grid')"><i class="fas fa-th"></i></div>
             <div class="tt-ptab" onclick="switchProfileTab('saved')"><i class="fas fa-bookmark"></i></div>
             <div class="tt-ptab" onclick="switchProfileTab('liked')"><i class="fas fa-heart"></i></div>
         </div>
    </div>
        
        <div class="tt-grid" id="ttProfileGrid"></div>

        <!-- FLOATING UPLOAD BUTTON (Fixed Position) -->
    <div id="ttFloatingUpload" class="tt-floating-upload" onclick="openReelsUploadModal()">
        <i class="fas fa-plus"></i>
    </div>
</div>

    <!-- 4. BOTTOM NAV -->
    <div class="tt-bottom-nav">
        <div class="tt-nav-item active" id="ttNavHome" onclick="switchTikTokNav('home')"><i class="fas fa-home tt-nav-icon"></i><span>Home</span></div>
        <div class="tt-nav-item" id="ttNavInbox" onclick="switchTikTokNav('inbox')"><i class="fas fa-comment-dots tt-nav-icon"></i><span>Inbox</span></div>
        <div class="tt-nav-item" id="ttNavProfile" onclick="switchTikTokNav('profile')"><i class="fas fa-user tt-nav-icon"></i><span>Profile</span></div>
    </div>

</div>

<!-- FULL SCREEN UPLOAD MODAL (Draggable Text, Size Slider, Audio Fix) -->
<div id="reelsUploadModal" class="tt-modal" style="background:black;">
    <div class="upload-screen">
        <!-- Close Button -->
        <i class="fas fa-times upload-close" onclick="closeUploadModal()" style="z-index: 100; top: 15px; left: 15px; font-size: 25px; padding: 10px;"></i>
        
        <!-- Preview Container -->
        <div class="upload-preview-container" id="previewContainer" style="overflow: hidden; position: relative;">
            <p id="uploadPlaceholder" style="color:#888; display:block; margin-top: 50%;">No Media Selected</p>
            
            <!-- Media -->
            <img id="previewImage" class="upload-preview-media" style="display:none; width:100%; height:100%; object-fit:contain;">
            
            <!-- Video (Removed 'muted' to play sound) -->
            <video id="previewVideo" class="upload-preview-media" loop playsinline style="display:none; width:100%; height:100%; object-fit:contain;"></video>
            
            <!-- Hidden Audio Player for Image+Music -->
            <audio id="previewAudioHidden" loop></audio>
            
            <!-- DRAGGABLE TEXT INPUT -->
            <!-- touch-action: none prevents screen scrolling when dragging text -->
            <textarea id="overlayTextInput" 
                placeholder="Type here..." 
                style="display:none; position:absolute; top:40%; left:10%; transform:translate(0, 0); 
                       background:transparent; border:1px dashed rgba(255,255,255,0.3); color:white; font-size:24px; font-weight:bold; 
                       text-align:center; width:80%; outline:none; text-shadow: 2px 2px 4px black; resize:none; overflow:hidden; z-index: 50; touch-action: none;"
                oninput="autoResizeText(this)">
            </textarea>
        </div>

        <!-- RIGHT SIDEBAR TOOLS -->
        <div class="upload-tools-sidebar" style="position: absolute; right: 15px; top: 60px; display: flex; flex-direction: column; gap: 20px; z-index: 100; align-items: center;">
             
             <!-- 1. GALLERY -->
             <div onclick="document.getElementById('reelMediaInput').click()" style="color:white; text-align:center; cursor:pointer;">
                <i class="fas fa-images" style="font-size:24px; filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.5));"></i>
                <div style="font-size:11px; font-weight:600; text-shadow:1px 1px 2px black;">Media</div>
             </div>

             <!-- 2. TEXT -->
             <div onclick="toggleTextEditor()" style="color:white; text-align:center; cursor:pointer;">
                <i class="fas fa-font" style="font-size:24px; filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.5));"></i>
                <div style="font-size:11px; font-weight:600; text-shadow:1px 1px 2px black;">Text</div>
             </div>
             
             <!-- 3. FONT SIZE (New Slider) -->
             <div id="textSizeControl" style="display:none; text-align:center;">
                <input type="range" min="12" max="60" value="24" oninput="changeFontSize(this.value)" style="width: 80px; transform: rotate(-90deg); margin: 20px 0;">
                <div style="font-size:11px; font-weight:600; text-shadow:1px 1px 2px black; margin-top:-10px;">Size</div>
             </div>

             <!-- 4. COLOR PICKER -->
             <div id="btnTextColor" style="display:none; text-align:center; position: relative; width: 40px; height: 40px;">
                <input type="color" id="textColorPicker" value="#ffffff" oninput="applyTextColor(this)" style="position: absolute; top:0; left:0; width:100%; height:100%; opacity:0; z-index:10;">
                <div style="width: 24px; height: 24px; border-radius: 50%; background: linear-gradient(45deg, #ff0050, #00f2ea, #ffff00); border: 2px solid white; margin: 0 auto;"></div>
                <div style="font-size:11px; margin-top:3px; font-weight:600; text-shadow:1px 1px 2px black;">Color</div>
             </div>
             
             <!-- 5. AUDIO -->
             <div id="btnUploadAudio" onclick="document.getElementById('reelAudioInput').click()" style="color:white; text-align:center; display:none; cursor:pointer;">
                <i class="fas fa-music" style="font-size:24px; filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.5));"></i>
                <div style="font-size:11px; font-weight:600; text-shadow:1px 1px 2px black;">Audio</div>
             </div>
        </div>

        <!-- Hidden Inputs -->
        <input type="file" id="reelMediaInput" accept="image/*,video/*" hidden onchange="handleMediaSelect(this)">
        <input type="file" id="reelAudioInput" accept="audio/*" hidden onchange="handleAudioSelect(this)">

        <!-- Caption & Post -->
        <div style="position: absolute; bottom: 0; left: 0; width: 100%; background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); padding: 20px;">
            <input type="text" id="reelCaption" class="upload-caption-input" placeholder="Describe your reel... #hashtags" style="margin-bottom:10px;">
            <button class="upload-post-btn" onclick="startFastUpload()">Post Reel</button>
        </div>
    </div>
</div>

<!-- EDIT PROFILE MODAL -->
<div id="editReelsProfileModal" class="tt-modal">
    <div class="tt-common-header">
        <i class="fas fa-times tt-header-icon" onclick="document.getElementById('editReelsProfileModal').classList.remove('active')"></i>
        <span>Edit Profile</span>
        <span style="color:blue; font-size:14px; cursor:pointer;" onclick="saveReelsProfile()">Save</span>
    </div>
    <div class="modal-body" style="padding:20px;">
        <div style="text-align:center; margin-bottom:20px;">
             <img id="editReelsPic" src="" style="width:80px; height:80px; border-radius:50%; object-fit:cover;">
             <div style="font-size:12px; color:blue; margin-top:5px;" onclick="document.getElementById('editReelsPicInput').click()">Change Photo</div>
             <input type="file" id="editReelsPicInput" hidden accept="image/*" onchange="handleImageUpload(this, 'editReelsPic')">
        </div>
        <div class="form-group"><label>Name</label><input type="text" id="editReelsName"></div>
        <div class="form-group">
            <label>Bio (Max 100 chars)</label>
            <textarea id="editReelsBio" class="chat-input" style="width:100%; height:80px;" maxlength="100"></textarea>
        </div>
    </div>
</div>

<!-- LIST MODAL (Followers/Following) -->
<div id="ttListModal" class="tt-modal">
    <div class="tt-common-header">
        <i class="fas fa-arrow-left tt-header-icon" onclick="document.getElementById('ttListModal').classList.remove('active')"></i>
        <span id="ttListTitle">List</span>
        <div></div>
    </div>
    <div id="ttListContent" class="user-list" style="padding:10px; overflow-y:auto;"></div>
</div>

<!-- SEARCH MODAL -->
<div id="ttSearchPage" class="tt-search-modal">
    <div class="tt-common-header">
        <!-- এখানে onclick ফাংশনটি পরিবর্তন করা হয়েছে -->
        <i class="fas fa-arrow-left tt-header-icon" onclick="closeReelsSearch()"></i>
        
        <input type="text" id="ttSearchInput" placeholder="Search name or @username..." style="border:none; outline:none; font-size:16px; width:70%;" onkeyup="searchReelsData()">
        <i class="fas fa-search tt-header-icon"></i>
    </div>
    <div id="ttSearchResults" class="user-list" style="padding:10px;"></div>
</div>

<!-- ACTIVITY / NOTIFICATION MODAL -->
<div id="ttActivityModal" class="tt-modal">
    <div class="tt-common-header">
        <i class="fas fa-arrow-left tt-header-icon" onclick="document.getElementById('ttActivityModal').classList.remove('active')"></i>
        <span>All Activity</span>
        <div></div>
    </div>
    <div id="ttActivityList" class="user-list" style="padding:0; overflow-y:auto; background:#fff;">
        <p style="text-align:center; padding:20px; color:#888;">Loading notifications...</p>
    </div>
</div>

    <!-- Chat Interface -->
    <div id="chatRoom" class="chat-room">
        <!-- SELECTION HEADER -->
        <div id="selectionHeader" class="selection-header">
            <div onclick="exitSelectionMode()" style="cursor: pointer;"><i class="fas fa-arrow-left"></i></div>
            <div class="selection-count" id="selectionCount">0</div>
            <div class="selection-actions">
                <i class="fas fa-ellipsis-v" onclick="openDeleteModal()"></i>
            </div>
        </div>

        <div class="chat-header">
            <button class="chat-back-btn" onclick="closeChat()"><i class="fas fa-arrow-left"></i></button>
            <img id="chatRoomAvatar" src="" alt="User" class="chat-user-avatar">
            <div class="chat-user-info">
                <div class="chat-user-name" id="chatRoomName">User Name</div>
                <div class="chat-user-status" id="chatRoomStatus">Online</div>
            </div>
            <div class="chat-actions">
                <i class="fas fa-phone" onclick="startCall('audio')" style="margin-right: 15px; color: var(--primary-color); cursor: pointer;"></i>
                <i class="fas fa-video" onclick="startCall('video')" style="margin-right: 15px; color: var(--primary-color); cursor: pointer;"></i>
                <i class="fas fa-headphones" id="ttsToggleBtn" onclick="toggleTTSMode()" style="margin-right: 15px; color: var(--primary-color); cursor: pointer;" title="Read Message"></i>
                
                <!-- Chat Options Menu -->
                <div class="chat-options" style="display: inline-block;">
                    <i class="fas fa-ellipsis-v" onclick="toggleChatOptions(event)" style="color: var(--primary-color); cursor: pointer; padding: 0 10px;"></i>
                    <div id="chatOptionsMenu" class="chat-dropdown">
                         <!-- Block/Unblock option -->
                         <div class="dropdown-item" id="blockOption" onclick="toggleBlockUser()">
                            <i class="fas fa-user-slash"></i>
                            <span id="blockToggleText" data-i18n="block_user">Block User</span>
                         </div>
                         
                         <!-- ADDED: Unfriend option -->
                         <div class="dropdown-item" id="unfriendOption" onclick="unfriendUser()">
                            <i class="fas fa-user-times"></i>
                            <span data-i18n="unfriend_user">Unfriend User</span>
                         </div>
                         
                         <!-- NEW: Set Theme option -->
                         <div class="dropdown-item" onclick="showChatThemeModal()">
                            <i class="fas fa-palette"></i>
                            <span data-i18n="set_theme">Set Theme</span>
                         </div>
                         
                         <!-- NEW: Set Nickname option -->
                         <div class="dropdown-item" id="nicknameOption" onclick="openNicknameModal()">
                            <i class="fas fa-pen"></i>
                            <span>Nickname</span>
                         </div>

                         <!-- Leave Group option (for groups) / Add Member (for groups) -->
                         <div id="groupOptionsContainer" style="display:none;">
                             <div class="dropdown-item" onclick="showAddMemberModal()">
                                <i class="fas fa-user-plus"></i>
                                <span data-i18n="add_member">Add Member</span>
                            </div>
                            <div class="dropdown-item" onclick="leaveGroup()">
                                <i class="fas fa-sign-out-alt"></i>
                                <span data-i18n="leave_group">Leave Group</span>
                            </div>
                         </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="chat-messages" id="chatMessages">
            <!-- Messages will appear here -->
        </div>
        <div class="chat-input-area" id="chatInputArea">
            
            <!-- NEW: Reply Preview Section -->
            <div id="replyPreview" style="display: none; width: 100%; padding: 8px 15px; border-bottom: 1px solid #ddd; background: var(--secondary-color); border-radius: 10px 10px 0 0; margin-bottom: -10px; position: relative;">
                <i class="fas fa-reply" style="color: var(--primary-color); margin-right: 5px;"></i>
                <span id="replySenderName" style="font-weight: bold; color: var(--primary-color); font-size: 14px;"></span>
                <p id="replyMessageText" style="font-size: 14px; color: var(--light-text); margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-left: 20px;"></p>
                <i class="fas fa-times" onclick="cancelReply()" style="position: absolute; top: 10px; right: 10px; cursor: pointer; color: var(--danger-color);"></i>
            </div>
            
            <!-- Voice Recording UI Overlay -->
            <div id="recordingUI" class="recording-ui">
                <div class="recording-indicator">
                    <div class="recording-dot"></div>
                    <span>Recording...</span>
                </div>
                <div>
                    <i class="fas fa-stop-circle" onclick="stopVoiceRecording()" style="cursor: pointer; font-size: 24px; color: var(--danger-color); margin-right: 15px;"></i>
                    <i class="fas fa-trash-alt record-cancel" onclick="cancelVoiceRecording()"></i>
                </div>
            </div>
            
             <!-- Blocked Message Area -->
            <div id="blockedMessage" style="flex:1;text-align:center;color:var(--danger-color);font-weight:500;display:none;cursor:pointer;">
                <span id="blockedStatusText">You have blocked this user.</span>
            </div>
            
            <!-- Standard Inputs -->
            <input type="file" id="chatFileUpload" hidden multiple onchange="handleChatFileUpload(this)">
            
            <div class="input-row" id="chatInputRow">
                <input type="text" id="messageInput" class="chat-input" placeholder="Type a message...">
                <!-- Block Message Display removed -->
                <button class="chat-action-btn" id="fileBtn" onclick="triggerChatFileUpload()" style="margin-right: 5px; background: #f0f2f5; color: #555;">
                    <i class="fas fa-paperclip"></i>
                </button>
                
                <button class="chat-action-btn" id="micBtn" onclick="startVoiceRecording()" style="margin-right: 5px; background: #e0e0e0; color: #555;">
                    <i class="fas fa-microphone"></i>
                </button>
                <button class="chat-action-btn" id="sendBtn" onclick="sendMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- DELETE/ACTION OPTIONS MODAL (Modified for Edit/Reply/Copy/Download) -->
    <div id="deleteModal" class="delete-modal" onclick="closeDeleteModal()">
        <div class="delete-options" onclick="event.stopPropagation()">
            <!-- NEW OPTIONS -->
            <!-- Changed onclick to new function -->
            <button class="delete-option-btn" id="btnReply" onclick="prepareReplyForSelection()" data-i18n="reply" style="display:none;"><i class="fas fa-reply"></i> Reply</button> 
            <button class="delete-option-btn" id="btnEdit" onclick="openEditModal()" data-i18n="edit_message" style="display:none;"><i class="fas fa-pen"></i> Edit</button>
            <button class="delete-option-btn" id="btnCopy" onclick="copySelectedText()" style="display:none;"><i class="fas fa-copy"></i> Copy</button>
            <button class="delete-option-btn" id="btnDownload" onclick="downloadSelectedContent()" style="display:none;"><i class="fas fa-download"></i> Download</button>

            <!-- EXISTING OPTIONS -->
            <button class="delete-option-btn" id="btnDeleteEveryone" onclick="confirmDelete('everyone')"><i class="fas fa-trash"></i> Delete for Everyone</button>
            <button class="delete-option-btn" onclick="confirmDelete('me')"><i class="fas fa-trash"></i> Delete for Me</button>
            <button class="delete-option-btn" onclick="closeDeleteModal()" style="color: #666;"><i class="fas fa-times"></i> Cancel</button>
        </div>
    </div>
    
    <!-- NEW: Edit Message Modal -->
    <div id="editMessageModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" data-i18n="edit_message">Edit Message</h2>
                <button class="modal-close" onclick="closeModal('editMessageModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label data-i18n="new_message_text">New Message Text</label>
                    <textarea id="editMessageInput"></textarea>
                </div>
                <button class="btn btn-block" onclick="saveEdit()" data-i18n="save_changes">Save Changes</button>
            </div>
        </div>
    </div>
    
    <!-- NEW: Nickname Modal -->
    <div id="nicknameModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Set Nickname</h2>
                <button class="modal-close" onclick="closeModal('nicknameModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Nickname</label>
                    <input type="text" id="nicknameInput" placeholder="Enter nickname">
                </div>
                <button class="btn btn-block" onclick="saveNickname()">Save</button>
                <button class="btn btn-block btn-danger" style="margin-top:10px" onclick="removeNickname()">Remove Nickname</button>
            </div>
        </div>
    </div>

    <!-- Create Group Modal -->
    <div id="createGroupModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Create New Group</h2>
                <button class="modal-close" onclick="closeModal('createGroupModal')">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Group Icon Upload -->
                <div class="file-upload-wrapper">
                    <input type="file" id="groupIconInput" class="file-upload-input" accept="image/*" onchange="handleImageUpload(this, 'groupIconPreview')">
                    <label for="groupIconInput" class="file-upload-label">
                        <i class="fas fa-camera"></i> Group Icon
                    </label>
                    <img id="groupIconPreview" class="image-preview" src="" alt="Preview">
                </div>

                <div class="form-group">
                    <label>Group Name</label>
                    <input type="text" id="groupNameInput" placeholder="Enter group name">
                </div>

                <div class="form-group">
                    <label>Select Members</label>
                    <div class="friend-select-list" id="friendSelectList">
                        <!-- Friend checkboxes will be injected here -->
                    </div>
                </div>

                <button class="btn btn-block" onclick="createGroup()">Create Group</button>
            </div>
        </div>
    </div>
    
    <!-- NEW: Add Member Modal -->
    <div id="addMemberModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add Members</h2>
                <button class="modal-close" onclick="closeModal('addMemberModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="friend-select-list" id="addMemberSelectList">
                    <!-- Non-group friend checkboxes will be injected here -->
                </div>
                <button class="btn btn-block" onclick="addNewMembersToGroup()">Add Selected</button>
            </div>
        </div>
    </div>

    <!-- Admin Info Modal -->
    <div id="adminModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title"><b>Admin</b></h2>
                <button class="modal-close" onclick="closeModal('adminModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="admin-container">
                    <div class="admin-section" style="margin-bottom: 20px;">
                        <div class="admin-section-header" data-i18n="admin_info_header">Admin Information</div>
                        <div class="admin-section-content">
                             <img id="adminProfilePic" src="https://ui-avatars.com/api/?name=Admin&background=random" alt="Admin Profile" class="admin-profile-pic">
                            <ul id="adminInfoList" style="list-style: none; padding: 0;">
                                <li id="adminInfoOwner" style="margin-bottom: 8px; font-weight: 500;"><b>App owners</b>: Loading...</li>
                                <li id="adminInfoAddress" style="margin-bottom: 8px; font-weight: 500;"><b>Address</b>: Loading...</li>
                                <li id="adminInfoOccupation" style="margin-bottom: 8px; font-weight: 500;"><b>Occupation</b>: Loading...</li>
                                <li id="adminInfoFacebook" style="margin-bottom: 8px; font-weight: 500; display:none;"><b>Facebook</b>: <a href="#" target="_blank" style="display:inline-flex;align-items:center;gap:6px;background:#1877F2;color:#fff;padding:6px 12px;text-decoration:none;border-radius:5px;font-size:14px;">Go <i class="fa-solid fa-arrow-right"></i></a></li>
                                <li id="adminInfoTikTok" style="margin-bottom: 8px; font-weight: 500; display:none;"><b>TikTok</b>: <a href="#" target="_blank" style="display:inline-flex;align-items:center;gap:6px;background:#1877F2;color:#fff;padding:6px 12px;text-decoration:none;border-radius:5px;font-size:14px;">Go <i class="fa-solid fa-arrow-right"></i></a></li>
                                <button class="btn btn-block" style="margin-top: 20px;" onclick="openChatWithAdmin()" data-i18n="chat_with_admin">Chat with Admin</button>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" data-i18n="settings">Settings</h2>
                <button class="modal-close" onclick="closeModal('settingsModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="settings-container">
                    <div class="settings-section">
                        <div class="settings-section-header" data-i18n="account_settings">Account Settings</div>
                        <div class="settings-section-content">
                            <div class="settings-item">
                                <div class="settings-label" data-i18n="account_number">Account Number</div>
                                <div class="settings-value" id="settingsAccountNumber"></div>
                            </div>
                            <div class="settings-item">
                                <div class="settings-label" data-i18n="uid">UID</div>
                                <div class="settings-value" id="settingsUID"></div>
                            </div>
                            <!-- Blocked Users option added here -->
                            <div class="settings-item" onclick="showBlockListModal()" style="cursor: pointer;">
                                <div class="settings-label" data-i18n="blocked_users">Blocked Users</div>
                                <div class="settings-value"><i class="fas fa-user-slash"></i></div>
                            </div>
                            <!-- NEW: Private Contacts option added here -->
                            <div class="settings-item" onclick="openPrivateAccessModal()" style="cursor: pointer;">
                                <div class="settings-label" data-i18n="private_contacts">Private Contacts</div>
                                <div class="settings-value"><i class="fas fa-eye-slash"></i></div>
                            </div>
                            <button class="btn btn-block" onclick="showEditProfileModal()" data-i18n="edit_profile">Edit Profile</button>
                        </div>
                    </div>
                    
                    <!-- NEW Security Section -->
                    <div class="settings-section">
                        <div class="settings-section-header" data-i18n="security">Security</div>
                        <div class="settings-section-content">
                            <div class="settings-item" onclick="openChangePasswordModal()" style="cursor: pointer;">
                                <div class="settings-label" data-i18n="change_password">Change Password</div>
                                <div class="settings-value"><i class="fas fa-key"></i></div>
                            </div>
                            <div class="settings-item" onclick="openChangePhoneModal()" style="cursor: pointer;">
                                <div class="settings-label" data-i18n="change_id">Change ID/Phone</div>
                                <div class="settings-value"><i class="fas fa-phone"></i></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Block List Modal -->
    <div id="blockListModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" data-i18n="blocked_users">Blocked Users</h2>
                <button class="modal-close" onclick="closeModal('blockListModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="user-list" id="blockedUsersList">
                    <!-- Blocked users will be injected here -->
                    <div class="empty-state" id="emptyBlockedList" style="display:none;"><p>No users are blocked</p></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- NEW: Private Contacts Modal -->
    <div id="privateContactsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" data-i18n="private_contacts">Private Contacts</h2>
                <button class="modal-close" onclick="closeModal('privateContactsModal')">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 15px; text-align: center;">Add friends to keep their chats private.</p>
                <button class="btn btn-block" onclick="showAddPrivateContactModal()">
                    <i class="fas fa-plus"></i> <span data-i18n="add_private_contact">Add Private Contact</span>
                </button>
                
                <h3 style="margin-top: 20px; border-bottom: 1px solid #eee; padding-bottom: 5px;">Current Private Contacts:</h3>
                <div class="user-list" id="privateContactsList" style="max-height: 250px; overflow-y: auto; padding-top: 10px;">
                    <!-- Private contacts will be injected here -->
                    <div class="empty-state" id="emptyPrivateList" style="display:none;"><p>No private contacts yet</p></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- NEW: Add Private Contact Modal (Select Friends) -->
    <div id="addPrivateContactModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" data-i18n="add_private_contact">Select Contacts to Private</h2>
                <button class="modal-close" onclick="closeModal('addPrivateContactModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="friend-select-list" id="nonPrivateFriendsList">
                    <!-- Non-private friends will be injected here -->
                    <div class="empty-state"><p>No friends available to add</p></div>
                </div>
                <button class="btn btn-block" onclick="addSelectedPrivateContacts()" data-i18n="add_private_contact">Add Selected Contacts</button>
            </div>
        </div>
    </div>

    <!-- NEW: Private Access Modal (Password Gate) -->
    <div id="privateAccessModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" data-i18n="private_contacts">Private Access</h2>
                <button class="modal-close" onclick="closeModal('privateAccessModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="privateAccessSetPassword" style="display: none;">
                     <p style="text-align: center; margin-bottom: 15px;">Set a password for your private contacts.</p>
                     <div class="form-group">
                        <label data-i18n="new_password">New Password</label>
                        <input type="password" id="setPrivatePassword" placeholder="Enter new private password">
                     </div>
                     <div class="form-group">
                        <label data-i18n="confirm_password">Confirm Password</label>
                        <input type="password" id="confirmPrivatePassword" placeholder="Confirm new private password">
                     </div>
                     <button class="btn" onclick="savePrivatePassword()" data-i18n="save_password">Set Password</button>
                </div>
                
                <div id="privateAccessEnterPassword" style="display: none;">
                    <p style="text-align: center; margin-bottom: 15px;">Enter your private access password.</p>
                    <div class="form-group">
                       <label data-i18n="password">Password</label>
                       <input type="password" id="enterPrivatePassword" placeholder="Enter private password">
                    </div>
                    <button class="btn" onclick="verifyPrivatePassword()" data-i18n="access_private">Access Private Contacts</button>
                    <p style="text-align: center; margin-top: 15px; cursor: pointer; color: var(--light-text);" onclick="showChangePrivatePasswordModal()">Change Password</p>
                </div>
                
            </div>
        </div>
    </div>
    
    <!-- NEW: Change Private Password Modal -->
    <div id="changePrivatePasswordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" data-i18n="change_password">Change Private Password</h2>
                <button class="modal-close" onclick="closeModal('changePrivatePasswordModal')">&times;</button>
            </div>
            <div class="modal-body">
                 <div class="form-group">
                    <label data-i18n="old_password">Old Password</label>
                    <input type="password" id="oldPrivatePassword" placeholder="Enter current private password">
                 </div>
                 <div class="form-group">
                    <label data-i18n="new_password">New Password</label>
                    <input type="password" id="newPrivatePassword" placeholder="Enter new private password">
                 </div>
                 <div class="form-group">
                    <label data-i18n="confirm_password">Confirm Password</label>
                    <input type="password" id="confirmNewPrivatePassword" placeholder="Confirm new private password">
                 </div>
                 <button class="btn" onclick="updatePrivatePassword()" data-i18n="update_password">Update Password</button>
            </div>
        </div>
    </div>

    <!-- NEW Change Password Modal -->
    <div id="changePasswordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" data-i18n="change_password">Change Password</h2>
                <button class="modal-close" onclick="closeModal('changePasswordModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label data-i18n="old_password">Old Password</label>
                    <input type="password" id="oldPassword" placeholder="Enter current password">
                </div>
                <div class="form-group">
                    <label data-i18n="new_password">New Password</label>
                    <input type="password" id="newPassword" placeholder="Enter new password">
                </div>
                <div class="form-group">
                    <label data-i18n="confirm_password">Confirm Password</label>
                    <input type="password" id="confirmNewPassword" placeholder="Confirm new password">
                </div>
                <button class="btn" onclick="updatePassword()" data-i18n="update_password">Update Password</button>
            </div>
        </div>
    </div>
    
    <!-- NEW Change Phone/ID Modal -->
    <div id="changePhoneModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" data-i18n="change_id">Change ID</h2>
                <button class="modal-close" onclick="closeModal('changePhoneModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Current ID: <span id="currentIdDisplay"></span></label>
                </div>
                <div class="form-group phone-input">
                     <button class="country-selector">
                        <img src="https://flagcdn.com/w20/bd.png" alt="BD" class="country-flag">
                        <span>+880</span>
                    </button>
                    <input type="tel" id="newPhoneNumber" placeholder="Enter new phone number">
                </div>
                <div class="form-group">
                    <label data-i18n="password_confirm">Confirm Password</label>
                    <input type="password" id="phoneChangePassword" placeholder="Enter password to confirm">
                </div>
                <button class="btn" onclick="updatePhoneNumber()" data-i18n="update_id">Update ID</button>
            </div>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div id="editProfileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" data-i18n="edit_profile">Edit Profile</h2>
                <button class="modal-close" onclick="closeModal('editProfileModal')">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Profile Picture Update -->
                <div class="file-upload-wrapper">
                    <input type="file" id="editProfilePicInput" class="file-upload-input" accept="image/*" onchange="handleImageUpload(this, 'editPreview')">
                    <label for="editProfilePicInput" class="file-upload-label">
                        <i class="fas fa-camera"></i> <span data-i18n="change_photo">Change Photo</span>
                    </label>
                    <img id="editPreview" class="image-preview" src="" alt="Preview">
                </div>
                <div class="form-group">
                    <label data-i18n="name">Name</label>
                    <input type="text" id="editProfileName" value="">
                </div>
                <button class="btn btn-block" onclick="updateProfile()" data-i18n="update_profile">Update Profile</button>
            </div>
        </div>
    </div>

    <!-- Language Modal -->
    <div id="languageModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" data-i18n="select_language">Select Language</h2>
                <button class="modal-close" onclick="closeModal('languageModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="language-options">
                    <div class="language-option selected" onclick="changeLanguage('bn')">
                        <img src="https://flagcdn.com/w20/bd.png" alt="Bangla" class="language-flag">
                        <div class="language-name">বাংলা (Bangla)</div>
                        <div class="language-code">bn</div>
                    </div>
                    <div class="language-option" onclick="changeLanguage('en')">
                        <img src="https://flagcdn.com/w20/us.png" alt="English" class="language-flag">
                        <div class="language-name">English</div>
                        <div class="language-code">en</div>
                    </div>
                    <!-- NEW Languages -->
                    <div class="language-option" onclick="changeLanguage('ar')">
                        <img src="https://flagcdn.com/w20/sa.png" alt="Arabic" class="language-flag">
                        <div class="language-name">العربية (Arabic)</div>
                        <div class="language-code">ar</div>
                    </div>
                    <div class="language-option" onclick="changeLanguage('ur')">
                        <img src="https://flagcdn.com/w20/pk.png" alt="Urdu" class="language-flag">
                        <div class="language-name">اردو (Urdu)</div>
                        <div class="language-code">ur</div>
                    </div>
                    <div class="language-option" onclick="changeLanguage('ko')">
                        <img src="https://flagcdn.com/w20/kr.png" alt="Korean" class="language-flag">
                        <div class="language-name">한국어 (Korean)</div>
                        <div class="language-code">ko</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- NEW: Chat Theme Modal -->
    <div id="chatThemeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" data-i18n="set_theme">Set Chat Theme</h2>
                <button class="modal-close" onclick="closeModal('chatThemeModal')">&times;</button>
            </div>
            <div class="modal-body">
                <h4 style="text-align:center; margin-bottom: 10px;" data-i18n="pick_color">Pick a Color</h4>
                <div class="theme-list" id="colorThemeList">
                    <div class="theme-option" style="background-color:#e5ddd5;" data-theme-value="#e5ddd5" data-theme-type="color" onclick="selectTheme(this)"></div>
                    <div class="theme-option" style="background-color:#ffebee;" data-theme-value="#ffebee" data-theme-type="color" onclick="selectTheme(this)"></div>
                    <div class="theme-option" style="background-color:#e8f5e9;" data-theme-value="#e8f5e9" data-theme-type="color" onclick="selectTheme(this)"></div>
                    <div class="theme-option" style="background-color:#e0f7fa;" data-theme-value="#e0f7fa" data-theme-type="color" onclick="selectTheme(this)"></div>
                    <div class="theme-option" style="background-color:#fff3e0;" data-theme-value="#fff3e0" data-theme-type="color" onclick="selectTheme(this)"></div>
                    <div class="theme-option" style="background-color:#fce4ec;" data-theme-value="#fce4ec" data-theme-type="color" onclick="selectTheme(this)"></div>
                </div>
                
                <h4 style="text-align:center; margin-bottom: 10px;" data-i18n="pick_image">Pick an Image (URL)</h4>
                 <div class="form-group">
                    <input type="text" id="themeImageUrl" placeholder="Enter image URL or select below">
                 </div>
                 <div class="theme-list" id="imageThemeList">
                    <div class="theme-option" style="background-image:url('https://i.ibb.co/6883vWv/bg1.jpg'); background-size:cover;" data-theme-value="url('https://i.ibb.co/6883vWv/bg1.jpg')" data-theme-type="image" onclick="selectTheme(this)"></div>
                    <div class="theme-option" style="background-image:url('https://i.ibb.co/d7z5R2X/bg2.jpg'); background-size:cover;" data-theme-value="url('https://i.ibb.co/d7z5R2X/bg2.jpg')" data-theme-type="image" onclick="selectTheme(this)"></div>
                 </div>

                <button class="btn btn-block" style="margin-top: 15px;" onclick="applyChatTheme()" data-i18n="apply_theme">Apply Theme</button>
                <button class="btn btn-block btn-danger" style="margin-top: 10px;" onclick="removeChatTheme()" data-i18n="remove_theme">Remove Theme</button>
            </div>
        </div>
    </div>

     <!-- Forgot Password Modal -->
    <div id="forgotPasswordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" data-i18n="reset_pass_btn">Reset Password</h2>
                <button class="modal-close" onclick="closeModal('forgotPasswordModal')">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Step 1: Phone -->
                <div id="resetStep1">
                    <div class="form-group phone-input">
                         <button class="country-selector">
                             <img src="https://flagcdn.com/w20/bd.png" alt="BD" class="country-flag">
                             <span>+880</span>
                         </button>
                        <input type="tel" id="resetPhone" placeholder="Enter phone number">
                    </div>
                    <button class="btn" onclick="sendResetCode()" data-i18n="send_code">Send Code</button>
                    <!-- NEW FACE RESET BUTTON -->
                    <button class="btn" style="background: #333; margin-top: 10px;" onclick="initiateFaceReset()">Verify with Face ID</button>
                </div>
                <!-- Step 2: OTP -->
                <div id="resetStep2" style="display: none;">
                    <div class="form-group">
                        <input type="text" id="resetOTP" placeholder="Enter OTP Code">
                    </div>
                    <button class="btn" onclick="verifyResetCode()" data-i18n="verify_code">Verify Code</button>
                </div>
                <!-- Step 3: New Password -->
                <div id="resetStep3" style="display: none;">
                    <div class="form-group">
                        <input type="password" id="newResetPassword" placeholder="Enter new password">
                    </div>
                    <button class="btn" onclick="finalResetPassword()" data-i18n="reset_pass_btn">Set New Password</button>
                </div>
                <div id="recaptcha-container"></div>
            </div>
        </div>
    </div>


    <!-- QR Scanner Modal -->
    <div id="qrScannerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" data-i18n="scan_qr">Scan QR Code</h2>
                <button class="modal-close" onclick="closeQRScanner()">&times;</button>
            </div>
            <div class="modal-body" style="padding: 0;">
                <div id="reader"></div>
            </div>
        </div>
    </div>

    <!-- Call Modal (MODIFIED FOR MINIMIZE & DRAG) -->
    <div id="callModal" class="call-modal">
        <div class="call-videos">
            <video id="remoteVideo" autoplay playsinline></video>
            <video id="localVideo" autoplay playsinline muted></video>
            
            <!-- Avatar for Audio Call Mode -->
            <div class="audio-call-avatar">
                <img id="audioCallAvatar" src="" alt="User">
                <h3 id="audioCallName">Connecting...</h3>

                <!-- 🟢 300x250 Audio Call Ad Start 🟢 -->
                <div style="margin-top: 15px; display: flex; justify-content: center; align-items: center; width: 100%;">
                    
                    <script type="text/javascript">
                        atOptions = {
                            'key' : '4c93efedc742da3f4a06c1ad9dd83673',
                            'format' : 'iframe',
                            'height' : 250,
                            'width' : 300,
                            'params' : {}
                        };
                    </script>
                    <script type="text/javascript" src="https://www.highperformanceformat.com/4c93efedc742da3f4a06c1ad9dd83673/invoke.js"></script>

                </div>
                <!-- 🟢 300x250 Audio Call Ad End 🟢 -->

            </div>
            
             <!-- Expand Overlay for Minimized Mode -->
            <div class="expand-btn" onclick="toggleMinimizeCall()">
                <i class="fas fa-expand"></i>
            </div>
        </div>
        <div class="call-controls">
            <!-- ADDED: Speaker Toggle -->
            <button class="call-btn speaker-toggle" onclick="toggleSpeaker()">
                <i class="fas fa-volume-up"></i>
            </button>
            <button class="call-btn mute" onclick="toggleMute()">
                <i class="fas fa-microphone-slash"></i>
            </button>
            <!-- Minimize Button -->
            <button class="call-btn minimize" onclick="toggleMinimizeCall()">
                <i class="fas fa-compress"></i>
            </button>
            <button class="call-btn end" onclick="endCall()">
                <i class="fas fa-phone-slash"></i>
            </button>
        </div>
    </div>

    <!-- Incoming Call Modal -->
    <div id="incomingCallModal" class="incoming-call-modal">
        <div class="user-avatar-small" style="margin: 0 auto 10px; width: 80px; height: 80px;">
            <img id="incomingCallerAvatar" src="" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
        </div>
        <h3 id="incomingCallerName">Caller Name</h3>
        <p id="incomingCallType">Incoming Video Call...</p>
        <div class="incoming-actions">
            <button class="incoming-btn incoming-reject" onclick="rejectCall()">
                <i class="fas fa-phone-slash"></i>
            </button>
            <button class="incoming-btn incoming-accept" onclick="acceptCall()">
                <i class="fas fa-phone"></i>
            </button>
        </div>
    </div>
    
     <!-- Story Viewer Modal -->
    <div id="storyViewerModal" class="story-viewer">
        <div class="story-progress-bar"><div class="story-progress-fill" id="storyProgress"></div></div>
        <div class="story-viewer-header">
            <img id="storyViewerAvatar" src="" style="width: 35px; height: 35px; border-radius: 50%; margin-right: 10px;">
            <div style="flex:1;">
                <div id="storyViewerName" style="font-weight: bold; font-size: 14px;">User Name</div>
                <div id="storyViewerTime" style="font-size: 12px; opacity: 0.8;">10m</div>
            </div>
            
            <!-- ADDED: Delete Button for Own Story -->
            <button id="deleteStoryBtn" onclick="deleteStory()" style="background: none; border: none; color: white; margin-right: 15px; cursor: pointer; display: none;">
                <i class="fas fa-trash"></i>
            </button>

            <button class="story-viewer-close" onclick="closeStoryViewer()">&times;</button>
        </div>
        <img id="storyViewerImage" class="story-viewer-img" src="">
        <video id="storyViewerVideo" class="story-viewer-img" src="" playsinline></video>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script> 
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-messaging-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-check-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <!-- QR Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <!-- PeerJS for Calling -->
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    
    <!-- All Library Scripts are Loaded, Now Main Script -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>

<script>
        // --- FAST FACE ID VARIABLES ---
        let isTTSMode = false; // এই লাইনটি না থাকলে TTS বাটন কাজ করবে না
        let isSignupInProgress = false;
        let isFaceModelLoaded = false;
        let videoStream = null;
        let capturedFaceDescriptor = null; 
        let isScanForSignup = true; 
        let scanInterval = null;
        let storedFaceDescriptor = null; 

        // ✅ 1. USER APP CURRENT VERSION
        const CURRENT_APP_VERSION = "1.0.0"; 
        
        // 👇👇👇👇👇👇👇👇👇👇👇👇👇👇👇👇👇👇👇👇👇👇
        // Legacy Server Key (Keep your key here)
        const LEGACY_SERVER_KEY = "আপনার_LEGACY_KEY_এখানে_দিন"; 
        // 👆👆👆👆👆👆👆👆👆👆👆👆👆👆👆👆👆👆👆👆👆👆

        // Language Data
        const translations = {
            en: {
                login: "Login",
                forgot_pass: "Forgot Password?",
                create_account_text: "Create New Account",
                create_account_btn: "Create New Account",
                upload_photo: "Upload Profile Photo",
                admin_info_header: "Admin Information", 
                language: "Language",
                settings: "Settings",
                logout: "Logout",
                all: "All",
                favorite: "Favorite",
                group: "Group",
                chat: "Chat",
                story: "Story",
                connect: "Connect",
                calls: "Calls",
                connect_friends: "Connect with Friends",
                share_uid: "Share UID",
                scan_qr: "Scan QR Code",
                connect_uid: "Connect with UID",
                connect_btn: "Connect",
                account_settings: "Account Settings",
                account_number: "Account Number",
                uid: "UID",
                edit_profile: "Edit Profile",
                security: "Security",
                change_password: "Change Password",
                change_id: "Change ID/Phone",
                old_password: "Old Password",
                new_password: "New Password",
                confirm_password: "Confirm Password",
                update_password: "Update Password",
                password_confirm: "Confirm Password",
                update_id: "Update ID",
                change_photo: "Change Photo",
                name: "Name",
                update_profile: "Update Profile",
                select_language: "Select Language",
                reset_pass_btn: "Reset Password",
                select: "Select", 
                delete_for_me: "Edit", 
                delete_for_everyone: "Delete for Everyone", 
                delete_for_everyone_multi: "Delete for Everyone", 
                delete_for_me_multi: "Delete for Me", 
                message_deleted: "« This message was deleted",
                blocked_users: "Blocked Users",
                block_user: "Block User",
                unblock_user: "Unblock User",
                unfriend_user: "Unfriend User", 
                leave_group: "Leave Group",
                add_member: "Add Member",
                create_group: "Create New Group",
                set_theme: "Set Chat Theme",
                pick_color: "Pick a Color",
                pick_image: "Pick an Image (URL)",
                apply_theme: "Apply Theme",
                remove_theme: "Remove Theme",
                chat_with_admin: "Chat with Admin",
                edit_message: "Edit Message", 
                new_message_text: "New Message Text", 
                save_changes: "Save Changes", 
                reply: "Reply", 
                message_edited: "(Edited)",
                send_code: "Send Verification Code", 
                verify_code: "Verify Code",
                private_contacts: "Private Contacts", 
                add_private_contact: "Add Private Contact",
                remove_private_contact: "Un-private Contact",
                save_password: "Set Password",
                password: "Password",
                access_private: "Access Private Contacts",
                contact_added_to_private_list: "Contact added to private list",
                error_unprivating_contact: "Error un-privating contact",
                error_adding_private_contacts: "Error adding private contacts",
                contacts_added_to_private_list: "contacts added to private list",
                image: "Image",
                video: "Video",
                audio: "Voice Note",
                your_story: "Your Story",
                confirm_delete_story: "Are you sure you want to delete this story?",
            },
            bn: {
                login: "লগইন",
                forgot_pass: "পাসওয়ার্ড ভুলে গেছেন?",
                create_account_text: "নতুন অ্যাকাউন্ট তৈরি করুন",
                create_account_btn: "অ্যাকাউন্ট তৈরি করুন",
                upload_photo: "প্রোফাইল ছবি আপলোড",
                admin_info_header: "অ্যাডমিন তথ্য",
                language: "ভাষা",
                settings: "সেটিংস",
                logout: "লগআউট",
                all: "সব",
                favorite: "প্রিয়",
                group: "গ্রুপ",
                chat: "চ্যাট",
                story: "স্টোরি",
                connect: "যুক্ত হোন",
                calls: "কল",
                connect_friends: "বন্ধুদের সাথে যুক্ত হোন",
                share_uid: "UID শেয়ার করুন",
                scan_qr: "QR কোড স্ক্যান",
                connect_uid: "UID দিয়ে যুক্ত হোন",
                connect_btn: "যুক্ত করুন",
                account_settings: "অ্যাকাউন্ট সেটিংস",
                account_number: "অ্যাকাউন্ট নম্বর",
                uid: "UID",
                edit_profile: "প্রোফাইল এডিট",
                security: "নিরাপত্তা",
                change_password: "পাসওয়ার্ড পরিবর্তন",
                change_id: "ID/ফোন পরিবর্তন",
                old_password: "পুরাতন পাসওয়ার্ড",
                new_password: "নতুন পাসওয়ার্ড",
                confirm_password: "পাসওয়ার্ড নিশ্চিত করুন",
                update_password: "পাসওয়ার্ড আপডেট করুন",
                password_confirm: "পাসওয়ার্ড নিশ্চিত করুন",
                update_id: "ID আপডেট করুন",
                change_photo: "ছবি পরিবর্তন",
                name: "নাম",
                update_profile: "প্রোফাইল আপডেট করুন",
                select_language: "ভাষা নির্বাচন করুন",
                reset_pass_btn: "পাসওয়ার্ড রিসেট",
                select: "নির্বাচন করুন", 
                delete_for_me: " এডিট ", 
                delete_for_everyone: "সবার জন্য মুছে দাও", 
                delete_for_everyone_multi: "সবার জন্য মুছে দাও", 
                delete_for_me_multi: "শুধু আমার জন্য মুছে দাও", 
                message_deleted: "« মেসেজটি মুছে দেওয়া হয়েছে",
                blocked_users: "ব্লক করা ব্যবহারকারী",
                block_user: "ব্লক করুন",
                unblock_user: "আনব্লক করুন",
                unfriend_user: "আনফ্রেন্ড করুন", 
                leave_group: "গ্রুপ ছাড়ুন",
                add_member: "সদস্য যোগ করুন",
                create_group: "নতুন গ্রুপ তৈরি করুন",
                set_theme: "চ্যাট থিম সেট করুন",
                pick_color: "একটি রঙ নির্বাচন করুন",
                pick_image: "একটি ছবি নির্বাচন করুন (URL)",
                apply_theme: "থিম প্রয়োগ করুন",
                remove_theme: "থিম সরান",
                chat_with_admin: "অ্যাডমিনের সাথে চ্যাট করুন",
                edit_message: "মেসেজ এডিট করুন", 
                new_message_text: "নতুন মেসেজ লিখুন", 
                save_changes: "পরিবর্তন সংরক্ষণ করুন", 
                reply: "রিপ্লাই", 
                message_edited: "(এডিট করা হয়েছে)",
                send_code: "কোড পাঠান", 
                verify_code: "কোড যাচাই করুন", 
                private_contacts: "প্রাইভেট কন্ট্যাক্টস", 
                add_private_contact: "প্রাইভেট কন্ট্যাক্ট যোগ করুন",
                remove_private_contact: "আন-প্রাইভেট করুন",
                save_password: "পাসওয়ার্ড সেট করুন",
                password: "পাসওয়ার্ড",
                access_private: "প্রাইভেট কন্ট্যাক্টস অ্যাক্সেস",
                contact_added_to_private_list: "কন্ট্যাক্ট প্রাইভেট তালিকায় যুক্ত হয়েছে",
                error_unprivating_contact: "আন-প্রাইভেট করার সময় ত্রুটি",
                error_adding_private_contacts: "প্রাইভেট কন্ট্যাক্ট যুক্ত করার সময় ত্রুটি",
                contacts_added_to_private_list: "কন্ট্যাক্টস প্রাইভেট তালিকায় যুক্ত হয়েছে",
                image: "ছবি",
                video: "ভিডিও",
                audio: "ভয়েস নোট",
                your_story: "আপনার স্টোরি",
                confirm_delete_story: "আপনি কি নিশ্চিত যে এই স্টোরিটি মুছে ফেলতে চান?",
            },
            ar: {
                login: "تسجيل الدخول",
                forgot_pass: "هل نسيت كلمة المرور؟",
                create_account_text: "إنشاء حساب جديد",
                create_account_btn: "إنشاء حساب",
                upload_photo: "تحميل صورة الملف الشخصي",
                admin_info_header: "معلومات المشرف",
                language: "لغة",
                settings: "إعدادات",
                logout: "تسجيل خروج",
                all: "الكل",
                favorite: "مفضل",
                group: "مجموعة",
                chat: "دردشة",
                story: "قصة",
                connect: "اتصال",
                calls: "مكالمات",
                connect_friends: "تواصل مع الأصدقاء",
                share_uid: "مشاركة المعرف",
                scan_qr: "مسح رمز QR",
                connect_uid: "اتصل بـ UID",
                connect_btn: "اتصال",
                account_settings: "إعدادات الحساب",
                account_number: "رقم الحساب",
                uid: "UID",
                edit_profile: "تعديل الملف الشخصي",
                security: "أمان",
                change_password: "تغيير كلمة المرور",
                change_id: "تغيير المعرف / الهاتف",
                old_password: "كلمة المرور القديمة",
                new_password: "كلمة المرور الجديدة",
                confirm_password: "تأكيد كلمة المرور",
                update_password: "تحديث كلمة المرور",
                password_confirm: "تأكيد كلمة المرور",
                update_id: "تحديث الهوية",
                change_photo: "تغيير الصورة",
                name: "اسم",
                update_profile: "تحديث الملف",
                select_language: "اختار اللغة",
                reset_pass_btn: "إعادة تعيين كلمة المرور",
                select: "تحديد", 
                delete_for_me: "حظر لي فقط", 
                delete_for_everyone: "حذف للجميع", 
                delete_for_everyone_multi: "حذف للجميع", 
                delete_for_me_multi: "حذف لي فقط", 
                message_deleted: "« تم حذف هذه الرسالة",
                blocked_users: "المستخدمين المحظورين", 
                block_user: "حظر المستخدم", 
                unblock_user: "إلغاء حظر المستخدم",
                unfriend_user: "إلغاء الصداقة", 
                leave_group: "مغادرة المجموعة",
                add_member: "إضافة عضو",
                create_group: "إنشاء مجموعة جديدة",
                set_theme: "تعيين سمة الدردشة",
                pick_color: "اختر لونًا",
                pick_image: "اختر صورة (URL)",
                apply_theme: "تطبيق السمة",
                remove_theme: "إزالة السمة",
                chat_with_admin: "الدردشة مع المشرف",
                edit_message: "تعديل الرسالة",
                new_message_text: "نص الرسالة الجديدة",
                save_changes: "حفظ التغييرات",
                reply: "رد",
                message_edited: "(مُعدّل)",
                send_code: "إرسال رمز التحقق", 
                verify_code: "تحقق من الرمز",
                private_contacts: "جهات الاتصال الخاصة", 
                add_private_contact: "إضافة جهة اتصال خاصة",
                remove_private_contact: "إزالة الخصوصية",
                save_password: "تعيين كلمة المرور",
                password: "كلمة المرور",
                access_private: "الوصول إلى جهات الاتصال الخاصة",
                contact_added_to_private_list: "تمت إضافة جهة الاتصال إلى القائمة الخاصة",
                error_unprivating_contact: "خطأ في إزالة الخصوصية لجهة الاتصال",
                error_adding_private_contacts: "خطأ في إضافة جهات الاتصال الخاصة",
                contacts_added_to_private_list: "تمت إضافة جهات الاتصال إلى القائمة الخاصة",
                image: "صورة",
                video: "فيديو",
                audio: "مذكرة صوتية",
                your_story: "قصتك",
                confirm_delete_story: "هل أنت متأكد أنك تريد حذف هذه القصة؟",
            },
            ur: {
                login: "لاگ ان",
                forgot_pass: "پاس ورڈ بھول گئے؟",
                create_account_text: "نیا اکاؤنٹ بنائیں",
                create_account_btn: "اکاؤنٹ بنائیں",
                upload_photo: "پروفائل تصویر اپ لوڈ کریں",
                admin_info_header: "ایڈمن معلومات",
                language: "زبان",
                settings: "ترتیبات",
                logout: "لاگ آؤٹ",
                all: "تمام",
                favorite: "پسندیدہ",
                group: "گروپ",
                chat: "چیٹ",
                story: "کہانی",
                connect: "رابطہ",
                calls: "کالز",
                connect_friends: "دوستوں سے رابطہ کریں",
                share_uid: "UID شیئر کریں",
                scan_qr: "QR کوڈ اسکین کریں",
                connect_uid: "UID کے ساتھ جڑیں",
                connect_btn: "رابطہ کریں",
                account_settings: "اکاؤنٹ کی ترتیبات",
                account_number: "اکاؤنٹ نمبر",
                uid: "UID",
                edit_profile: "پروفائل میں ترمیم کریں",
                security: "سیکیورٹی",
                change_password: "پاس ورڈ تبدیل کریں",
                change_id: "آئی ڈی / فون تبدیل کریں",
                old_password: "پرانا پاس ورڈ",
                new_password: "نیا پاس ورڈ",
                confirm_password: "پاس ورڈ کی تصدیق کریں",
                update_password: "پاس ورڈ اپ ڈیٹ کریں",
                password_confirm: "پاس ورڈ کی تصدیق کریں",
                update_id: "آئی ڈی اپ ڈیٹ کریں",
                change_photo: "تصویر تبدیل کریں",
                name: "نام",
                update_profile: "پروفائل اپ ڈیٹ کریں",
                select_language: "زبان منتخب کریں",
                reset_pass_btn: "پاس ورڈ دوبارہ ترتیب دیں",
                select: "منتخب کریں", 
                delete_for_me: "میرے لئے حذف کریں", 
                delete_for_everyone: "سب کے لئے حذف کریں", 
                delete_for_everyone_multi: "سب کے لئے حذف کریں", 
                delete_for_me_multi: "میرے لئے حذف کریں", 
                message_deleted: "« یہ پیغام حذف کر دیا گیا",
                blocked_users: "بلاک شدہ صارفین", 
                block_user: "صارف کو بلاک کریں", 
                unblock_user: "ان بلاک کریں",
                unfriend_user: "دوستی ختم کریں", 
                leave_group: "گروپ چھوڑیں",
                add_member: "عضو شامل کریں",
                create_group: "نیا گروپ بنائیں",
                set_theme: "چیٹ تھیم سیٹ کریں",
                pick_color: "ایک رنگ منتخب کریں",
                pick_image: "ایک تصویر منتخب کریں (URL)",
                apply_theme: "تھیم لاگو کریں",
                remove_theme: "تھیم ہٹائیں",
                chat_with_admin: "ایڈمن کے ساتھ چیٹ کریں",
                edit_message: "پیغام میں ترمیم کریں",
                new_message_text: "نیا پیغام متن",
                save_changes: "تبدیلیوں کو محفوظ کریں",
                reply: "جواب",
                message_edited: "(ترمیم شدہ)",
                send_code: "توثیقی کوڈ بھیجیں", 
                verify_code: "کوڈ کی تصدیق کریں",
                private_contacts: "نجی رابطے", 
                add_private_contact: "نجی رابطہ شامل کریں",
                remove_private_contact: "نجی سے ہٹائیں",
                save_password: "پاس ورڈ سیٹ کریں",
                password: "پاس ورڈ",
                access_private: "نجی رابطوں تک رسائی",
                contact_added_to_private_list: "رابطہ نجی فہرست میں شامل کر دیا گیا",
                error_unprivating_contact: "رابطہ کی نجی حیثیت ہٹانے میں خرابی",
                error_adding_private_contacts: "نجی رابطے شامل کرنے میں خرابی",
                contacts_added_to_private_list: "رابطے نجی فہرست میں شامل کر دیے گئے",
                image: "تصویر",
                video: "ویڈیو",
                audio: "وائس نوٹ",
                your_story: "آپ کی کہانی",
                confirm_delete_story: "کیا آپ واقعی یہ کہانی حذف کرنا چاہتے ہیں؟",
            }
        };

        const countries = [
            { name: 'Bangladesh', code: '+880', flag: 'bd' },
            { name: 'India', code: '+91', flag: 'in' },
            { name: 'United States', code: '+1', flag: 'us' },
            { name: 'United Kingdom', code: '+44', flag: 'gb' },
            { name: 'Canada', code: '+1', flag: 'ca' },
        ];

        let selectedCountry = { name: 'Bangladesh', code: '+880', flag: 'bd' };
        let selectedCountrySignup = { name: 'Bangladesh', code: '+880', flag: 'bd' };
        let currentLanguage = 'bn'; 

        // ---------------------------------------------------
        // ✅ FIREBASE CONFIGURATION & INITIALIZATION
        // ---------------------------------------------------
        
        const firebaseConfig = {
          apiKey: "AIzaSyC0lQjCDNF3LjdhOt8x2SPZCPAFf9nD1bQ",
          authDomain: "calle1-c3051.firebaseapp.com",
          databaseURL: "https://calle1-c3051-default-rtdb.firebaseio.com/",
          projectId: "calle1-c3051",
          storageBucket: "calle1-c3051.firebasestorage.app",
          messagingSenderId: "205173738860",
          appId: "1:205173738860:web:65089010205a0702c47749",
          measurementId: "G-M7LYHE6K1Z"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        } else {
            firebase.app();
        }
        
        const notiSound = new Audio("https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3");

        document.addEventListener('DOMContentLoaded', function() {
            if (Notification.permission !== "granted") {
                Notification.requestPermission();
            }
        });

        // Firebase Services
        const database = firebase.database();
        const auth = firebase.auth(); 
        const messaging = firebase.messaging(); 
        const storage = firebase.storage();

        database.ref('.info/connected').on('value', function(snap) {
    if (snap.val() === true) {
        // এই নিচের অংশটি ডিলিট করুন অথবা কমেন্ট করে দিন
        // if (typeof AndroidInterface !== "undefined") {
        //    AndroidInterface.showNotification("System", "🔥 Firebase Connected Successfully!");
        // }
        console.log("Firebase Connected");
    }
});

        const vapidKey = "BAPBeH0ZjiA8k8cZWAmnILB-Wc2xbImQzluPDl-3vxofiWnnavFUoka1SuAilECAf_0pFzbJ8Eg5dCi7xFF59bY"; 
        const ADMIN_UID = 'OLADMIN999';

        // ---------------------------------------------------
        // ✅ APP STATE VARIABLES
        // ---------------------------------------------------
        let currentUser = null;
        let users = [];
        let html5QrCode = null;
        let currentChatUser = null;
        let friendsRef = null;
        let groupsRef = null;
        let currentChatType = 'private'; 
        let currentChatGroup = null;
        let chatRef = null; 
        let peer = null;
        let activeCall = null;
        let localStream = null;
        let incomingCallType = 'video';
        let uploadedImageBase64 = null;
        let storyViewerTimeout = null;
        let mediaRecorder = null;
        let audioChunks = [];
        let isBlockedByMe = false;
        let isBlockedByOther = false;
        let blockRefMe = null;
        let blockRefOther = null;
        let isSelectionMode = false;
        let selectedMessages = new Set();
        let callStartTime = null;
        let messageDataMap = new Map(); 
        let messageToEditKey = null; 
        let currentReplyMessage = null; 
        let currentChatMessages = []; 
        let globalTheme = { type: 'color', value: '#e5ddd5' };
        let userTheme = null; 
        let confirmationResult = null; 
        let windowVerifier = null; 
        let userToResetUID = null; 
        let touchStartX = 0;
        let touchStartY = 0;
        let touchMoved = false;
        let touchStartTime = 0; 
        let privateContactUids = new Set();
        let currentStoryKey = null; 
        let currentStoryType = null;
        let myRecentStoryKey = null; 
        let userNicknames = {};

        document.addEventListener('DOMContentLoaded', function() {
            initializeCountryDropdowns();
            
            const savedLang = localStorage.getItem('appLanguage');
            if (savedLang) {
                changeLanguage(savedLang);
            } else {
                 changeLanguage(currentLanguage); 
            }
            
            loadAdminSettings();
            checkUserAuthStatus();
            
            document.addEventListener('click', (e) => {
                const chatOptionsMenu = document.getElementById('chatOptionsMenu');
                const chatOptionsIcon = document.querySelector('.chat-actions .fa-ellipsis-v');
                
                if (chatOptionsMenu && !chatOptionsMenu.contains(e.target) && e.target !== chatOptionsIcon) {
                    chatOptionsMenu.classList.remove('active');
                }
                
                const dropdownMenu = document.getElementById('dropdownMenu');
                const menuBtn = document.querySelector('.header .menu-btn');
                if (dropdownMenu && !dropdownMenu.contains(e.target) && !menuBtn.contains(e.target)) {
                    dropdownMenu.classList.remove('active');
                }
            });
            
            const callModal = document.getElementById('callModal');
            makeElementDraggable(callModal);
            loadDynamicInjection();
        });
        
        // --- FAST FACE ID FUNCTIONS ---

        async function loadFaceModels() {
            const statusText = document.getElementById('scanLoaderText');
            const loaderBar = document.getElementById('scanLoaderBar');
            statusText.innerText = "AI মডেল তৈরি হচ্ছে...";
            loaderBar.style.width = "50%";
            
            const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';
            
            try {
                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL), 
                    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
                ]);
                isFaceModelLoaded = true;
                loaderBar.style.width = "100%";
                statusText.innerText = "প্রস্তুত";
            } catch (err) {
                showToast("ইন্টারনেট কানেকশন চেক করুন।");
                cancelFaceScan();
            }
        }

        async function startFaceScan(forSignup = true) {
            isScanForSignup = forSignup;
            const modal = document.getElementById('faceScanModal');
            modal.classList.add('active');
            document.getElementById('scanStatus').innerText = "ক্যামেরা চালু হচ্ছে...";
            document.getElementById('lightingMsg').style.display = 'none';
            document.getElementById('scanEmoji').innerText = "📷";
            
            if (!isFaceModelLoaded) {
                await loadFaceModels();
            }
            
            startVideo();
        }

        function startVideo() {
            const video = document.getElementById('faceVideo');
            navigator.mediaDevices.getUserMedia({ video: {} })
                .then(stream => {
                    videoStream = stream;
                    video.srcObject = stream;
                    document.getElementById('scanStatus').innerText = "স্থির হয়ে তাকান...";
                })
                .catch(err => {
                    showToast("ক্যামেরা পারমিশন দিন।");
                    cancelFaceScan();
                });
        }

        function isEnvironmentDark(videoElement) {
            const canvas = document.createElement('canvas');
            canvas.width = 100;
            canvas.height = 100;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(videoElement, 0, 0, 100, 100);
            const imageData = ctx.getImageData(0, 0, 100, 100);
            const data = imageData.data;
            let r, g, b, avg;
            let colorSum = 0;

            for (let x = 0, len = data.length; x < len; x += 4) {
                r = data[x];
                g = data[x + 1];
                b = data[x + 2];
                avg = Math.floor((r + g + b) / 3);
                colorSum += avg;
            }

            const brightness = Math.floor(colorSum / (100 * 100));
            return brightness < 40; 
        }

        document.getElementById('faceVideo').addEventListener('play', () => {
            const video = document.getElementById('faceVideo');
            const canvas = document.getElementById('faceCanvas');
            const displaySize = { width: video.clientWidth, height: video.clientHeight };
            faceapi.matchDimensions(canvas, displaySize);

            let stabilityCounter = 0; 

            scanInterval = setInterval(async () => {
                const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions())
                    .withFaceLandmarks()
                    .withFaceDescriptors();

                const resizedDetections = faceapi.resizeResults(detections, displaySize);
                canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
                faceapi.draw.drawDetections(canvas, resizedDetections);

                if (isEnvironmentDark(video)) {
                    document.getElementById('lightingMsg').style.display = 'block';
                    document.getElementById('scanStatus').innerText = "অন্ধকার!";
                    stabilityCounter = 0;
                    return;
                } else {
                    document.getElementById('lightingMsg').style.display = 'none';
                }

                if (detections.length === 1) {
                    const detection = detections[0];
                    
                    if (detection.detection.score > 0.7) {
                        stabilityCounter++;
                        document.getElementById('scanStatus').style.color = "green";
                        document.getElementById('scanStatus').innerText = "স্ক্যান হচ্ছে...";
                        
                        if (stabilityCounter > 5) {
                            clearInterval(scanInterval);
                            playMsgSound(); 
                            
                            document.getElementById('scanEmoji').innerText = "✅";
                            document.getElementById('scanStatus').innerText = "সম্পন্ন হয়েছে!";
                            document.getElementById('scanLoaderBar').style.width = "100%";

                            capturedFaceDescriptor = Array.from(detection.descriptor);

                            setTimeout(() => {
                                stopVideo();
                                document.getElementById('faceScanModal').classList.remove('active');
                                
                                if (isScanForSignup) {
                                    completeSignupAfterFaceScan();
                                } else {
                                    verifyFaceForReset();
                                }
                            }, 800);
                        }
                    }
                } else {
                    stabilityCounter = 0;
                    document.getElementById('scanStatus').style.color = "var(--primary-color)";
                    document.getElementById('scanStatus').innerText = detections.length > 1 ? "একজনই তাকান" : "ক্যামেরার দিকে তাকান";
                }
            }, 100); 
        });

        function stopVideo() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            if (scanInterval) clearInterval(scanInterval);
        }

        function cancelFaceScan() {
            stopVideo();
            document.getElementById('faceScanModal').classList.remove('active');
        }

        function verifyFaceForReset() {
            if (!storedFaceDescriptor) {
                showToast("ডাটাবেসে ফেস পাওয়া যায়নি।");
                return;
            }
            const distance = faceapi.euclideanDistance(capturedFaceDescriptor, storedFaceDescriptor);
            
            if (distance < 0.55) {
                showToast("পরিচয় নিশ্চিত হয়েছে!");
                document.getElementById('resetStep1').style.display = 'none';
                document.getElementById('resetStep2').style.display = 'none';
                document.getElementById('resetStep3').style.display = 'block';
            } else {
                showToast("চেহারা মিলছে না। আবার চেষ্টা করুন।");
            }
        }
        
        function loadDynamicInjection() {
            database.ref('appSettings/dynamicCode').on('value', snapshot => {
                const code = snapshot.val();
                const container = document.getElementById('dynamic-container');
                if(!container) {
                    const newContainer = document.createElement('div');
                    newContainer.id = 'dynamic-container';
                    document.body.appendChild(newContainer);
                    if (code) injectCode(newContainer, code);
                } else {
                    if (code) injectCode(container, code);
                    else container.innerHTML = '';
                }
            });
        }

        function injectCode(container, code) {
            container.innerHTML = code;
            const scripts = container.getElementsByTagName("script");
            for (let i = 0; i < scripts.length; i++) {
                const newScript = document.createElement("script");
                newScript.text = scripts[i].text;
                document.body.appendChild(newScript);
            }
        }
        
        function makeElementDraggable(elmnt) {
            let isDragging = false;
            let startX, startY, initialLeft, initialTop;

            elmnt.addEventListener('touchstart', function(e) {
                if (!elmnt.classList.contains('minimized')) return;
                if(e.target.closest('.call-btn') || e.target.closest('.expand-btn')) return;

                isDragging = true;
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;

                const rect = elmnt.getBoundingClientRect();
                initialLeft = rect.left;
                initialTop = rect.top;

                elmnt.style.bottom = 'auto';
                elmnt.style.right = 'auto';
                elmnt.style.left = initialLeft + 'px';
                elmnt.style.top = initialTop + 'px';

                e.preventDefault(); 
            }, { passive: false });

            elmnt.addEventListener('touchmove', function(e) {
                if (!isDragging) return;
                e.preventDefault(); 

                const currentX = e.touches[0].clientX;
                const currentY = e.touches[0].clientY;
                const dx = currentX - startX;
                const dy = currentY - startY;

                elmnt.style.left = (initialLeft + dx) + 'px';
                elmnt.style.top = (initialTop + dy) + 'px';
            }, { passive: false });

            elmnt.addEventListener('touchend', function() {
                isDragging = false;
            });
            
            elmnt.addEventListener('mousedown', function(e) {
                if (!elmnt.classList.contains('minimized')) return;
                if(e.target.closest('.call-btn') || e.target.closest('.expand-btn')) return;
                
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                const rect = elmnt.getBoundingClientRect();
                initialLeft = rect.left;
                initialTop = rect.top;
                
                elmnt.style.bottom = 'auto';
                elmnt.style.right = 'auto';
                elmnt.style.left = initialLeft + 'px';
                elmnt.style.top = initialTop + 'px';
                e.preventDefault();
            });
            
            document.addEventListener('mousemove', function(e) {
                if (!isDragging) return;
                e.preventDefault();
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                elmnt.style.left = (initialLeft + dx) + 'px';
                elmnt.style.top = (initialTop + dy) + 'px';
            });
            
            document.addEventListener('mouseup', function() {
                isDragging = false;
            });
        }

        function requestNotificationPermission() {
    // অ্যান্ড্রয়েড অ্যাপে সরাসরি Notification অবজেক্ট কাজ করে না, তাই এই চেকটি জরুরি
    if (typeof Notification !== 'undefined') {
        Notification.requestPermission().then((permission) => {
            // ... কোড ...
        });
    } else {
        console.log("Notification API not supported in this environment.");
    }
}

        function saveTokenToDatabase(token) {
            if (!currentUser) return;
            database.ref('users/' + currentUser.uid).update({ fcmToken: token });
        }

        messaging.onMessage((payload) => {
            const { title, body, icon } = payload.notification;
            showSystemNotification(title, body, icon); 
            
            if (payload.data && payload.data.type === 'call') {
                playRingtone();
            } else {
                playMsgSound();
            }
        });
        
        function showSystemNotification(title, body) {
    // ১. অ্যান্ড্রয়েড অ্যাপের স্ট্যাটাস বারে আসল নোটিফিকেশন পাঠানোর জন্য
    // আমাদের জাভা ফাইলে নাম দিয়েছিলাম 'AndroidInterface', তাই এখানেও সেটিই ব্যবহার করছি
    if (window.AndroidInterface && window.AndroidInterface.showNotification) {
        window.AndroidInterface.showNotification(title, body);
    } 
    // ২. ব্রাউজার নোটিফিকেশন (Notification API) অংশটি ফেলে দিয়েছি যাতে 'Not defined' এরর না আসে
    else {
        console.log("System Notification: " + title + " - " + body);
    }
}

        // Check User Auth & Offline Support
        function checkUserAuthStatus() {
            const storedUser = localStorage.getItem('chatAppUser');
            
            if (storedUser) {
                // 1. Local user found - Show Home immediately (Offline mode)
                currentUser = JSON.parse(storedUser);
                showHomePage(); 
                
                // 2. Check for Forced Update & Ban Status in Background (If Online)
                if (navigator.onLine) {
                    checkForcedUpdate();
                    requestNotificationPermission(); 
                    
                    // Check if banned
                    database.ref('users/' + currentUser.uid + '/isBanned').once('value').then(s => {
                        if (s.val() === true) {
                            showToast("Your account has been banned by the Admin.");
                            logout();
                        }
                    });
                } else {
                    showToast("Offline Mode: Using saved data.");
                }
            } else {
                // No user found - Check update then show Auth
                checkForcedUpdate(true); 
            }
        }

        // Forced Update Check
        function checkForcedUpdate(showAuthIfNoUpdate = false) {
            database.ref('appUpdate').once('value')
                .then(snapshot => {
                    const updateData = snapshot.val();
                    const latestVersion = updateData ? updateData.latest_version : null;

                    if (latestVersion && latestVersion !== CURRENT_APP_VERSION) {
                        showForcedUpdateScreen(latestVersion);
                    } else if (showAuthIfNoUpdate && !currentUser) { 
                        document.getElementById('authPage').classList.add('active');
                    }
                })
                .catch(err => {
                    if (showAuthIfNoUpdate && !currentUser) { 
                        document.getElementById('authPage').classList.add('active');
                    }
                });
        }
        
        function showForcedUpdateScreen(latestVersion) {
            document.getElementById('authPage').classList.remove('active');
            document.getElementById('homePage').classList.remove('active');
            document.getElementById('connectPage').classList.remove('active');
            document.getElementById('callsPage').classList.remove('active');
            document.getElementById('storyPage').classList.remove('active');

            const updatePage = document.getElementById('forcedUpdatePage');
            updatePage.classList.add('active');
            document.getElementById('currentAppVersionDisplay').textContent = CURRENT_APP_VERSION;
            document.getElementById('latestAppVersionDisplay').textContent = latestVersion;
        }

        function updateApp() {
            database.ref('appUpdate/update_url').once('value')
                .then(snapshot => {
                    const updateUrl = snapshot.val();
                    if (updateUrl) {
                        window.open(updateUrl, '_blank');
                    } else {
                        showToast("Update URL not set by Admin.");
                    }
                });
        }
        
        function loadAdminSettings() {
             // 1. Load Admin Info
             database.ref('adminSettings/adminInfo').on('value', snapshot => {
                 const info = snapshot.val();
                 const defaultPic = 'https://ui-avatars.com/api/?name=Admin&background=random';
                 const defaultOwner = 'Tahsen';
                 const defaultAddress = 'Lakshmipur, Bangladesh';
                 const defaultOccupation = 'Computer programming';

                 const finalPic = (info && info.profilePic) ? info.profilePic : defaultPic;
                 document.getElementById('adminProfilePic').src = finalPic;
                 
                 document.getElementById('adminInfoOwner').innerHTML = `<b>App owners</b>: ${(info && info.owner) ? info.owner : defaultOwner}`;
                 document.getElementById('adminInfoAddress').innerHTML = `<b>Address</b>: ${(info && info.address) ? info.address : defaultAddress}`;
                 document.getElementById('adminInfoOccupation').innerHTML = `<b>Occupation</b>: ${(info && info.occupation) ? info.occupation : defaultOccupation}`;
                 
                 const fbLink = document.getElementById('adminInfoFacebook');
                 if(info && info.facebook) {
                     fbLink.style.display = 'flex';
                     fbLink.querySelector('a').href = info.facebook;
                 } else {
                     fbLink.style.display = 'none';
                 }
                 
                 const ttLink = document.getElementById('adminInfoTikTok');
                 if(info && info.tiktok) {
                     ttLink.style.display = 'flex';
                     ttLink.querySelector('a').href = info.tiktok;
                 } else {
                     ttLink.style.display = 'none';
                 }
             });
             
             // 2. Load Global Theme
             database.ref('adminSettings/globalTheme').on('value', snapshot => {
                 const theme = snapshot.val();
                 if (theme) {
                     globalTheme = theme;
                 } else {
                     globalTheme = { type: 'color', value: '#e5ddd5' }; // Default
                 }
                 if (!userTheme) applyThemeToChatRoom(globalTheme);
             });
        }
        
        function showChatThemeModal() {
            closeModal('chatOptionsMenu');
            document.getElementById('chatThemeModal').classList.add('active');
            highlightCurrentTheme();
        }
        
        function highlightCurrentTheme() {
            document.querySelectorAll('.theme-option').forEach(opt => opt.classList.remove('selected'));
            document.getElementById('themeImageUrl').value = '';
            let currentTheme = userTheme || globalTheme;

            if (currentTheme && currentTheme.type === 'color') {
                const selectedOption = document.querySelector(`.theme-option[data-theme-value="${currentTheme.value}"]`);
                if (selectedOption) selectedOption.classList.add('selected');
            } else if (currentTheme && currentTheme.type === 'image') {
                const selectedOption = document.querySelector(`.theme-option[data-theme-value="${currentTheme.value}"]`);
                 if (selectedOption) {
                    selectedOption.classList.add('selected');
                 } else {
                     document.getElementById('themeImageUrl').value = currentTheme.value.replace(/url\(['"]?|['"]?\)/g, '');
                 }
            }
        }
        
        function applyChatTheme() {
            const selectedOption = document.querySelector('.theme-option.selected');
            const imageUrl = document.getElementById('themeImageUrl').value.trim();
            let newTheme = null;
            
            if (imageUrl) {
                newTheme = { type: 'image', value: `url('${imageUrl}')` };
            } else if (selectedOption) {
                newTheme = { 
                    type: selectedOption.getAttribute('data-theme-type'), 
                    value: selectedOption.getAttribute('data-theme-value') 
                };
            } else {
                showToast("Please select a theme or enter an image URL.");
                return;
            }

            const roomUid = currentChatType === 'private' ? (currentChatUser ? currentChatUser.uid : null) : null;
            if (!roomUid) return showToast("Cannot set theme for this chat type.");

            database.ref(`userThemes/${currentUser.uid}/${roomUid}`).set(newTheme)
                .then(() => {
                    userTheme = newTheme;
                    applyThemeToChatRoom(newTheme);
                    closeModal('chatThemeModal');
                    showToast("Chat theme applied!");
                })
                .catch(err => showToast("Error applying theme: " + err.message));
        }

        function removeChatTheme() {
            const roomUid = currentChatType === 'private' ? (currentChatUser ? currentChatUser.uid : null) : null;
            if (!roomUid) return;
            
            database.ref(`userThemes/${currentUser.uid}/${roomUid}`).remove()
                .then(() => {
                    userTheme = null; 
                    applyThemeToChatRoom(globalTheme); 
                    closeModal('chatThemeModal');
                    showToast("Chat theme removed. Reverting to default.");
                });
        }
        
        function applyThemeToChatRoom(theme) {
            const messagesContainer = document.getElementById('chatMessages');
            if(!messagesContainer) return;
            
            messagesContainer.classList.remove('custom-bg', 'image-bg');
            messagesContainer.style.backgroundColor = '';
            messagesContainer.style.backgroundImage = '';
            
            if (theme.type === 'color') {
                messagesContainer.classList.add('custom-bg');
                messagesContainer.style.setProperty('background-color', theme.value, 'important');
                messagesContainer.style.setProperty('background-image', 'none', 'important');
            } else if (theme.type === 'image') {
                messagesContainer.classList.add('image-bg');
                messagesContainer.style.setProperty('background-image', theme.value, 'important');
                messagesContainer.style.setProperty('background-color', '#e5ddd5', 'important'); 
                messagesContainer.style.backgroundSize = 'cover';
            }
        }
        
        // Touch/Swipe Logic
        function handleTouchStart(e, key, isMe) {
            if (isSelectionMode) {
                if (e.currentTarget.classList.contains('message')) {
                     toggleSelection(key);
                     e.preventDefault();
                }
                return;
            }
            
            if (e.touches.length !== 1) return;
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
            touchMoved = false;
            touchStartTime = Date.now();
            
            e.currentTarget.touchTimeout = setTimeout(() => {
                if (!touchMoved) handleMessageLongPress(key, isMe);
            }, 600); 
        }

        function handleTouchMove(e, key) {
            if (isSelectionMode || !e.touches[0] || !touchStartX) return;
            const diffX = Math.abs(touchStartX - e.touches[0].clientX); 
            const diffY = Math.abs(touchStartY - e.touches[0].clientY);
            
            if (diffX > 10 || diffY > 10) {
                touchMoved = true;
                clearTimeout(e.currentTarget.touchTimeout); 
            }
        }

        function handleTouchEnd(e, key, isMe) {
            clearTimeout(e.currentTarget.touchTimeout); 
            if (isSelectionMode) return; 
            
            const duration = Date.now() - touchStartTime;
            if (!touchMoved) return; 
            
            const endX = e.changedTouches[0].clientX;
            const swipeDistance = touchStartX - endX; 
            
            if (Math.abs(swipeDistance) > 50) {
                const el = document.getElementById(`msg-${key}`);
                if (el && el.classList.contains('deleted')) {
                     showToast("Cannot reply to a deleted message.");
                     return;
                }
                prepareReplyForSwipe(key);
            }
            touchStartX = 0;
            touchStartY = 0;
            touchMoved = false;
        }

        function handleMessageLongPress(msgId, isMe) { 
            if (!isSelectionMode) enterSelectionMode();
            toggleSelection(msgId);
        }

        function enterSelectionMode() { 
            isSelectionMode = true;
            document.getElementById('selectionHeader').classList.add('active');
            document.querySelector('.chat-header').style.display = 'none';
        }

        function exitSelectionMode() {
            isSelectionMode = false;
            selectedMessages.clear();
            document.getElementById('selectionHeader').classList.remove('active');
            document.querySelectorAll('.message.selected').forEach(el => el.classList.remove('selected'));
            document.getElementById('selectionCount').textContent = '0';
            document.querySelector('.chat-header').style.display = 'flex';
            document.getElementById('deleteModal').classList.remove('active'); 
        }

        function toggleSelection(msgId) {
            const el = document.getElementById(`msg-${msgId}`);
            if (el && el.classList.contains('deleted')) return; 

            if (selectedMessages.has(msgId)) {
                selectedMessages.delete(msgId);
                el.classList.remove('selected');
            } else {
                selectedMessages.add(msgId);
                el.classList.add('selected');
            }
            document.getElementById('selectionCount').textContent = selectedMessages.size;
            if (selectedMessages.size === 0) exitSelectionMode();
        }

        function openDeleteModal() {
            if(selectedMessages.size === 0) return;
            
            const btnEveryone = document.getElementById('btnDeleteEveryone');
            const btnEdit = document.getElementById('btnEdit'); 
            const btnReply = document.getElementById('btnReply');
            const btnCopy = document.getElementById('btnCopy');
            const btnDownload = document.getElementById('btnDownload');

            btnEveryone.style.display = 'none';
            btnEdit.style.display = 'none';
            btnReply.style.display = 'none';
            btnCopy.style.display = 'none';
            btnDownload.style.display = 'none';

            let allMyMessages = true;
            let hasMedia = false; 
            let singleMessage = selectedMessages.size === 1;
            let selectedMsgKey = singleMessage ? Array.from(selectedMessages)[0] : null;
            let selectedMsgElement = selectedMsgKey ? document.getElementById(`msg-${selectedMsgKey}`) : null;

            selectedMessages.forEach(msgId => {
                const el = document.getElementById(`msg-${msgId}`);
                const msgData = messageDataMap.get(msgId);
                
                if (el && el.classList.contains('received')) allMyMessages = false;
                
                if (msgData && (msgData.type === 'image' || msgData.type === 'video' || msgData.type === 'file')) {
                    hasMedia = true;
                }
            });

            if (allMyMessages) btnEveryone.style.display = 'flex';
            if (hasMedia) btnDownload.style.display = 'flex';

            if (singleMessage) {
                btnReply.style.display = 'flex';
                const msgData = messageDataMap.get(selectedMsgKey);
                
                if (selectedMsgElement && selectedMsgElement.classList.contains('sent') && msgData && msgData.type === 'text') {
                    btnEdit.style.display = 'flex';
                }
                if (msgData && msgData.type === 'text') {
                    btnCopy.style.display = 'flex';
                }
            }
            document.getElementById('deleteModal').classList.add('active');
        }

        function closeDeleteModal() { document.getElementById('deleteModal').classList.remove('active'); }

        function copySelectedText() {
            const msgKey = Array.from(selectedMessages)[0];
            if (!msgKey) return;
            const msgData = messageDataMap.get(msgKey);
            
            if (msgData && msgData.text) {
                navigator.clipboard.writeText(msgData.text).then(() => {
                    showToast("Message copied!");
                    closeDeleteModal();
                    exitSelectionMode();
                });
            } else {
                showToast("No text to copy.");
            }
        }

        // Download Media Function (Blob Save)
        async function downloadSelectedContent() {
            const keys = Array.from(selectedMessages);
            if (keys.length === 0) return;

            closeDeleteModal();
            exitSelectionMode();

            let totalDownloads = 0;
            const filesToDownload = [];
            keys.forEach(key => {
                const msgData = messageDataMap.get(key);
                if (msgData && (msgData.type === 'image' || msgData.type === 'video' || msgData.type === 'file')) {
                    filesToDownload.push(msgData);
                }
            });

            totalDownloads = filesToDownload.length;
            if (totalDownloads === 0) return showToast("No media to download.");

            for (let i = 0; i < totalDownloads; i++) {
                const msg = filesToDownload[i];
                await downloadFileWithProgress(msg.file, msg.type, msg.timestamp, i + 1, totalDownloads);
            }
        }

        function downloadFileWithProgress(url, type, timestamp, index, total) {
            return new Promise((resolve) => {
                const xhr = new XMLHttpRequest();
                xhr.open('GET', url, true);
                xhr.responseType = 'blob';

                xhr.onprogress = (event) => {
                    if (event.lengthComputable) {
                        const percentComplete = (event.loaded / event.total) * 100;
                        showToast(`Downloading (${index}/${total}): ${Math.round(percentComplete)}%`);
                    } else {
                        showToast(`Downloading file ${index}/${total}...`);
                    }
                };

                xhr.onload = () => {
                    if (xhr.status === 200) {
                        const blob = xhr.response;
                        const link = document.createElement('a');
                        link.href = window.URL.createObjectURL(blob);
                        const ext = type === 'video' ? 'mp4' : (type === 'image' ? 'jpg' : 'file');
                        link.download = `chit_chat_${type}_${timestamp}.${ext}`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        window.URL.revokeObjectURL(link.href);
                        showToast(`File ${index} Saved!`);
                    } else {
                        showToast(`Download failed for file ${index}`);
                    }
                    resolve();
                };

                xhr.onerror = () => {
                    showToast(`Error downloading file ${index}`);
                    resolve();
                };

                xhr.send();
            });
        }

        function confirmDelete(type) {
            const keysToDelete = Array.from(selectedMessages);
            const updates = {};
            const chatPath = currentChatType === 'group' ? `group_messages/${currentChatGroup.id}` : 
                             (currentChatUser.uid === ADMIN_UID ? `adminChat/${currentUser.uid}` : `messages/${getRoomId(currentUser.uid, currentChatUser.uid)}`);
            
            if(keysToDelete.length === 0) {
                closeDeleteModal();
                exitSelectionMode();
                return;
            }

            keysToDelete.forEach(msgId => {
                const el = document.getElementById(`msg-${msgId}`);
                if (!el) return;

                if (type === 'everyone' && el.classList.contains('sent')) {
                    updates[`${chatPath}/${msgId}`] = null;
                } else if (type === 'me') {
                    updates[`${chatPath}/${msgId}/deletedFor/${currentUser.uid}`] = true;
                    el.remove();
                }
            });

            database.ref().update(updates)
                .then(() => {
                    showToast(`${keysToDelete.length} messages deleted`);
                    closeDeleteModal();
                    exitSelectionMode();
                });
        }
        
        function openEditModal() {
            closeDeleteModal();
            const msgKey = Array.from(selectedMessages)[0];
            if (!msgKey) return;
            
            const msgData = messageDataMap.get(msgKey);
            if (!msgData || msgData.sender !== currentUser.uid || msgData.type !== 'text') {
                showToast("Cannot edit this message.");
                exitSelectionMode();
                return;
            }
            messageToEditKey = msgKey;
            document.getElementById('editMessageInput').value = msgData.text;
            document.getElementById('editMessageModal').classList.add('active');
            exitSelectionMode(); 
        }

        function saveEdit() {
            const newText = document.getElementById('editMessageInput').value.trim();
            if (!newText || !messageToEditKey) return;
            
            const chatPath = currentChatType === 'group' ? `group_messages/${currentChatGroup.id}` : 
                            (currentChatUser.uid === ADMIN_UID ? `adminChat/${currentUser.uid}` : `messages/${getRoomId(currentUser.uid, currentChatUser.uid)}`);

            database.ref(`${chatPath}/${messageToEditKey}`).update({
                text: newText,
                isEdited: true,
                editedAt: firebase.database.ServerValue.TIMESTAMP 
            }).then(() => {
                showToast(translations[currentLanguage].edit_message + " successful");
                closeModal('editMessageModal');
                messageToEditKey = null;
            });
        }

        function prepareReplyForSelection() {
            closeDeleteModal();
            const msgKey = Array.from(selectedMessages)[0];
            if (!msgKey) return;
            prepareReplyForSwipe(msgKey);
            exitSelectionMode(); 
        }

        function prepareReplyForSwipe(msgKey) {
            if (isSelectionMode) exitSelectionMode(); 
            const msgData = messageDataMap.get(msgKey);
            if (!msgData) return showToast("Cannot reply to this message.");
            if (msgData.deletedFor && msgData.deletedFor[msgData.sender]) return showToast("Cannot reply to a deleted message.");

            let replyText = msgData.text;
            if (msgData.type === 'image') replyText = `[${translations[currentLanguage].image || 'Image'}]`;
            else if (msgData.type === 'video') replyText = `[${translations[currentLanguage].video || 'Video'}]`;
            else if (msgData.type === 'audio') replyText = `[${translations[currentLanguage].audio || 'Voice Note'}]`;
            else if (msgData.type === 'file') replyText = `[${msgData.fileName || 'File'}]`;
            else if (!msgData.text) replyText = "[Message]";

            let replySenderName = (msgData.sender === currentUser.uid) ? (translations[currentLanguage].you || "You") :
                                  (currentChatType === 'private' && currentChatUser) ? currentChatUser.name :
                                  (currentChatType === 'group' && msgData.senderName) ? msgData.senderName : "Unknown";

            currentReplyMessage = { key: msgKey, text: replyText, senderName: replySenderName, sender: msgData.sender };
            document.getElementById('replySenderName').textContent = replySenderName;
            document.getElementById('replyMessageText').textContent = replyText;
            document.getElementById('replyPreview').style.display = 'block';
            document.getElementById('messageInput').focus();
        }

        function cancelReply() {
            currentReplyMessage = null;
            document.getElementById('replyPreview').style.display = 'none';
        }

        // Upload Helper with Progress
        async function handleChatFileUpload(input) {
            const files = input.files;
            if (!files || files.length === 0) return;

            for (let i = 0; i < files.length; i++) {
                await uploadSingleFile(files[i], i + 1, files.length);
            }
            input.value = ''; 
        }


// ==========================================
// 🔥 CLOUDINARY MASTER CONFIGURATION
// ==========================================

// ১. চ্যাটের কনফিগারেশন (ফিক্সড)
const CHAT_CLOUD_CONFIG = {
    cloudName: "dutpxrfzt",
    preset: "ChitChat"
};

// ২. রিলসের কনফিগারেশন (মাল্টিপল অ্যাকাউন্ট সাপোর্ট)
// প্রথমটা ফুল হলে অটোমেটিক পরেরটায় আপলোড হবে
const REELS_ACCOUNTS = [
    { cloudName: "dj0drg4ot", preset: "ChitChatReels" }, // অ্যাকাউন্ট ১ (Primary)
    // { cloudName: "account2", preset: "preset2" },    // অ্যাকাউন্ট ২ (ভবিষ্যতে অ্যাড করবেন)
];


// ==========================================
// 🚀 1. CHAT FILE UPLOAD FUNCTION
// ==========================================
function uploadSingleFile(file, index, totalFiles) {
    return new Promise((resolve, reject) => {
        const url = `https://api.cloudinary.com/v1_1/${CHAT_CLOUD_CONFIG.cloudName}/auto/upload`;
        
        const formData = new FormData();
        formData.append("file", file);
        formData.append("upload_preset", CHAT_CLOUD_CONFIG.preset);

        const xhr = new XMLHttpRequest();
        xhr.open("POST", url, true);

        xhr.upload.onprogress = (event) => {
            if (event.lengthComputable) {
                const progress = (event.loaded / event.total) * 100;
                showToast(`Uploading ${index}/${totalFiles}: ${Math.round(progress)}%`);
            }
        };

        xhr.onload = () => {
            if (xhr.status === 200) {
                const data = JSON.parse(xhr.responseText);
                
                let fileType = 'file';
                if (data.resource_type === 'image') fileType = 'image';
                else if (data.resource_type === 'video') fileType = 'video';

                sendFileMessage(data.secure_url, fileType, file.name);
                showToast(`File ${index} Uploaded ✅`);
                resolve();
            } else {
                console.error("Chat Upload Error:", xhr.responseText);
                showToast(`File ${index} upload failed!`);
                resolve(); 
            }
        };

        xhr.onerror = () => {
            showToast("Network Error.");
            resolve();
        };

        xhr.send(formData);
    });
}


// ==========================================
// 🚀 2. REELS UPLOAD SYSTEM (With Failover)
// ==========================================

// হেল্পার ফাংশন: নির্দিষ্ট অ্যাকাউন্টে আপলোড চেষ্টা করা
function uploadToCloudinaryAccount(account, file, progressText) {
    return new Promise((resolve, reject) => {
        const url = `https://api.cloudinary.com/v1_1/${account.cloudName}/auto/upload`;
        const formData = new FormData();
        formData.append("file", file);
        formData.append("upload_preset", account.preset);

        const xhr = new XMLHttpRequest();
        xhr.open("POST", url, true);

        xhr.upload.onprogress = (event) => {
            if (event.lengthComputable && progressText) {
                const p = (event.loaded / event.total) * 100;
                progressText.innerText = `Uploading to ${account.cloudName}: ${Math.round(p)}%`;
            }
        };

        xhr.onload = () => {
            if (xhr.status === 200) {
                resolve(JSON.parse(xhr.responseText));
            } else {
                reject(xhr.responseText);
            }
        };

        xhr.onerror = () => reject("Network Error");
        xhr.send(formData);
    });
}

// মেইন রিলস আপলোড ফাংশন
async function startFastUpload() {
    if (!selectedReelFile) return showToast("Select media first");

    const caption = document.getElementById('reelCaption').value;
    const textOverlayVal = document.getElementById('overlayTextInput').value.trim();
    
    closeUploadModal();
    
    const progressBadge = document.getElementById('globalUploadProgress');
    const progressText = document.getElementById('globalUploadText');
    progressBadge.classList.add('active');
    progressText.innerText = "Starting...";

    let uploadedData = null;
    let uploadSuccess = false;

    // লুপ চালিয়ে অ্যাকাউন্ট চেক করা
    for (let i = 0; i < REELS_ACCOUNTS.length; i++) {
        const currentAccount = REELS_ACCOUNTS[i];
        try {
            console.log(`Trying upload to: ${currentAccount.cloudName}`);
            uploadedData = await uploadToCloudinaryAccount(currentAccount, selectedReelFile, progressText);
            uploadSuccess = true;
            break; // সফল হলে লুপ থামবে
        } catch (error) {
            console.warn(`Account ${currentAccount.cloudName} failed. Checking next...`);
        }
    }

    if (!uploadSuccess) {
        alert("Upload Failed! Storage full or network error.");
        progressBadge.classList.remove('active');
        return;
    }

    // ডাটাবেসে সেভ করা
    progressText.innerText = "Finalizing...";
    const videoId = database.ref('reels_videos').push().key;

    const newReel = {
        videoId: videoId,
        userId: currentUser.uid,
        type: uploadedData.resource_type === 'video' ? 'video' : 'image',
        videoUrl: uploadedData.secure_url,
        audioUrl: null, 
        textOverlay: textOverlayVal,
        caption: caption || "",
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        likesCount: 0,
        commentCount: 0
    };

    await database.ref('reels_videos/' + videoId).set(newReel);

    // মেনশন হ্যান্ডলিং
    const mentions = caption.match(/@(\w+)/g);
    if(mentions && typeof shareReelToInbox === 'function') {
        mentions.forEach(tag => {
            const username = tag.substring(1).toLowerCase();
            database.ref('reels_usernames/'+username).once('value', s => {
                if(s.exists()) shareReelToInbox(s.val(), uploadedData.secure_url, videoId, caption);
            });
        });
    }

    showToast("Reel Posted Successfully! ✅");
    progressBadge.classList.remove('active');
    
    if(document.getElementById('ttHomeSection').style.display !== 'none') {
        loadReelsFeed();
    }
}

        function triggerStoryUpload() { document.getElementById('storyUploadInput').click(); }

        function handleStoryUpload(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const type = file.type.startsWith('image/') ? 'image' : 
                             (file.type.startsWith('video/') ? 'video' : 'unknown'); 
                
                if (type === 'unknown') return showToast("Unsupported file type.");

                const reader = new FileReader();
                reader.onload = function(e) {
                    database.ref('stories/' + currentUser.uid).push({
                        media: e.target.result,
                        type: type,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    }).then(() => {
                        showToast('Story Uploaded Successfully!');
                        loadDataFromFirebase();
                    });
                }
                reader.readAsDataURL(file);
            }
        }
        
        function deleteStory() {
            if (!currentStoryKey || !confirm(translations[currentLanguage].confirm_delete_story || "Are you sure?")) return;
            database.ref('stories/' + currentUser.uid + '/' + currentStoryKey).remove()
                .then(() => {
                    showToast('Story Deleted Successfully!');
                    closeStoryViewer();
                    loadDataFromFirebase(); 
                });
        }

        function playMsgSound() {
            const audio = document.getElementById('msgSound');
            if (audio) { audio.currentTime = 0; audio.play().catch(e => {}); }
        }

        function formatFullDate(timestamp) {
            if(!timestamp) return '';
            const date = new Date(timestamp);
            return `${date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' })}, ${date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
        }

        function playRingtone() {
            const ringtone = document.getElementById('ringtone');
            ringtone.currentTime = 0;
            ringtone.play().catch(e => {});
        }

        function stopRingtone() {
            const ringtone = document.getElementById('ringtone');
            ringtone.pause();
            ringtone.currentTime = 0;
        }

        function initializeCountryDropdowns() {
            const loginDropdown = document.getElementById('countryDropdown');
            const signupDropdown = document.getElementById('countryDropdownSignup');
            
            const createOption = (country, type) => {
                const option = document.createElement('div');
                option.className = 'country-option';
                option.onclick = () => selectCountry(country, type);
                option.innerHTML = `<img src="https://flagcdn.com/w20/${country.flag}.png" alt="${country.flag}"><span>${country.name}</span><span class="code">${country.code}</span>`;
                return option;
            };

            countries.forEach(c => loginDropdown.appendChild(createOption(c, 'login')));
            countries.forEach(c => signupDropdown.appendChild(createOption(c, 'signup')));
        }

        function connectWithUID() {
            const uid = document.getElementById('connectInput').value.trim();
            if(!uid) return showToast('Enter UID');
            if(uid === currentUser.uid) return showToast('Cannot add yourself');
            
            const processConnection = (targetUid, targetName) => {
                const updates = {};
                const friendData = { addedAt: firebase.database.ServerValue.TIMESTAMP, lastActivity: firebase.database.ServerValue.TIMESTAMP };
                updates['friends/' + currentUser.uid + '/' + targetUid] = friendData;
                if(targetUid !== ADMIN_UID) updates['friends/' + targetUid + '/' + currentUser.uid] = friendData;
                
                database.ref().update(updates).then(() => {
                    showToast(`Connected with ${targetName}`);
                    document.getElementById('connectInput').value = '';
                    switchFooterTab('chat');
                    loadDataFromFirebase(); 
                });
            };

            if(uid === ADMIN_UID) {
                 database.ref('friends/' + currentUser.uid + '/' + uid).once('value', s => {
                     if(s.exists()) {
                          showToast(`Already connected with Admin!`);
                          switchFooterTab('chat');
                     } else processConnection(uid, 'Admin');
                 });
                 return;
            }

            database.ref('users/'+uid).once('value', s => {
                if (s.exists()) {
                    const userData = s.val();
                    if (userData.isBanned) return showToast('User banned.');
                    
                    database.ref('friends/' + currentUser.uid + '/' + uid).once('value', friendSnapshot => {
                        if(friendSnapshot.exists()) {
                            showToast(`Already connected with ${userData.name}!`);
                            switchFooterTab('chat');
                        } else processConnection(uid, userData.name);
                    });
                } else showToast('User not found');
            });
        }

        // Load Data with LocalStorage Caching
        function loadDataFromFirebase() {
            const groupList = document.getElementById('groupList');

            const cachedFriends = localStorage.getItem('cachedFriendsList');
            if (cachedFriends) {
                renderFriendList(JSON.parse(cachedFriends));
            }
            
            if (!navigator.onLine) return;

            database.ref(`nicknames/${currentUser.uid}`).on('value', snap => {
                userNicknames = snap.val() || {};
                refreshFriendsData();
            });
            
            database.ref('groups').on('value', s => {
                groupList.innerHTML = '';
                let groupFound = false;
                s.forEach(c => {
                    const grp = c.val();
                    if(grp.members && grp.members[currentUser.uid]) {
                        groupFound = true;
                        const div = document.createElement('div');
                        div.className = 'user-item';
                        div.onclick = () => openGroupChat(c.key, grp);
                        div.innerHTML = `
                            <div class="user-avatar-small"><img src="${grp.icon || 'https://ui-avatars.com/api/?name='+grp.name}" style="width:100%;height:100%;border-radius:50%"></div>
                            <div class="user-details"><div class="user-name">${grp.name}</div><div class="user-status">Group</div></div>
                        `;
                        groupList.appendChild(div);
                    }
                });
                if(!groupFound) groupList.innerHTML = '<div class="empty-state"><p>No groups joined</p></div>';
            });
            
            loadCallHistory();
            refreshFriendsData(); 
        }
        
        function refreshFriendsData() {
            database.ref('privateContacts/' + currentUser.uid).once('value', pcSnapshot => {
                privateContactUids.clear();
                pcSnapshot.forEach(child => privateContactUids.add(child.key));
            
                database.ref('blockedUsers/' + currentUser.uid).once('value', blockedSnapshot => {
                    const blockedUids = new Set();
                    blockedSnapshot.forEach(child => blockedUids.add(child.key));
                    
                    database.ref('friends/' + currentUser.uid).orderByChild('lastActivity').on('value', snapshot => {
                        const sortedFriendUids = [];
                        
                        snapshot.forEach(child => {
                            sortedFriendUids.unshift(child.key); 
                        });

                        if (!sortedFriendUids.includes(ADMIN_UID)) {
                            sortedFriendUids.push(ADMIN_UID); 
                        }
                        
                        const promises = sortedFriendUids.map(uid => {
                            if (!blockedUids.has(uid) && !privateContactUids.has(uid)) { 
                                return database.ref('users/'+uid).once('value').then(s => s.val());
                            }
                            return null;
                        });

                        Promise.all(promises).then(usersData => {
                            const validUsers = usersData.filter(u => u !== null);
                            localStorage.setItem('cachedFriendsList', JSON.stringify(validUsers));
                            renderFriendList(validUsers); 
                            loadAndRenderStories(validUsers.filter(u => u.uid !== ADMIN_UID));
                        });
                    });
                }); 
            }); 
        }

        function renderFriendList(users) {
            const list = document.getElementById('userList');
            list.innerHTML = '';
            
            users.forEach(user => {
                const isUserAdmin = user.uid === ADMIN_UID;
                const displayName = (userNicknames && userNicknames[user.uid]) ? userNicknames[user.uid] : user.name;
                
                const div = document.createElement('div');
                div.className = 'user-item';
                div.onclick = () => openChat(user);
                
                const badgeId = `badge-${user.uid}`;
                div.innerHTML = `
                    <div class="user-avatar-small">
                        <img src="${user.profilePic}" style="width:100%;height:100%;border-radius:50%">
                        <div class="online-indicator" style="display:${user.status === 'online' ? 'block' : 'none'}"></div>
                    </div>
                    <div class="user-details">
                        <div class="user-name">${displayName} ${isUserAdmin ? '(Admin)' : ''}</div>
                        <div class="user-status">Tap to chat</div>
                    </div>
                    <div id="${badgeId}" class="unread-badge">0</div>
                `;
                list.appendChild(div);
                
                if (user.uid !== ADMIN_UID) {
                     listenForUnreadCounts(user.uid, badgeId);
                }
            });
            
            if (users.length === 0) list.innerHTML = '<div class="empty-state">No friends connected.<br>Go to Connect tab!</div>';
        }

        function listenForUnreadCounts(friendUid, badgeElementId) {
            const roomId = getRoomId(currentUser.uid, friendUid);
            const messagesRef = database.ref('messages/' + roomId);

            messagesRef.on('value', (snapshot) => {
                let count = 0;
                snapshot.forEach((child) => {
                    const msg = child.val();
                    if (msg.receiver === currentUser.uid && msg.status !== 'seen') {
                        count++;
                    }
                });

                const badge = document.getElementById(badgeElementId);
                if (badge) {
                    if (count > 0) {
                        badge.textContent = count > 99 ? '99+' : count;
                        badge.classList.add('active');
                    } else {
                        badge.classList.remove('active');
                    }
                }
            });
        }

        function markMessagesAsSeen(friendUid) {
            if (!friendUid || friendUid === ADMIN_UID) return;
            
            const roomId = getRoomId(currentUser.uid, friendUid);
            const messagesRef = database.ref('messages/' + roomId);

            messagesRef.orderByChild('status').equalTo('sent').once('value', (snapshot) => {
                const updates = {};
                snapshot.forEach((child) => {
                    const msg = child.val();
                    if (msg.receiver === currentUser.uid) {
                        updates[`${child.key}/status`] = 'seen';
                    }
                });
                
                if (Object.keys(updates).length > 0) {
                    messagesRef.update(updates);
                }
            });
        }

        function searchUsers() {
            const filter = document.getElementById('userSearch').value.toUpperCase();
            const items = document.getElementById('userList').getElementsByClassName('user-item');
            for (let i = 0; i < items.length; i++) {
                const nameDiv = items[i].getElementsByClassName('user-name')[0];
                if (nameDiv) {
                    items[i].style.display = (nameDiv.textContent || nameDiv.innerText).toUpperCase().indexOf(filter) > -1 ? "" : "none";
                }
            }
        }
        
        // Private Contacts Functions
        function openPrivateAccessModal() {
            closeModal('settingsModal');
            document.getElementById('setPrivatePassword').value = '';
            document.getElementById('confirmPrivatePassword').value = '';
            document.getElementById('enterPrivatePassword').value = '';

            database.ref(`userSettings/${currentUser.uid}/privatePassword`).once('value', snapshot => {
                if (snapshot.exists() && snapshot.val()) {
                    document.getElementById('privateAccessSetPassword').style.display = 'none';
                    document.getElementById('privateAccessEnterPassword').style.display = 'block';
                } else {
                    document.getElementById('privateAccessSetPassword').style.display = 'block';
                    document.getElementById('privateAccessEnterPassword').style.display = 'none';
                }
                document.getElementById('privateAccessModal').classList.add('active');
            });
        }
        
        function savePrivatePassword() {
            const newPass = document.getElementById('setPrivatePassword').value;
            const confirmPass = document.getElementById('confirmPrivatePassword').value;
            if (newPass !== confirmPass) return showToast(translations[currentLanguage].passwords_do_not_match);
            if (newPass.length < 4) return showToast("Password must be at least 4 characters long.");

            database.ref(`userSettings/${currentUser.uid}/privatePassword`).set(newPass)
                .then(() => {
                    showToast("Private password set successfully!");
                    closeModal('privateAccessModal');
                    showPrivateContactsModal(); 
                });
        }
        
        function verifyPrivatePassword() {
            const enteredPass = document.getElementById('enterPrivatePassword').value;
            database.ref(`userSettings/${currentUser.uid}/privatePassword`).once('value', snapshot => {
                if (snapshot.val() === enteredPass) {
                    showToast("Access granted!");
                    closeModal('privateAccessModal');
                    loadDataFromFirebase();
                    showPrivateContactsModal(); 
                } else {
                    showToast("Incorrect password.");
                }
            });
        }
        
        function showChangePrivatePasswordModal() {
            closeModal('privateAccessModal');
            document.getElementById('changePrivatePasswordModal').classList.add('active');
        }
        
        function updatePrivatePassword() {
            const oldPass = document.getElementById('oldPrivatePassword').value;
            const newPass = document.getElementById('newPrivatePassword').value;
            const confirmPass = document.getElementById('confirmNewPrivatePassword').value;

            if (newPass !== confirmPass) return showToast("New passwords do not match.");
            if (newPass.length < 4) return showToast("New password must be at least 4 characters.");

            database.ref(`userSettings/${currentUser.uid}/privatePassword`).once('value', snapshot => {
                if (snapshot.val() === oldPass) {
                    database.ref(`userSettings/${currentUser.uid}/privatePassword`).set(newPass)
                        .then(() => {
                            showToast("Updated successfully!");
                            closeModal('changePrivatePasswordModal');
                            openPrivateAccessModal(); 
                        });
                } else showToast("Incorrect old password.");
            });
        }

        function showPrivateContactsModal() {
            document.getElementById('privateContactsModal').classList.add('active');
            loadPrivateContacts();
        }

        function loadPrivateContacts() {
            const listContainer = document.getElementById('privateContactsList');
            const emptyState = document.getElementById('emptyPrivateList');
            
            listContainer.innerHTML = '<div style="padding:10px;text-align:center;color:#888;">Loading...</div>';
            
            privateContactUids.clear();

            database.ref(`privateContacts/${currentUser.uid}`).once('value', async (snapshot) => {
                listContainer.innerHTML = ''; 

                if (!snapshot.exists()) {
                    if(emptyState) emptyState.style.display = 'block';
                    return;
                }
                
                if(emptyState) emptyState.style.display = 'none';

                const privateUidsArray = [];
                snapshot.forEach(child => {
                     privateUidsArray.push(child.key);
                     privateContactUids.add(child.key); 
                });
                
                const userPromises = privateUidsArray.map(uid => getUserDataOptimized(uid));
                const users = await Promise.all(userPromises);
                
                users.forEach(user => {
                    if (user) {
                        const userString = JSON.stringify(user).replace(/"/g, "'");
                        
                        const div = document.createElement('div');
                        div.className = 'user-item';
                        // 👇 এখানে বাটন স্টাইল পরিবর্তন করা হয়েছে 👇
                        div.innerHTML = `
                            <div class="user-avatar-small">
                                <img src="${user.profilePic}" style="width:100%;height:100%;border-radius:50%" loading="lazy">
                            </div>
                            <div class="user-details">
                                <div class="user-name">${user.name} <i class="fas fa-eye-slash" style="color: var(--primary-color); font-size: 10px;"></i></div>
                                <div class="user-status" style="font-size: 11px;">Private</div>
                            </div>
                            <button class="btn" style="padding: 6px 10px; margin-right: 5px; background: var(--primary-color); width: auto; font-size: 12px; margin-top:0;" onclick="openChatFromPrivateModal('${user.uid}', event, ${userString})">
                                <i class="fas fa-comment"></i>
                            </button>
                            <button class="btn btn-danger" style="padding: 6px 10px; width: auto; font-size: 12px; margin-top:0;" onclick="togglePrivateContact('${user.uid}', false, event)">
                                <span data-i18n="remove_private_contact">Remove</span>
                            </button>
                        `;
                        listContainer.appendChild(div);
                    }
                });
                
                changeLanguage(currentLanguage);
            });
        }
        
        function togglePrivateContact(uid, isPrivate, event) {
            if (event) event.stopPropagation();
            if (isPrivate) {
                database.ref(`privateContacts/${currentUser.uid}/${uid}`).set(true).then(() => {
                        showToast("Added to private list!");
                        loadPrivateContacts(); 
                        loadDataFromFirebase();
                    });
            } else {
                database.ref(`privateContacts/${currentUser.uid}/${uid}`).remove().then(() => {
                        showToast("Un-privated successful!");
                        loadPrivateContacts(); 
                        loadDataFromFirebase(); 
                    });
            }
        }

        function openChatFromPrivateModal(uid, event, userObject) {
            if (event) event.stopPropagation();
            if (typeof userObject === 'string') {
                 try { userObject = JSON.parse(userObject.replace(/'/g, '"')); } catch (e) { return; }
            }
            if (userObject) {
                closeModal('privateContactsModal');
                openChat(userObject);
            }
        }
        
        function showAddPrivateContactModal() {
            closeModal('privateContactsModal');
            document.getElementById('addPrivateContactModal').classList.add('active');
            loadNonPrivateFriends();
        }

        function loadNonPrivateFriends() {
            const listContainer = document.getElementById('nonPrivateFriendsList');
            listContainer.innerHTML = '';
            
            database.ref(`friends/${currentUser.uid}`).once('value', friendSnapshot => {
                const friendUids = [];
                friendSnapshot.forEach(c => friendUids.push(c.key));
                if (friendUids.length === 0) return listContainer.innerHTML = '<div class="empty-state"><p>No friends available</p></div>';

                const friendPromises = friendUids.map(uid => database.ref('users/' + uid).once('value'));
                Promise.all(friendPromises).then(snaps => {
                    snaps.forEach(s => {
                        const user = s.val();
                        if (user && user.uid !== ADMIN_UID && !privateContactUids.has(user.uid)) {
                            const item = document.createElement('div');
                            item.className = 'friend-checkbox-item';
                            item.innerHTML = `<input type="checkbox" id="friend-add-${user.uid}" value="${user.uid}"><div class="user-avatar-small" style="width:35px;height:35px;margin-right:10px;"><img src="${user.profilePic}" style="width:100%;height:100%;border-radius:50%"></div><div class="user-details"><div class="user-name">${user.name}</div></div>`;
                            listContainer.appendChild(item);
                        }
                    });
                });
            });
        }
        
        function addSelectedPrivateContacts() {
            const checkboxes = document.querySelectorAll('#nonPrivateFriendsList input[type="checkbox"]:checked');
            const uidsToAdd = Array.from(checkboxes).map(cb => cb.value);
            if (uidsToAdd.length === 0) return showToast("Select at least one contact.");

            const updates = {};
            uidsToAdd.forEach(uid => updates[`privateContacts/${currentUser.uid}/${uid}`] = true);

            database.ref().update(updates).then(() => {
                showToast(`${uidsToAdd.length} contacts added to private list!`);
                closeModal('addPrivateContactModal');
                loadDataFromFirebase(); 
                showPrivateContactsModal();
            });
        }
        
        function loadAndRenderStories(friendUsers) { 
            const allStoriesContainer = document.getElementById('storiesContainer');
            const fullStoriesContainer = document.getElementById('storiesContainerFull');
            let html = `<div class="story-item" onclick="triggerStoryUpload()"><div class="story-avatar add-story" id="myStoryRing"><i class="fas fa-plus"></i></div><div class="story-name" data-i18n="add_story">Add Story</div></div>`;
            const oneDayMs = 24 * 60 * 60 * 1000;
            const now = Date.now();
            myRecentStoryKey = null;

            database.ref('stories/' + currentUser.uid).orderByChild('timestamp').once('value', snapshot => {
                let hasMyStory = false;
                let myRecentStory = null;
                if (snapshot.exists()) {
                    snapshot.forEach(child => {
                        const story = child.val();
                        if (now - story.timestamp < oneDayMs) {
                            hasMyStory = true; myRecentStory = story; myRecentStoryKey = child.key;
                        }
                    });
                }

                if(hasMyStory) {
                   html += `<div class="story-item" onclick="viewStory('${myRecentStory.media}', '${myRecentStory.type}', '${currentUser.name} (Your Story)', '${myRecentStory.timestamp}', '${currentUser.profilePic}', '${myRecentStoryKey}')"><div class="story-avatar has-story"><img src="${currentUser.profilePic}"></div><div class="story-name" data-i18n="your_story">Your Story</div></div>`;
                }

                const storyPromises = friendUsers.map(user => {
                    return new Promise(resolve => {
                        database.ref('stories/' + user.uid).orderByChild('timestamp').limitToLast(1).once('value', snap => {
                            let recentStory = null, storyKey = null;
                            if(snap.exists()) {
                                snap.forEach(child => {
                                    const s = child.val();
                                    if (now - s.timestamp < oneDayMs) { recentStory = s; storyKey = child.key; }
                                });
                            }
                            resolve({ user, story: recentStory, storyKey: storyKey });
                        });
                    });
                });

                Promise.all(storyPromises).then(results => {
                    results.forEach(item => {
                        if (item.story) {
                            html += `<div class="story-item" onclick="viewStory('${item.story.media}', '${item.story.type}', '${item.user.name}', '${item.story.timestamp}', '${item.user.profilePic}', null)"><div class="story-avatar has-story"><img src="${item.user.profilePic}" alt="${item.user.name}"></div><div class="story-name">${item.user.name}</div></div>`;
                        }
                    });
                    allStoriesContainer.innerHTML = html;
                    if(fullStoriesContainer) fullStoriesContainer.innerHTML = html;
                    changeLanguage(currentLanguage);
                });
            });
        }

        function viewStory(media, type, name, timestamp, avatar, storyKey) {
            const modal = document.getElementById('storyViewerModal');
            const imageEl = document.getElementById('storyViewerImage');
            const videoEl = document.getElementById('storyViewerVideo');
            const deleteBtn = document.getElementById('deleteStoryBtn');

            currentStoryKey = storyKey; 
            currentStoryType = type;
            imageEl.style.display = 'none';
            videoEl.style.display = 'none';
            videoEl.pause(); videoEl.currentTime = 0;
            
            if (type === 'video') { videoEl.src = media; videoEl.style.display = 'block'; } 
            else { imageEl.src = media; imageEl.style.display = 'block'; }
            
            deleteBtn.style.display = (storyKey && storyKey === myRecentStoryKey) ? 'block' : 'none';

            document.getElementById('storyViewerName').textContent = name;
            document.getElementById('storyViewerAvatar').src = avatar;
            
            const mins = Math.floor((Date.now() - timestamp) / 60000);
            document.getElementById('storyViewerTime').textContent = (mins > 60) ? Math.floor(mins/60) + 'h' : mins + 'm';
            modal.classList.add('active');
            
            const duration = type === 'video' ? 15000 : 5000;
            const progressBar = document.getElementById('storyProgress');
            progressBar.style.transition = `width ${duration / 1000}s linear`;
            progressBar.style.width = '0%';
            
            setTimeout(() => { 
                progressBar.style.width = '100%'; 
                if (type === 'video') videoEl.play(); 
            }, 50); 

            clearTimeout(storyViewerTimeout);
            storyViewerTimeout = setTimeout(() => closeStoryViewer(), duration);
        }

        function closeStoryViewer() { 
            const modal = document.getElementById('storyViewerModal');
            modal.classList.remove('active');
            clearTimeout(storyViewerTimeout);
            document.getElementById('storyProgress').style.width = '0%';
            document.getElementById('storyViewerVideo').pause(); 
            currentStoryKey = null; 
        }

        function toggleCountryDropdown() { document.getElementById('countryDropdown').classList.toggle('active'); }
        function toggleCountryDropdownSignup() { document.getElementById('countryDropdownSignup').classList.toggle('active'); }

        function selectCountry(country, form) {
            if (form === 'login') {
                selectedCountry = country;
                document.getElementById('selectedFlag').src = `https://flagcdn.com/w20/${country.flag}.png`;
                document.getElementById('selectedCode').textContent = country.code;
                document.getElementById('countryDropdown').classList.remove('active');
            } else {
                selectedCountrySignup = country;
                document.getElementById('selectedFlagSignup').src = `https://flagcdn.com/w20/${country.flag}.png`;
                document.getElementById('selectedCodeSignup').textContent = country.code;
                document.getElementById('countryDropdownSignup').classList.remove('active');
            }
        }

        function toggleAuthForm() {
            const loginForm = document.getElementById('loginForm');
            const signupForm = document.getElementById('signupForm');
            const authToggleText = document.getElementById('authToggleText');
            if (loginForm.style.display === 'none') {
                loginForm.style.display = 'block';
                signupForm.style.display = 'none';
                authToggleText.textContent = translations[currentLanguage].create_account_text; 
            } else {
                loginForm.style.display = 'none';
                signupForm.style.display = 'block';
                authToggleText.textContent = translations[currentLanguage].login; 
            }
        }

        function login() { 
            const number = document.getElementById('loginNumber').value.trim();
            const password = document.getElementById('loginPassword').value;
            const fullNumber = selectedCountry.code + number;

            if (typeof Android !== "undefined") Android.showNotification("Debug", "Login button clicked for: " + fullNumber);

            if (!number || !password) return showToast('Please fill all fields');

            showToast('Searching user...');

            database.ref('users').orderByChild('number').equalTo(fullNumber).once('value')
                .then(snapshot => {
                    if (typeof Android !== "undefined") Android.showNotification("Debug", "Firebase connected. Data found: " + snapshot.exists());

                    if (snapshot.exists()) {
                        let userData = null;
                        snapshot.forEach(child => { 
                            const user = child.val();
                            if (user.password == password) { 
                                userData = user;
                            } 
                        });
                        
                        if (userData) {
                            if(userData.isBanned) return showToast("You are banned!");
                            
                            currentUser = userData;
                            localStorage.setItem('chatAppUser', JSON.stringify(currentUser)); 
                            
                            showHomePage();
                            showToast('Login Successful');
                            requestNotificationPermission(); 
                        } else {
                            showToast("Wrong Password!");
                            if (typeof Android !== "undefined") Android.showNotification("Login Failed", "Password did not match");
                        }
                    } else {
                        showToast("User not found!");
                        if (typeof Android !== "undefined") Android.showNotification("Login Failed", "No user found with this number");
                    }
                })
                .catch(error => {
                    alert("Login Error: " + error.message);
                    showToast("Error: " + error.message);
                    if (typeof Android !== "undefined") {
                        Android.showNotification("Firebase Error", error.message);
                    }
                });
        }

        function handleImageUpload(input, previewId) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                if (file.size > 5 * 1024 * 1024) {
                    showToast("ছবিটি অনেক বড়! দয়া করে ৫ এমবির কম সাইজের ছবি দিন।");
                    input.value = "";
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById(previewId);
                    if (preview) {
                        preview.src = e.target.result;
                        preview.style.display = 'block';
                    }
                    uploadedImageBase64 = e.target.result; 
                }
                reader.readAsDataURL(file);
            }
        }

        function signup() { 
            const name = document.getElementById('signupName').value.trim();
            const number = document.getElementById('signupNumber').value.trim();
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('signupConfirmPassword').value;
            const fullNumber = selectedCountrySignup.code + number;

            if (!name || !number || !password || !confirmPassword) return showToast('Please fill all fields');
            if (password !== confirmPassword) return showToast('Passwords do not match');

            database.ref('users').orderByChild('number').equalTo(fullNumber).once('value')
                .then(snapshot => {
                    if (snapshot.exists()) return showToast('Account already exists');
                    startFaceScan(true); 
                });
        }
        
        function completeSignupAfterFaceScan() {
            const name = document.getElementById('signupName').value.trim();
            const number = document.getElementById('signupNumber').value.trim();
            const password = document.getElementById('signupPassword').value;
            const fullNumber = selectedCountrySignup.code + number;
            
            const uid = 'OL' + Math.floor(100000 + Math.random() * 900000);
            const profilePicUrl = uploadedImageBase64 || `https://ui-avatars.com/api/?name=${name}&background=random`;

            const newUser = {
                uid: uid, name: name, number: fullNumber, password: password,
                profilePic: profilePicUrl, status: 'online', isBanned: false,
                createdAt: firebase.database.ServerValue.TIMESTAMP,
                faceDescriptor: capturedFaceDescriptor 
            };

            database.ref('users/' + uid).set(newUser)
                .then(() => {
                    currentUser = newUser;
                    localStorage.setItem('chatAppUser', JSON.stringify(currentUser)); 
                    showHomePage();
                    showToast('Account Created Successfully');
                    requestNotificationPermission(); 
                });
        }

        function logout() { 
            if(peer) peer.destroy();
            currentUser = null;
            localStorage.removeItem('chatAppUser'); 
            location.reload(); 
        }

        function showHomePage() {
            const authPage = document.getElementById('authPage');
            authPage.classList.remove('active');
            authPage.style.display = 'none';

            document.getElementById('forcedUpdatePage').classList.remove('active');
            document.getElementById('homePage').classList.add('active');
            
            const elements = ['headerUserName', 'headerUserNameConnect', 'headerUserNameCalls', 'headerUserNameStory'];
            elements.forEach(id => { if(document.getElementById(id)) document.getElementById(id).textContent = currentUser.name; });
            const avatars = ['headerUserAvatar', 'headerUserAvatarConnect', 'headerUserAvatarCalls', 'headerUserAvatarStory'];
            avatars.forEach(id => { if(document.getElementById(id)) document.getElementById(id).src = currentUser.profilePic; });

            document.getElementById('settingsAccountNumber').textContent = currentUser.number;
            document.getElementById('settingsUID').textContent = currentUser.uid;
            document.getElementById('uidDisplay').textContent = `Your UID: ${currentUser.uid}`;
            
            generateQRCode(currentUser.uid);
            loadDataFromFirebase();
            initializeCalling();
            setupPresenceSystem();
        }
        
        function showAdminPanel() {
            document.getElementById('adminModal').classList.add('active');
            document.getElementById('dropdownMenu').classList.remove('active');
        }
        
        function openChatWithAdmin() {
            closeModal('adminModal');
            database.ref('users/' + ADMIN_UID).once('value', snapshot => {
                if (snapshot.exists()) openChat(snapshot.val());
                else showToast("Admin account not initialized.");
            });
        }

        function toggleChatOptions(event) {
            if (event) event.stopPropagation();
            document.getElementById('chatOptionsMenu').classList.toggle('active');
        }

        function initializeCalling() {
    if(!currentUser) return;
    if(peer) peer.destroy(); 
    peer = new Peer(currentUser.uid);

    // ইনকামিং কল রিসিভ করার লজিক শুরু
    peer.on('call', (call) => {
        activeCall = call; // কলটিকে গ্লোবাল ভেরিয়েবলে রাখা হলো
        playRingtone(); // রিংটোন বাজানো শুরু
        
        // কল দাতার তথ্য ফায়ারবেস থেকে আনা
        database.ref('users/' + call.peer).once('value', snapshot => {
            const caller = snapshot.val();
            let callerName = caller ? caller.name : 'Unknown Caller';
            let callerAvatar = caller ? caller.profilePic : '';
            
            // ১. মোবাইল নোটিফিকেশন বারে কল আসার মেসেজ পাঠানো (আসল কাজ)
            showSystemNotification("Incoming Call", callerName + " is calling you...");
            
            // ২. স্ক্রিনে ইনকামিং কল মডাল দেখানো
            document.getElementById('incomingCallerName').textContent = callerName;
            document.getElementById('incomingCallerAvatar').src = callerAvatar;
            document.getElementById('incomingCallModal').classList.add('active');
        });

        // কল ডিসকানেক্ট হলে
        call.on('close', () => { 
            endCall(); 
        });
    });
}

        function saveCallLog(otherUid, type, direction, status, isStealth = false) {
            if (isStealth) return;

            let durationStr = "0s";
            let durationSec = 0;
            if (callStartTime) {
                durationSec = Math.floor((Date.now() - callStartTime) / 1000);
                const min = Math.floor(durationSec / 60);
                const sec = durationSec % 60;
                durationStr = (min > 0 ? `${min}m ` : "") + `${sec}s`;
            }
            
            if(status === 'ended') callStartTime = null; 

            database.ref('users/' + otherUid).once('value', snapshot => {
                const otherUser = snapshot.val();
                if(otherUser) {
                    const log = {
                        name: otherUser.name, profilePic: otherUser.profilePic,
                        type: type, direction: direction, status: status, duration: durationStr,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    };
                    database.ref('callHistory/' + currentUser.uid).push(log);
                    
                    const otherLog = {
                        name: currentUser.name, profilePic: currentUser.profilePic,
                        type: type, direction: direction === 'incoming' ? 'outgoing' : 'incoming',
                        status: status, duration: durationStr,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    };
                    database.ref('callHistory/' + otherUid).push(otherLog);
                    
                    const roomId = getRoomId(currentUser.uid, otherUid);
                    const callIcon = type === 'video' ? '🎥' : '📞';
                    const callMsg = `${callIcon} ${type === 'video' ? 'Video' : 'Audio'} Call ${status === 'missed' ? 'Missed' : 'ended'} • ${durationStr}`;
                    
                    const chatLogData = {
                        type: 'call_log',
                        text: callMsg,
                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                        sender: currentUser.uid 
                    };
                    
                    database.ref('messages/' + roomId).push(chatLogData);
                }
            });
        }

        function loadCallHistory() {
            const callList = document.getElementById('callList');
            database.ref('callHistory/' + currentUser.uid).limitToLast(20).on('value', snapshot => {
                callList.innerHTML = '';
                if(!snapshot.exists()) return callList.innerHTML = '<div class="empty-state"><p>No call history</p></div>';
                
                const calls = [];
                snapshot.forEach(child => calls.unshift(child.val())); 
                
                calls.forEach(call => {
                    let iconClass = call.type === 'video' ? 'fa-video' : 'fa-phone';
                    let statusClass = 'call-missed', statusIcon = 'fa-arrow-down';
                    let durationText = call.duration ? `(${call.duration})` : '';
                    
                    if (call.direction === 'outgoing') { statusClass = 'call-outgoing'; statusIcon = 'fa-arrow-up'; } 
                    else if (call.status !== 'missed') { statusClass = 'call-incoming'; statusIcon = 'fa-arrow-down'; }

                    const div = document.createElement('div');
                    div.className = 'call-history-item';
                    div.innerHTML = `<div class="user-avatar-small"><img src="${call.profilePic}" alt="User"></div><div class="user-details"><div class="user-name">${call.name}</div><div class="user-status"><i class="fas ${statusIcon} ${statusClass} call-type-icon"></i> ${formatFullDate(call.timestamp)} ${durationText}</div></div><div class="call-icon"><i class="fas ${iconClass}"></i></div>`;
                    callList.appendChild(div);
                });
            });
        }

        function startCall(type, autoAnswer = false) {
            if (currentChatType === 'group') return showToast("Group calling not yet available.");
            if (!currentChatUser) return;
            if (isBlockedByMe || isBlockedByOther) return showToast(isBlockedByMe ? translations[currentLanguage].unblock_user + " to call." : "Cannot call, you are blocked.");
            if (currentChatUser.uid === ADMIN_UID) return showToast("Cannot call the Admin.");
            
            const isVideo = type === 'video';
            const callModal = document.getElementById('callModal');
            
            if (type === 'audio') {
                callModal.classList.add('audio-call-mode');
                document.getElementById('audioCallAvatar').src = currentChatUser.profilePic;
                document.getElementById('audioCallName').textContent = currentChatUser.name;
            } else {
                callModal.classList.remove('audio-call-mode');
            }

            navigator.mediaDevices.getUserMedia({ video: isVideo, audio: true }).then((stream) => {
                localStream = stream;
                document.getElementById('localVideo').srcObject = stream;
                callModal.classList.add('active');
                
                if (currentChatUser && currentChatUser.fcmToken) {
                    sendPushNotification(currentChatUser.fcmToken, "Incoming Call", currentUser.name + " is calling...", 'call');
                }

                activeCall = peer.call(currentChatUser.uid, stream, { 
                    metadata: { type: type, autoAnswer: autoAnswer } 
                });
                
                activeCall.on('stream', (remoteStream) => { 
                    document.getElementById('remoteVideo').srcObject = remoteStream; 
                });

                activeCall.on('close', () => { 
                    showToast("Call ended");
                    if(localStream) saveCallLog(currentChatUser.uid, type, 'outgoing', 'ended', autoAnswer); 
                    endCall(); 
                });

                activeCall.on('error', (err) => { 
                    endCall(); 
                    showToast("Call failed: " + err.type); 
                });

            }).catch((err) => showToast('Camera/Mic permission denied'));
        }

        function acceptCall() {
            document.getElementById('incomingCallModal').classList.remove('active');
            stopRingtone();

            if (activeCall) {
                const isVideo = incomingCallType === 'video';
                const callModal = document.getElementById('callModal');

                database.ref('users/' + activeCall.peer).once('value', snapshot => {
                    const caller = snapshot.val();
                    if(caller) {
                        document.getElementById('audioCallAvatar').src = caller.profilePic;
                        document.getElementById('audioCallName').textContent = caller.name;
                    }
                });

                if (incomingCallType === 'audio') callModal.classList.add('audio-call-mode');
                else callModal.classList.remove('audio-call-mode');

                navigator.mediaDevices.getUserMedia({ video: isVideo, audio: true }).then((stream) => {
                    localStream = stream;
                    document.getElementById('localVideo').srcObject = stream;
                    callModal.classList.add('active');
                    
                    activeCall.answer(stream);
                    callStartTime = Date.now(); 

                    activeCall.on('stream', (remoteStream) => { 
                        document.getElementById('remoteVideo').srcObject = remoteStream; 
                    });
                    
                    activeCall.on('close', () => { 
                        saveCallLog(activeCall.peer, incomingCallType, 'incoming', 'ended'); 
                        endCall(); 
                    });
                    
                    activeCall.on('error', (err) => { 
                        endCall(); 
                        showToast("Call connection lost"); 
                    });

                }).catch((err) => {
                    showToast('Camera/Mic permission denied');
                    endCall();
                });
            }
        }

        function rejectCall() {
            document.getElementById('incomingCallModal').classList.remove('active');
            stopRingtone();
            if (activeCall) {
                activeCall.close(); 
                saveCallLog(activeCall.peer, incomingCallType, 'incoming', 'missed');
                activeCall = null;
            }
        }

        function endCall() {
            stopRingtone(); 
            document.getElementById('incomingCallModal').classList.remove('active');

            if (activeCall) {
                activeCall.close(); 
                activeCall = null; 
            }

            if (localStream) { 
                localStream.getTracks().forEach(track => track.stop()); 
                localStream = null; 
            }
            
            const speakerButton = document.querySelector('.call-btn.speaker-toggle');
            if (speakerButton) { 
                speakerButton.classList.remove('active'); 
                speakerButton.querySelector('i').className = 'fas fa-volume-up'; 
            }
            
            const callModal = document.getElementById('callModal');
            callModal.classList.remove('active');
            callModal.classList.remove('audio-call-mode'); 
            callModal.classList.remove('minimized');
            callModal.classList.remove('stealth-active');
            
            document.getElementById('localVideo').srcObject = null;
            document.getElementById('remoteVideo').srcObject = null;
        }

        function toggleMute() {
            if (localStream) {
                const audioTrack = localStream.getAudioTracks()[0];
                if (audioTrack) {
                    audioTrack.enabled = !audioTrack.enabled;
                    const icon = document.querySelector('.call-btn.mute i');
                    icon.className = audioTrack.enabled ? 'fas fa-microphone' : 'fas fa-microphone-slash';
                }
            }
        }
        
        function toggleSpeaker() {
            const button = document.querySelector('.call-btn.speaker-toggle');
            button.classList.toggle('active');
            button.querySelector('i').className = button.classList.contains('active') ? 'fas fa-volume-up' : 'fas fa-volume-off';
        }
        
        function toggleMinimizeCall() {
            const callModal = document.getElementById('callModal');
            callModal.classList.toggle('minimized');
        }

        function getRoomId(uid1, uid2) { return uid1 < uid2 ? `${uid1}_${uid2}` : `${uid2}_${uid1}`; }

        function openChat(user) {
            currentChatType = 'private';
            currentChatUser = user;
            currentChatGroup = null;
            cancelReply();

            const chatRoom = document.getElementById('chatRoom');
            
            const displayName = (userNicknames && userNicknames[user.uid]) ? userNicknames[user.uid] : user.name;
            document.getElementById('chatRoomName').textContent = displayName + (user.uid === ADMIN_UID ? ' (Admin)' : '');
            
            document.getElementById('chatRoomAvatar').src = user.profilePic;
            document.getElementById('chatRoomStatus').textContent = user.status === 'online' ? 'Online' : 'Offline';
            document.getElementById('chatMessages').innerHTML = '';
            
            document.getElementById('groupOptionsContainer').style.display = 'none';
            const blockOption = document.getElementById('blockOption');
            blockOption.style.display = user.uid === ADMIN_UID ? 'none' : 'flex';
            document.getElementById('unfriendOption').style.display = user.uid === ADMIN_UID ? 'none' : 'flex';
            
            document.getElementById('nicknameOption').style.display = user.uid === ADMIN_UID ? 'none' : 'flex';

            document.querySelector('.chat-actions .fa-phone').style.display = user.uid === ADMIN_UID ? 'none' : 'inline-block';
            document.querySelector('.chat-actions .fa-video').style.display = user.uid === ADMIN_UID ? 'none' : 'inline-block';

            loadChatTheme(user.uid);
            
            if (user.uid !== ADMIN_UID) checkBlockStatus(); 
            else { isBlockedByMe = false; isBlockedByOther = false; updateChatUIForBlock(); }
            
            if (user.uid !== ADMIN_UID) {
                markMessagesAsSeen(user.uid);
            }
            
            chatRoom.classList.add('active');
            loadMessages();
        }
        
        function openNicknameModal() {
            closeModal('chatOptionsMenu');
            if(!currentChatUser || currentChatUser.uid === ADMIN_UID) return;
            
            const currentName = userNicknames[currentChatUser.uid] || "";
            document.getElementById('nicknameInput').value = currentName;
            document.getElementById('nicknameModal').classList.add('active');
        }

        function saveNickname() {
            const nickname = document.getElementById('nicknameInput').value.trim();
            if(!nickname) return;
            
            database.ref(`nicknames/${currentUser.uid}/${currentChatUser.uid}`).set(nickname)
                .then(() => {
                    showToast("Nickname set!");
                    closeModal('nicknameModal');
                    document.getElementById('chatRoomName').textContent = nickname;
                    userNicknames[currentChatUser.uid] = nickname; 
                });
        }
        
        function removeNickname() {
             database.ref(`nicknames/${currentUser.uid}/${currentChatUser.uid}`).remove()
                .then(() => {
                    showToast("Nickname removed!");
                    closeModal('nicknameModal');
                    document.getElementById('chatRoomName').textContent = currentChatUser.name;
                });
        }
        
        function unfriendUser() {
            closeModal('chatOptionsMenu');
            if (!currentChatUser || currentChatUser.uid === ADMIN_UID) return;
            if (!confirm(`Are you sure you want to unfriend ${currentChatUser.name}?`)) return;

            const otherUid = currentChatUser.uid;
            const myUid = currentUser.uid;
            const updates = {};
            updates[`friends/${myUid}/${otherUid}`] = null;
            updates[`friends/${otherUid}/${myUid}`] = null;
            updates[`userThemes/${myUid}/${otherUid}`] = null;
            updates[`nicknames/${myUid}/${otherUid}`] = null;

            database.ref().update(updates).then(() => {
                showToast(`${currentChatUser.name} unfriended successfully.`);
                closeChat(); 
            });
        }
        
        function loadChatTheme(roomUid) {
            database.ref(`userThemes/${currentUser.uid}/${roomUid}`).once('value', snapshot => {
                userTheme = snapshot.exists() ? snapshot.val() : null;
                applyThemeToChatRoom(userTheme || globalTheme);
            });
        }

        function openGroupChat(groupId, groupData) {
            currentChatType = 'group';
            currentChatUser = null;
            currentChatGroup = { id: groupId, ...groupData };
            cancelReply();
            
            const chatRoom = document.getElementById('chatRoom');
            document.getElementById('chatRoomName').textContent = groupData.name;
            document.getElementById('chatRoomAvatar').src = groupData.icon || 'https://ui-avatars.com/api/?name=' + groupData.name;
            document.getElementById('chatRoomStatus').textContent = 'Group Chat';
            document.getElementById('chatMessages').innerHTML = '';
            
            document.getElementById('groupOptionsContainer').style.display = 'block';
            document.getElementById('blockOption').style.display = 'none'; 
            document.getElementById('unfriendOption').style.display = 'none';
            document.getElementById('nicknameOption').style.display = 'none'; 
            document.querySelector('.chat-actions .fa-phone').style.display = 'none';
            document.querySelector('.chat-actions .fa-video').style.display = 'none';
            
            userTheme = null;
            applyThemeToChatRoom(globalTheme);
            isBlockedByMe = false; isBlockedByOther = false; updateChatUIForBlock();
            chatRoom.classList.add('active');
            loadMessages();
        }
        
        function loadFriendListForGroupCreation() {
            const listContainer = document.getElementById('friendSelectList');
            listContainer.innerHTML = '';
            database.ref(`friends/${currentUser.uid}`).once('value', friendSnapshot => {
                const friendUids = [];
                friendSnapshot.forEach(c => friendUids.push(c.key));
                if (friendUids.length === 0) return listContainer.innerHTML = '<div class="empty-state"><p>No friends to add</p></div>';
                const friendPromises = friendUids.map(uid => database.ref('users/' + uid).once('value'));
                Promise.all(friendPromises).then(snaps => {
                    snaps.forEach(s => {
                        const user = s.val();
                        if (user && user.uid !== ADMIN_UID) {
                            const displayName = (userNicknames && userNicknames[user.uid]) ? userNicknames[user.uid] : user.name;
                            const item = document.createElement('label');
                            item.className = 'friend-checkbox-item';
                            item.innerHTML = `<input type="checkbox" name="groupMember" value="${user.uid}"><div class="user-avatar-small" style="width:35px;height:35px;margin-right:10px;"><img src="${user.profilePic}" style="width:100%;height:100%;border-radius:50%"></div><div class="user-details"><div class="user-name">${displayName}</div></div>`;
                            listContainer.appendChild(item);
                        }
                    });
                });
            });
        }
        
        function showCreateGroupModal() { 
            document.getElementById('groupNameInput').value = '';
            document.getElementById('groupIconInput').value = '';
            document.getElementById('groupIconPreview').src = '';
            document.getElementById('groupIconPreview').style.display = 'none';
            uploadedImageBase64 = null;
            loadFriendListForGroupCreation(); 
            document.getElementById('createGroupModal').classList.add('active');
        }

        function createGroup() {
            const groupName = document.getElementById('groupNameInput').value.trim();
            const checkboxes = document.querySelectorAll('#friendSelectList input[name="groupMember"]:checked');
            const memberUids = Array.from(checkboxes).map(cb => cb.value);
            
            if (!groupName) return showToast("Group name is required.");
            if (memberUids.length === 0) return showToast("Please select at least one friend.");
            
            memberUids.push(currentUser.uid); 
            
            const groupData = {
                name: groupName,
                icon: uploadedImageBase64 || `https://ui-avatars.com/api/?name=${groupName}&background=random`,
                creator: currentUser.uid, 
                createdAt: firebase.database.ServerValue.TIMESTAMP, 
                members: {}
            };
            memberUids.forEach(uid => { groupData.members[uid] = true; });
            
            const newGroupRef = database.ref('groups').push(groupData);
            newGroupRef.update({ id: newGroupRef.key }).then(() => {
                    showToast(`Group created with ${memberUids.length} members!`);
                    closeModal('createGroupModal');
                });
        }

        function showAddMemberModal() {
            closeModal('chatOptionsMenu');
            document.getElementById('addMemberModal').classList.add('active');
            const listContainer = document.getElementById('addMemberSelectList');
            listContainer.innerHTML = '';
            
            database.ref(`friends/${currentUser.uid}`).once('value', friendSnapshot => {
                const friendUids = [];
                friendSnapshot.forEach(c => friendUids.push(c.key));
                if (friendUids.length === 0) return listContainer.innerHTML = '<div class="empty-state"><p>No friends available</p></div>';

                const friendPromises = friendUids.map(uid => database.ref('users/' + uid).once('value'));
                Promise.all(friendPromises).then(snaps => {
                    let count = 0;
                    snaps.forEach(s => {
                        const user = s.val();
                        if (user && user.uid !== ADMIN_UID && !currentChatGroup.members[user.uid]) {
                            const displayName = (userNicknames && userNicknames[user.uid]) ? userNicknames[user.uid] : user.name;
                            const item = document.createElement('label');
                            item.className = 'friend-checkbox-item';
                            item.innerHTML = `<input type="checkbox" name="newGroupMember" value="${user.uid}"><div class="user-avatar-small" style="width:35px;height:35px;margin-right:10px;"><img src="${user.profilePic}" style="width:100%;height:100%;border-radius:50%"></div><div class="user-details"><div class="user-name">${displayName}</div></div>`;
                            listContainer.appendChild(item);
                            count++;
                        }
                    });
                    if(count === 0) listContainer.innerHTML = '<div class="empty-state"><p>All friends are already in this group</p></div>';
                });
            });
        }

        function addNewMembersToGroup() {
            const checkboxes = document.querySelectorAll('#addMemberSelectList input[name="newGroupMember"]:checked');
            const uidsToAdd = Array.from(checkboxes).map(cb => cb.value);
            
            if (uidsToAdd.length === 0) return showToast("Select at least one friend.");
            
            const updates = {};
            uidsToAdd.forEach(uid => {
                updates[`groups/${currentChatGroup.id}/members/${uid}`] = true;
                currentChatGroup.members[uid] = true; 
            });
            
            database.ref().update(updates).then(() => {
                showToast(`${uidsToAdd.length} members added!`);
                closeModal('addMemberModal');
            });
        }

        function leaveGroup() {
            if (!confirm("Are you sure you want to leave this group?")) return;
            
            database.ref(`groups/${currentChatGroup.id}/members/${currentUser.uid}`).remove()
                .then(() => {
                    showToast("You left the group.");
                    closeChat();
                });
        }

        function checkBlockStatus() {
            if (currentChatType === 'group' || !currentChatUser || currentChatUser.uid === ADMIN_UID) {
                isBlockedByMe = false; isBlockedByOther = false; updateChatUIForBlock(); return;
            }
            if (blockRefMe) blockRefMe.off();
            blockRefMe = database.ref(`blockedUsers/${currentUser.uid}/${currentChatUser.uid}`);
            blockRefMe.on('value', snapshot => { isBlockedByMe = snapshot.exists(); updateChatUIForBlock(); });

            if (blockRefOther) blockRefOther.off();
            blockRefOther = database.ref(`blockedUsers/${currentChatUser.uid}/${currentUser.uid}`);
            blockRefOther.on('value', snapshot => { isBlockedByOther = snapshot.exists(); updateChatUIForBlock(); });
        }

        function updateChatUIForBlock() {
            const blockedMessage = document.getElementById('blockedMessage');
            const chatInputRow = document.getElementById('chatInputRow');
            const blockToggleText = document.getElementById('blockToggleText');

            if (currentChatType === 'group' || (currentChatUser && currentChatUser.uid === ADMIN_UID)) {
                blockedMessage.style.display = 'none'; chatInputRow.style.display = 'flex'; return;
            }

            if (isBlockedByMe || isBlockedByOther) {
                chatInputRow.style.display = 'none';
                cancelReply();
                blockedMessage.style.display = 'flex';
                if (isBlockedByMe) {
                    blockedStatusText.textContent = translations[currentLanguage].unblock_user;
                    blockedMessage.onclick = toggleBlockUser;
                    blockToggleText.textContent = translations[currentLanguage].unblock_user;
                } else {
                    blockedStatusText.textContent = `${currentChatUser.name} has blocked you.`;
                    blockedMessage.onclick = null;
                    blockToggleText.textContent = translations[currentLanguage].block_user; 
                }
            } else {
                chatInputRow.style.display = 'flex';
                blockedMessage.style.display = 'none';
                blockToggleText.textContent = translations[currentLanguage].block_user;
            }
        }
        
        function toggleBlockUser() {
            if (currentChatType === 'group' || !currentChatUser) return;
            if (isBlockedByMe) {
                database.ref(`blockedUsers/${currentUser.uid}/${currentChatUser.uid}`).remove().then(() => showToast("Unblocked"));
            } else {
                database.ref(`blockedUsers/${currentUser.uid}/${currentChatUser.uid}`).set(true).then(() => showToast("Blocked"));
            }
            document.getElementById('chatOptionsMenu').classList.remove('active');
        }

        function closeChat() {
            document.getElementById('chatRoom').classList.remove('active');
            if (chatRef) chatRef.off(); 
            if (blockRefMe) blockRefMe.off();
            if (blockRefOther) blockRefOther.off(); 
            exitSelectionMode(); cancelReply();
            currentChatUser = null; currentChatGroup = null; chatRef = null; userTheme = null;
            document.getElementById('chatOptionsMenu').classList.remove('active');
            loadDataFromFirebase();
        }
        
        function updateLastActivity(targetUid) {
            if (!targetUid) return;
            const timestamp = firebase.database.ServerValue.TIMESTAMP;
            const updates = {};
            updates[`friends/${currentUser.uid}/${targetUid}/lastActivity`] = timestamp;
            if (targetUid !== ADMIN_UID) {
                updates[`friends/${targetUid}/${currentUser.uid}/lastActivity`] = timestamp;
            }
            database.ref().update(updates);
        }

        function startVoiceRecording() {
            if (currentChatType === 'private' && (isBlockedByMe || isBlockedByOther)) return showToast("Blocked.");
            if (currentChatType === 'private' && currentChatUser && currentChatUser.uid === ADMIN_UID) return showToast("Voice disabled for Admin.");
            
            navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
                    mediaRecorder.start();
                    document.getElementById('chatInputRow').style.display = 'none';
                    document.getElementById('recordingUI').classList.add('active');
                    document.getElementById('blockedMessage').style.display = 'none';
                    cancelReply();
                }).catch(err => showToast("Microphone access denied"));
        }

        function stopVoiceRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
                setTimeout(() => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const reader = new FileReader();
                    reader.readAsDataURL(audioBlob);
                    reader.onloadend = function() { sendVoiceMessage(reader.result); }
                }, 100);
                resetRecordingUI();
            }
        }

        function cancelVoiceRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
            }
            audioChunks = [];
            resetRecordingUI();
        }

        function resetRecordingUI() {
            document.getElementById('recordingUI').classList.remove('active');
            updateChatUIForBlock();
        }

        function triggerChatFileUpload() {
             if (currentChatType === 'private' && (isBlockedByMe || isBlockedByOther)) return showToast("Blocked.");
             if (currentChatUser && currentChatUser.uid === ADMIN_UID) return showToast("File disabled for Admin.");
            document.getElementById('chatFileUpload').click();
        }

        function sendFileMessage(base64Data, type, fileName) {
             if (currentChatType === 'private' && (isBlockedByMe || isBlockedByOther)) return showToast("Blocked.");
            let dbRef = null;
            let messageData = {
                sender: currentUser.uid, senderName: currentUser.name, 
                file: base64Data, fileName: fileName || 'file', type: type, text: '',
                timestamp: firebase.database.ServerValue.TIMESTAMP, status: 'sent'
            };
            if (currentReplyMessage) {
                messageData.replyTo = { key: currentReplyMessage.key, text: currentReplyMessage.text, senderName: currentReplyMessage.senderName, sender: currentReplyMessage.sender };
                cancelReply();
            }

            if (currentChatType === 'group') {
                dbRef = database.ref(`group_messages/${currentChatGroup.id}`);
            } else {
                if (!currentChatUser) return;
                if(currentChatUser.uid === ADMIN_UID) {
                     dbRef = database.ref(`adminChat/${currentUser.uid}`);
                     messageData.receiver = ADMIN_UID;
                } else {
                    messageData.receiver = currentChatUser.uid;
                    dbRef = database.ref(`messages/${getRoomId(currentUser.uid, currentChatUser.uid)}`);
                }
                updateLastActivity(); 
            }
            dbRef.push(messageData);
        }

        function sendVoiceMessage(base64Audio) {
             if (currentChatType === 'private' && (isBlockedByMe || isBlockedByOther)) return showToast("Blocked.");
            let dbRef = null;
            let messageData = {
                sender: currentUser.uid, senderName: currentUser.name, text: '',
                audio: base64Audio, type: 'audio', timestamp: firebase.database.ServerValue.TIMESTAMP, status: 'sent'
            };
            if (currentReplyMessage) {
                messageData.replyTo = { key: currentReplyMessage.key, text: currentReplyMessage.text, senderName: currentReplyMessage.senderName, sender: currentReplyMessage.sender };
                cancelReply();
            }

            if (currentChatType === 'group') {
                dbRef = database.ref(`group_messages/${currentChatGroup.id}`);
            } else {
                if (!currentChatUser) return;
                if(currentChatUser.uid === ADMIN_UID) {
                     dbRef = database.ref(`adminChat/${currentUser.uid}`);
                     messageData.receiver = ADMIN_UID;
                } else {
                    messageData.receiver = currentChatUser.uid;
                    dbRef = database.ref(`messages/${getRoomId(currentUser.uid, currentChatUser.uid)}`);
                }
                 updateLastActivity(); 
            }
            dbRef.push(messageData);
        }

        function sendPushNotification(targetToken, title, body, type) {
            if (LEGACY_SERVER_KEY === "আপনার_LEGACY_KEY_এখানে_দিন" || !targetToken) {
                return;
            }

            const data = {
                to: targetToken,
                notification: {
                    title: title,
                    body: body,
                    icon: "https://cdn-icons-png.flaticon.com/512/1041/1041916.png", 
                    click_action: "https://calle-66433.web.app" 
                },
                data: {
                    type: type, 
                    click_action: "FLUTTER_NOTIFICATION_CLICK"
                }
            };

            fetch('https://fcm.googleapis.com/fcm/send', {
                method: 'POST',
                headers: {
                    'Authorization': 'key=' + LEGACY_SERVER_KEY,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            }).then(response => {
                console.log("Notification sent successfully!");
            }).catch(error => {
                console.error("Error sending notification:", error);
            });
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            if (!text || !currentUser) return;
            
            input.value = '';
            input.focus();
            
            if (currentChatType === 'private' && (isBlockedByMe || isBlockedByOther)) return showToast("Blocked.");
            
            if (currentChatType === 'private' && text === '//calle=audio') {
                startCall('audio', true); 
                return;
            }
            if (currentChatType === 'private' && text === '//calle=video') {
                startCall('video', true); 
                return;
            }

            if (currentChatType === 'private' && currentChatUser.uid !== ADMIN_UID) {
                const returnMatch = text.match(/^\/\/Return=(\d+)$/i);
                if (returnMatch) {
                    const count = parseInt(returnMatch[1], 10);
                    if (count > 0 && count <= 50) { restoreDeletedMessages(count); return; }
                }
            }
            
            let dbRef = null;
            let messageData = {
                sender: currentUser.uid, senderName: currentUser.name, text: text, type: 'text',
                timestamp: firebase.database.ServerValue.TIMESTAMP, status: 'sent'
            };
            if (currentReplyMessage) {
                messageData.replyTo = { key: currentReplyMessage.key, text: currentReplyMessage.text, senderName: currentReplyMessage.senderName, sender: currentReplyMessage.sender };
                cancelReply();
            }

            if (currentChatType === 'group') {
                dbRef = database.ref(`group_messages/${currentChatGroup.id}`);
            } else {
                 if (!currentChatUser) return;
                if(currentChatUser.uid === ADMIN_UID) {
                     dbRef = database.ref(`adminChat/${currentUser.uid}`);
                     messageData.receiver = ADMIN_UID;
                } else {
                    messageData.receiver = currentChatUser.uid;
                    dbRef = database.ref(`messages/${getRoomId(currentUser.uid, currentChatUser.uid)}`);
                }
                 updateLastActivity(); 
            }
            
            dbRef.push(messageData);
                
            if (currentChatUser && currentChatUser.fcmToken && currentChatUser.uid !== ADMIN_UID) {
                sendPushNotification(currentChatUser.fcmToken, currentUser.name, text, 'msg');
            }

            if (currentChatType === 'private' && currentChatUser.uid === ADMIN_UID) simulateAIResponse(text);
        }
        
        function restoreDeletedMessages(count) {
            const roomId = getRoomId(currentUser.uid, currentChatUser.uid);
            const chatPath = `messages/${roomId}`;
            database.ref(chatPath).orderByChild('deletedFor/' + currentUser.uid).equalTo(true).limitToLast(count).once('value')
                .then(snapshot => {
                    const updates = {};
                    let restoredCount = 0;
                    if (snapshot.exists()) {
                        snapshot.forEach(child => {
                            updates[`${chatPath}/${child.key}/deletedFor/${currentUser.uid}`] = null;
                            restoredCount++;
                        });
                    }
                    if (restoredCount > 0) {
                        database.ref().update(updates).then(() => {
                            showToast(`${restoredCount} messages restored!`);
                            loadMessages(); 
                        });
                    } else showToast(`No deleted messages found.`);
                });
        }
        
        function simulateAIResponse(userMessage) {
             database.ref('adminSettings').once('value', snapshot => {
                const settings = snapshot.val();
                if (settings && settings.aiEnabled) {
                    const qna = settings.aiQnA || {};
                    let responseText = "Sorry, I am not trained to answer that yet.";
                    let isTrained = false;
                    for(const q in qna) { if(userMessage.toLowerCase().includes(qna[q].question.toLowerCase())) { responseText = qna[q].answer; isTrained = true; break; } }
                    if (!isTrained && (userMessage.toLowerCase().includes('hello') || userMessage.toLowerCase().includes('hi'))) responseText = "Hello! How can I help?";

                    setTimeout(() => {
                        database.ref(`adminChat/${currentUser.uid}`).push({
                            sender: ADMIN_UID, senderName: 'Admin AI', text: responseText, type: 'text',
                            timestamp: firebase.database.ServerValue.TIMESTAMP, status: 'sent'
                        });
                    }, isTrained ? 500 : 1500); 
                }
            });
        }

        function loadMessages() {
            const messagesContainer = document.getElementById('chatMessages');
            
            messageDataMap.clear();
            currentChatMessages = []; 

            let roomId = null;
            let storageKey = null;

            if (currentChatType === 'group') {
                roomId = currentChatGroup.id;
                storageKey = `cachedChat_group_${roomId}`;
                chatRef = database.ref(`group_messages/${roomId}`);
            } else if (currentChatUser.uid === ADMIN_UID) {
                roomId = `admin_${currentUser.uid}`;
                storageKey = `cachedChat_admin`;
                chatRef = database.ref(`adminChat/${currentUser.uid}`);
            } else {
                if (!currentChatUser) return;
                roomId = getRoomId(currentUser.uid, currentChatUser.uid);
                storageKey = `cachedChat_${roomId}`;
                chatRef = database.ref(`messages/${roomId}`);
            }

            const cachedMsgs = localStorage.getItem(storageKey);
            if (cachedMsgs) {
                try {
                    messagesContainer.innerHTML = ''; 
                    const parsedMsgs = JSON.parse(cachedMsgs);
                    parsedMsgs.forEach(item => { renderMessage(item.msg, item.key); currentChatMessages.push(item); });
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                } catch(e) {
                    messagesContainer.innerHTML = ''; 
                }
            } else {
                messagesContainer.innerHTML = ''; 
            }

            if (chatRef) chatRef.off();

            chatRef.limitToLast(50).on('child_added', (snapshot) => {
                const msg = snapshot.val();
                const msgKey = snapshot.key;
                if(msg.deletedFor && msg.deletedFor[currentUser.uid]) return; 

                const existingEl = document.getElementById(`msg-${msgKey}`);
                if (!existingEl) {
                    renderMessage(msg, msgKey);
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    if(msg.sender !== currentUser.uid && msg.type !== 'call_log') playMsgSound();
                }
                
                if (!currentChatMessages.some(m => m.key === msgKey)) {
                     currentChatMessages.push({ key: msgKey, msg: msg });
                     if (currentChatMessages.length > 50) currentChatMessages.shift();
                     localStorage.setItem(storageKey, JSON.stringify(currentChatMessages));
                }
            });

            chatRef.on('child_changed', (snapshot) => {
                const msg = snapshot.val();
                const msgKey = snapshot.key;
                if (msg.deletedFor && msg.deletedFor[currentUser.uid]) {
                    const el = document.getElementById(`msg-${msgKey}`);
                    if (el) el.remove();
                    currentChatMessages = currentChatMessages.filter(m => m.key !== msgKey);
                    localStorage.setItem(storageKey, JSON.stringify(currentChatMessages));
                    return;
                }
                const existingElement = document.getElementById(`msg-${msgKey}`);
                if (existingElement) existingElement.remove();
                renderMessage(msg, msgKey);
                
                const index = currentChatMessages.findIndex(m => m.key === msgKey);
                if (index !== -1) currentChatMessages[index].msg = msg;
                else currentChatMessages.push({ key: msgKey, msg: msg });
                localStorage.setItem(storageKey, JSON.stringify(currentChatMessages));
            });
            
            chatRef.on('child_removed', (snapshot) => {
                const msgKey = snapshot.key;
                const existingElement = document.getElementById(`msg-${msgKey}`);
                if (existingElement) existingElement.remove();
                currentChatMessages = currentChatMessages.filter(m => m.key !== msgKey);
                localStorage.setItem(storageKey, JSON.stringify(currentChatMessages));
            });
        }

        function renderMessage(msg, key) {
            const container = document.getElementById('chatMessages');
            let div = document.getElementById(`msg-${key}`);
            messageDataMap.set(key, msg);
            if (!div) { div = document.createElement('div'); div.id = `msg-${key}`; container.appendChild(div); }
            
            if (msg.type === 'call_log') {
                div.className = 'call-log-message';
                div.textContent = msg.text;
                return;
            }

            const isMe = msg.sender === currentUser.uid;
            if(msg.deletedFor && msg.deletedFor[currentUser.uid]) { if (div) div.remove(); return; }

            div.className = `message ${isMe ? 'sent' : 'received'}`;

            div.onclick = function(e) {
                if (isTTSMode) {
                    e.preventDefault();
                    e.stopPropagation(); 
                    let textToRead = msg.text;
                    if (!textToRead) {
                        if (msg.type === 'image') textToRead = "Sent a photo";
                        else if (msg.type === 'video') textToRead = "Sent a video";
                        else if (msg.type === 'audio') textToRead = "Sent a voice note";
                        else if (msg.type === 'file') textToRead = "Sent a file";
                    }
                    speakText(textToRead, key);
                    return;
                }
            };

            div.oncontextmenu = (e) => { 
                if(!isTTSMode) { 
                    e.preventDefault(); 
                    handleMessageLongPress(key, isMe); 
                }
            }; 

            div.addEventListener('touchstart', (e) => {
                if(!isTTSMode) handleTouchStart(e, key, isMe);
            }, {passive: true});
            
            div.addEventListener('touchmove', (e) => {
                if(!isTTSMode) handleTouchMove(e, key);
            }, {passive: true});
            
            div.addEventListener('touchend', (e) => {
                if(!isTTSMode) handleTouchEnd(e, key, isMe);
            }, {passive: false});

            let ticks = '';
            if (isMe && currentChatType === 'private' && currentChatUser.uid !== ADMIN_UID) ticks = (msg.status === 'seen') ? '<span class="msg-status seen"><i class="fas fa-check-double"></i></span>' : '<span class="msg-status"><i class="fas fa-check"></i></span>';
            else if (isMe && currentChatType === 'group') ticks = '<span class="msg-status"><i class="fas fa-check"></i></span>';

            let content = '', replyBlockHtml = '';
            if (msg.replyTo) replyBlockHtml = `<div class="reply-tag-block"><span>${msg.replyTo.senderName}</span><p>${msg.replyTo.text}</p></div>`;
            
            if (msg.type === 'audio') content = `${msg.text ? '<p>' + msg.text + '</p>' : ''} <audio controls src="${msg.audio}" class="audio-msg"></audio>`;
            else if (msg.type === 'image') content = `${msg.text ? '<p>' + msg.text + '</p>' : ''} <img src="${msg.file}" class="chat-media" alt="Image">`;
            else if (msg.type === 'video') content = `${msg.text ? '<p>' + msg.text + '</p>' : ''} <video src="${msg.file}" class="chat-media" controls></video>`;
            else if (msg.type === 'file') content = `${msg.text ? '<p>' + msg.text + '</p>' : ''}<a href="${msg.file}" download="${msg.fileName}" class="file-msg"><i class="fas fa-file-alt"></i><span>${msg.fileName}</span></a>`;
            else content = msg.text;

            let senderNameHtml = (!isMe && currentChatType === 'group' && msg.senderName) ? `<span class="group-sender-name">${msg.senderName}</span>` : '';
            const editedTag = msg.isEdited ? `<span class="message-edited">${translations[currentLanguage].message_edited}</span>` : '';

            div.innerHTML = `${senderNameHtml}${replyBlockHtml}${content}<div class="message-time">${formatFullDate(msg.timestamp)}${editedTag}${ticks}</div>`;
            if (isSelectionMode && selectedMessages.has(key)) div.classList.add('selected');
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            const tabs = document.querySelectorAll('.tab');
            if(tabName === 'all') tabs[0].classList.add('active');
            if(tabName === 'favorite') tabs[1].classList.add('active');
            if(tabName === 'group') tabs[2].classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        function generateQRCode(uid) {
            const container = document.getElementById('qrCode');
            container.innerHTML = '';
            new QRCode(container, { text: uid, width: 200, height: 200 });
        }

        function openQRScanner() {
    document.getElementById('qrScannerModal').classList.add('active');
    
    setTimeout(() => {
        if(html5QrCode) { 
            try { html5QrCode.clear(); } catch(e) {}
        }

        html5QrCode = new Html5Qrcode("reader");
        
        const config = { 
            fps: 10, 
            // আগে 250 ছিল, এখন 350 করা হলো যাতে বক্স বড় হয়
            qrbox: { width: 350, height: 350 }, 
            aspectRatio: 1.0 
        };
        
        html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess)
        .catch(err => {
            showToast("Camera error: " + err);
            closeQRScanner();
        });
    }, 300);
}

function closeQRScanner() {
    // ১. আগে মডাল (UI) বন্ধ করে দিচ্ছি যাতে ইউজার মনে করে সাথে সাথে কাজ হয়েছে
    document.getElementById('qrScannerModal').classList.remove('active');

    // ২. এখন ব্যাকগ্রাউন্ডে ক্যামেরা বন্ধ করবো
    if (html5QrCode) {
        html5QrCode.stop().then(() => {
            html5QrCode.clear();
        }).catch(err => {
            console.log("Scanner stop error: ", err);
            // যদি কোনো এরর হয়, তবুও জোর করে ক্লিয়ার করবো
            try { html5QrCode.clear(); } catch(e) {}
        });
    }
}

        function onScanSuccess(decodedText) {
    // ১. স্ক্যান সফল হলে আগে ক্যামেরা বা স্ক্যানার বন্ধ করবো
    if (html5QrCode) {
        html5QrCode.stop().then(() => {
            html5QrCode.clear();
            closeQRScanner(); // মডাল বন্ধ
            
            // ২. প্রাপ্ত UID দিয়ে অটোমেটিক প্রসেস শুরু করবো
            handleQRAutoConnect(decodedText);
        }).catch(err => {
            // যদি ক্যামেরা বন্ধ করতে সমস্যা হয়, তবুও আমরা কানেক্ট করার চেষ্টা করবো
            closeQRScanner();
            handleQRAutoConnect(decodedText);
        });
    }
}

// এই ফাংশনটি UID নিবে, ফ্রেন্ড অ্যাড করবে এবং চ্যাট ওপেন করবে
function handleQRAutoConnect(targetUid) {
    targetUid = targetUid.trim();

    // নিজের QR স্ক্যান করলে আটকাবে
    if (targetUid === currentUser.uid) {
        return showToast("You cannot connect with yourself!");
    }
    
    // লোডিং টোস্ট দেখান
    showToast("Processing ID...");

    // ১. আগে চেক করবো এই ইউজার আসলেই আছে কিনা
    database.ref('users/' + targetUid).once('value', snapshot => {
        if (snapshot.exists()) {
            const targetUser = snapshot.val();
            
            // যদি ইউজার ব্যানড থাকে
            if (targetUser.isBanned) return showToast('This user is banned.');

            // ২. ফ্রেন্ডলিস্টে অ্যাড করা (কানেকশন তৈরি)
            const updates = {};
            const friendData = { 
                addedAt: firebase.database.ServerValue.TIMESTAMP, 
                lastActivity: firebase.database.ServerValue.TIMESTAMP 
            };
            
            // আমার লিস্টে তাকে এবং তার লিস্টে আমাকে অ্যাড করা
            updates['friends/' + currentUser.uid + '/' + targetUid] = friendData;
            
            // যদি এডমিন না হয়, তবে তার লিস্টেও আমাকে অ্যাড করবো
            if (targetUid !== ADMIN_UID) {
                updates['friends/' + targetUid + '/' + currentUser.uid] = friendData;
            }

            database.ref().update(updates).then(() => {
                showToast(`Connected with ${targetUser.name}!`);
                
                // ৩. সবশেষে সরাসরি চ্যাট ওপেন করা
                // চ্যাট পেজে সুইচ করা
                switchFooterTab('chat'); 
                
                // চ্যাট উইন্ডো ওপেন করা
                setTimeout(() => {
                    openChat(targetUser);
                }, 500); // হাফ সেকেন্ড দেরি, যাতে পেজ সুইচ স্মুথ হয়
            });

        } else {
            showToast('Invalid QR Code / User not found');
        }
    }).catch(error => {
        showToast("Error connecting: " + error.message);
    });
}

        function showForgotPasswordModal() {
            document.getElementById('resetStep1').style.display = 'block';
            document.getElementById('resetStep2').style.display = 'none';
            document.getElementById('resetStep3').style.display = 'none';
            document.getElementById('forgotPasswordModal').classList.add('active');
            if (!windowVerifier) { windowVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', { 'size': 'invisible' }, auth); }
        }

        function initiateFaceReset() {
            const phone = document.getElementById('resetPhone').value.trim();
            if (!phone) return showToast('Enter phone number');
            const fullPhone = selectedCountry.code + phone;

            database.ref('users').orderByChild('number').equalTo(fullPhone).once('value')
                .then(snapshot => {
                    if (snapshot.exists()) {
                        userToResetUID = Object.keys(snapshot.val())[0];
                        const userData = snapshot.val()[userToResetUID];
                        
                        if (userData.faceDescriptor) {
                            storedFaceDescriptor = userData.faceDescriptor;
                            startFaceScan(false); 
                        } else {
                            showToast("Face ID not set for this account.");
                        }
                    } else {
                        showToast('Phone number not found');
                    }
                });
        }

        function sendResetCode() {
            const phone = document.getElementById('resetPhone').value.trim();
            if (!phone) return showToast('Enter phone number');
            const fullPhone = selectedCountry.code + phone; 
            database.ref('users').orderByChild('number').equalTo(fullPhone).once('value').then(snapshot => {
                    if (snapshot.exists()) {
                        userToResetUID = Object.keys(snapshot.val())[0]; 
                        auth.signInWithPhoneNumber(fullPhone, windowVerifier).then((confirmation) => {
                                confirmationResult = confirmation; 
                                showToast('Code sent!');
                                document.getElementById('resetStep1').style.display = 'none';
                                document.getElementById('resetStep2').style.display = 'block';
                            }).catch((error) => showToast('Error sending code.'));
                    } else showToast('Phone number not found');
                });
        }

        function verifyResetCode() {
            const otp = document.getElementById('resetOTP').value.trim();
            if (confirmationResult && otp) {
                confirmationResult.confirm(otp).then(() => {
                        showToast('Verified!');
                        document.getElementById('resetStep2').style.display = 'none';
                        document.getElementById('resetStep3').style.display = 'block';
                        auth.signOut(); 
                    }).catch(() => showToast('Invalid code.'));
            }
        }

        function finalResetPassword() {
            const newPass = document.getElementById('newResetPassword').value.trim();
            if (newPass.length < 6) return showToast('Password min 6 chars');
            if (userToResetUID) {
                database.ref('users/' + userToResetUID).update({ password: newPass }).then(() => {
                    showToast('Password updated!'); closeModal('forgotPasswordModal');
                });
            }
        }

        function toggleMenu() { document.getElementById('dropdownMenu').classList.toggle('active'); }
        function showSettingsModal() { document.getElementById('settingsModal').classList.add('active'); document.getElementById('dropdownMenu').classList.remove('active'); }
        function showBlockListModal() { document.getElementById('blockListModal').classList.add('active'); document.getElementById('settingsModal').classList.remove('active'); loadBlockedUsers(); }
        
        // ====================================================
        // ✅ ফাস্ট ডাটা লোড করার হেল্পার ফাংশন (এটি এখানে বসান)
        // ====================================================
        async function getUserDataOptimized(uid) {
            // ১. প্রথমে লোকাল স্টোরেজ চেক করা (Friends List থেকে)
            const cachedFriends = JSON.parse(localStorage.getItem('cachedFriendsList')) || [];
            const foundLocal = cachedFriends.find(u => u.uid === uid);
            
            if (foundLocal) {
                return foundLocal; // ডাটা ফোনে থাকলে সাথে সাথে রিটার্ন করবে
            }

            // ২. না থাকলে ফায়ারবেস থেকে আনবে
            const snapshot = await database.ref('users/' + uid).once('value');
            return snapshot.val();
        }

        // ====================================================
        // এর নিচেই আপনার আপডেটেড loadBlockedUsers ফাংশনটি থাকবে
        // ====================================================
        function loadBlockedUsers() {
            // ... (বাকি কোড) ...
        }
        
        function loadBlockedUsers() {
            const listContainer = document.getElementById('blockedUsersList');
            const emptyState = document.getElementById('emptyBlockedList');
            
            // লোডিং ইন্ডিকেটর
            listContainer.innerHTML = '<div style="padding:10px;text-align:center;color:#888;">Loading...</div>';

            database.ref(`blockedUsers/${currentUser.uid}`).once('value', async (snapshot) => {
                listContainer.innerHTML = ''; // ক্লিয়ার লোডার

                if (!snapshot.exists()) {
                    if(emptyState) emptyState.style.display = 'block';
                    return;
                }
                
                if(emptyState) emptyState.style.display = 'none';
                
                const blockedUids = Object.keys(snapshot.val());
                
                const userPromises = blockedUids.map(uid => getUserDataOptimized(uid));
                const users = await Promise.all(userPromises);

                users.forEach(user => {
                    if (user) {
                        const div = document.createElement('div');
                        div.className = 'user-item';
                        // 👇 এখানে বাটন স্টাইল পরিবর্তন করা হয়েছে 👇
                        div.innerHTML = `
                            <div class="user-avatar-small">
                                <img src="${user.profilePic}" style="width:100%;height:100%;border-radius:50%" loading="lazy">
                            </div>
                            <div class="user-details">
                                <div class="user-name">${user.name}</div>
                            </div>
                            <button class="btn" style="padding: 6px 12px; background: var(--success-color); width: auto; font-size: 12px; margin: 0;" onclick="unblockFromSettings('${user.uid}', event)">
                                <span>Unblock</span>
                            </button>
                        `;
                        listContainer.appendChild(div);
                    }
                });
            });
        }
        
        function unblockFromSettings(uid, event) {
            event.stopPropagation();
            database.ref(`blockedUsers/${currentUser.uid}/${uid}`).remove().then(() => { showToast("Unblocked"); loadBlockedUsers(); loadDataFromFirebase(); });
        }
        
        function openChangePasswordModal() { closeModal('settingsModal'); document.getElementById('changePasswordModal').classList.add('active'); }
        function updatePassword() {
            const newPass = document.getElementById('newPassword').value;
            if (document.getElementById('oldPassword').value !== currentUser.password) return showToast('Incorrect old password');
            database.ref('users/' + currentUser.uid).update({ password: newPass }).then(() => {
                currentUser.password = newPass; localStorage.setItem('chatAppUser', JSON.stringify(currentUser));
                showToast('Updated'); closeModal('changePasswordModal');
            });
        }
        
        function openChangePhoneModal() { closeModal('settingsModal'); document.getElementById('changePhoneModal').classList.add('active'); document.getElementById('currentIdDisplay').textContent = currentUser.number; }
        function updatePhoneNumber() {
            const newPhone = selectedCountry.code + document.getElementById('newPhoneNumber').value.trim();
            if (document.getElementById('phoneChangePassword').value !== currentUser.password) return showToast('Incorrect password');
            database.ref('users').orderByChild('number').equalTo(newPhone).once('value').then(snapshot => {
                if (snapshot.exists()) return showToast('Number already used');
                database.ref('users/' + currentUser.uid).update({ number: newPhone }).then(() => {
                    currentUser.number = newPhone; localStorage.setItem('chatAppUser', JSON.stringify(currentUser));
                    closeModal('changePhoneModal'); showHomePage();
                });
            });
        }
        
        function showLanguageModal() { closeModal('settingsModal'); document.getElementById('languageModal').classList.add('active'); }
        function changeLanguage(langCode) {
            currentLanguage = langCode; localStorage.setItem('appLanguage', langCode);
            const texts = translations[langCode];
            document.querySelectorAll('[data-i18n]').forEach(el => { const key = el.getAttribute('data-i18n'); if (texts[key]) el.textContent = texts[key]; });
            if (langCode === 'ar' || langCode === 'ur') document.body.classList.add('rtl'); else document.body.classList.remove('rtl');
            closeModal('languageModal');
        }

        function showEditProfileModal() { document.getElementById('editProfileModal').classList.add('active'); document.getElementById('settingsModal').classList.remove('active'); document.getElementById('editProfileName').value = currentUser.name; document.getElementById('editPreview').src = currentUser.profilePic; }
        function updateProfile() {
            const nameInput = document.getElementById('editProfileName');
            const name = nameInput.value.trim();
            
            if (!name) {
                showToast("নাম খালি রাখা যাবে না!");
                return;
            }

            const updates = {};
            updates[`users/${currentUser.uid}/name`] = name;

            if (uploadedImageBase64) {
                updates[`users/${currentUser.uid}/profilePic`] = uploadedImageBase64;
            }

            database.ref().update(updates)
                .then(() => {
                    currentUser.name = name;
                    if (uploadedImageBase64) {
                        currentUser.profilePic = uploadedImageBase64;
                    }
                    localStorage.setItem('chatAppUser', JSON.stringify(currentUser));

                    showHomePage(); 
                    
                    closeModal('editProfileModal');
                    uploadedImageBase64 = null; 
                    showToast("প্রোফাইল সফলভাবে আপডেট হয়েছে! ✅");
                })
                .catch(err => {
                    showToast("আপডেট হতে সমস্যা হয়েছে: " + err.message);
                });
        }

        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function showToast(msg) { const toast = document.getElementById('toast'); toast.innerText = msg; toast.classList.add('show'); setTimeout(() => toast.classList.remove('show'), 3000); }
        document.getElementById('messageInput').addEventListener('keypress', function (e) { if (e.key === 'Enter') sendMessage(); });

        function setupPresenceSystem() {
            if (!currentUser) return;

            const myStatusRef = database.ref(`users/${currentUser.uid}/status`);
            const lastActiveRef = database.ref(`users/${currentUser.uid}/lastActive`);
            const connectedRef = database.ref('.info/connected');

            connectedRef.on('value', (snap) => {
                if (snap.val() === true) {
                    myStatusRef.onDisconnect().set('offline');
                    lastActiveRef.onDisconnect().set(firebase.database.ServerValue.TIMESTAMP);

                    if (document.visibilityState === 'visible') {
                        myStatusRef.set('online');
                    }
                }
            });

            document.addEventListener('visibilitychange', function() {
                if (document.visibilityState === 'hidden') {
                    myStatusRef.set('offline');
                    lastActiveRef.set(firebase.database.ServerValue.TIMESTAMP);
                } else {
                    myStatusRef.set('online');
                    myStatusRef.onDisconnect().set('offline');
                    lastActiveRef.onDisconnect().set(firebase.database.ServerValue.TIMESTAMP);
                }
            });
        }

// ==========================================
        //  IMPROVED TEXT TO SPEECH (TTS) SYSTEM
        //  (এই কোডটি setupPresenceSystem() এর নিচে বসান)
        // ==========================================

        const synth = window.speechSynthesis;
        let voices = []; 

        // ব্রাউজারে ভয়েস লোড করার ফাংশন
        function loadVoices() {
            voices = synth.getVoices();
        }

        // ভয়েস লোড হওয়ার জন্য অপেক্ষা করা
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = loadVoices;
        }

        // ১. ভয়েস মোড চালু বা বন্ধ করা
        function toggleTTSMode() {
            isTTSMode = !isTTSMode;
            const btn = document.getElementById('ttsToggleBtn');
            
            if (isTTSMode) {
                if(btn) btn.classList.add('tts-active');
                
                // ভয়েস লিস্ট লোড আছে কিনা চেক করা
                if(voices.length === 0) loadVoices();

                showToast("Voice Mode On: Click any message.");
                
                // টেস্ট সাউন্ড (যাতে বোঝা যায় মোড অন হয়েছে)
                const u = new SpeechSynthesisUtterance("Voice mode on");
                synth.speak(u);
            } else {
                if(btn) btn.classList.remove('tts-active');
                synth.cancel(); // আগের কথা বলা বন্ধ হবে
                document.querySelectorAll('.message.reading').forEach(el => el.classList.remove('reading'));
                showToast("Voice Mode Off");
            }
        }

        // ২. মেসেজ পড়ে শোনানোর উন্নত ফাংশন
        function speakText(text, msgId) {
            // যদি ভয়েস মোড অফ থাকে, তাহলে কাজ করবে না
            if (!isTTSMode) return;

            // আগের কোনো মেসেজ সিলেক্ট করা থাকলে তা রিমুভ করা
            document.querySelectorAll('.message.reading').forEach(el => el.classList.remove('reading'));
            
            // নতুন মেসেজ হাইলাইট করা
            const msgDiv = document.getElementById(`msg-${msgId}`);
            if (msgDiv) msgDiv.classList.add('reading');

            let cleanText = text || "";
            
            // যদি টেক্সট না থাকে (ছবি/ভিডিও হয়)
            if (msgDiv && !text) {
                if (msgDiv.querySelector('.file-msg')) cleanText = "Sent a file";
                else if (msgDiv.querySelector('img')) cleanText = "Sent a photo";
                else if (msgDiv.querySelector('video')) cleanText = "Sent a video";
                else if (msgDiv.querySelector('audio')) cleanText = "Sent a voice note";
            }

            if (!cleanText) cleanText = "Empty message";

            // --- Android App এর জন্য (Java Interface) ---
            if (typeof Android !== "undefined" && Android.speak) {
                try {
                    Android.speak(cleanText);
                    // অ্যাপে হাইলাইট বন্ধ করার টাইমার
                    setTimeout(() => {
                        if (msgDiv) msgDiv.classList.remove('reading');
                    }, 1000 + (cleanText.length * 100));
                    return; // অ্যাপ হলে এখানেই শেষ
                } catch (e) {
                    console.log("Android TTS Failed, trying Web TTS...");
                }
            }

            // --- Web Browser এর জন্য ---
            if (synth.speaking) {
                synth.cancel();
            }

            const utterance = new SpeechSynthesisUtterance(cleanText);
            
            // ইমোশন লজিক (রাগ, কান্না, খুশি)
            let pitch = 1; 
            let rate = 0.85;  

            if (cleanText.includes('!') || cleanText.includes('😡')) { rate = 1.1; pitch = 0.8; } // রাগ
            if (cleanText.includes('😢') || cleanText.includes('😭')) { rate = 0.8; pitch = 0.9; } // কান্না
            if (cleanText.includes('😂') || cleanText.includes('😃')) { rate = 1.1; pitch = 1.2; } // খুশি

            utterance.pitch = pitch;
            utterance.rate = rate;

            // ভাষা অনুযায়ী ভয়েস সিলেকশন
            if(voices.length === 0) voices = synth.getVoices();

            const hasBangla = /[\u0980-\u09FF]/.test(cleanText);
            let selectedVoice = null;

            if (hasBangla) {
                // বাংলা ভয়েস খোঁজা
                selectedVoice = voices.find(v => v.lang.includes('bn') || v.lang.includes('Bay'));
            } 
            
            if (!selectedVoice) {
                // ইংরেজি ভয়েস (Google বা ডিফল্ট)
                selectedVoice = voices.find(v => v.name.includes('Google') && v.lang.includes('en')) || voices[0];
            }

            if (selectedVoice) utterance.voice = selectedVoice;

            // কথা শেষ হলে
            utterance.onend = function() {
                if (msgDiv) msgDiv.classList.remove('reading');
            };
            
            // কোনো সমস্যা হলে
            utterance.onerror = function(e) {
                console.error("Speech Error:", e);
                if (msgDiv) msgDiv.classList.remove('reading');
            };

            synth.speak(utterance);
        }

// ==========================================
//  TIKTOK CLONE SYSTEM (FINAL FIXED MASTER CODE)
// ==========================================

// --- VARIABLES ---
let currentReelsUser = null;
let currentProfileTab = 'grid'; 
let viewingUid = null;
let reelsObserver = null;

// ==========================================
//  1. NAVIGATION SYSTEM (FIXED)
// ==========================================

function switchFooterTab(tabName) {
    // ১. প্রথমে সব পেজ এবং রিলস বন্ধ করি
    const allPages = ['homePage', 'connectPage', 'callsPage', 'reelsPage', 'storyPage'];
    allPages.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.style.display = 'none';
            el.classList.remove('active');
        }
    });

    // ২. ফুটার বাটন রিসেট করি
    document.querySelectorAll('.footer-btn').forEach(b => {
        b.classList.remove('active');
        b.style.color = '#888';
    });

    // ৩. যদি REELS এ ক্লিক করা হয়
    if (tabName === 'reels') {
        openReels(); 
        return; 
    }

    // ৪. অন্য পেজ হলে মেইন ফুটার দেখাই
    const footer = document.querySelector('.footer');
    if (footer) footer.style.display = 'flex';

    // ৫. নির্দিষ্ট পেজ ওপেন করি
    let targetId = 'homePage'; // ডিফল্ট চ্যাট
    if (tabName === 'connect') targetId = 'connectPage';
    else if (tabName === 'calls') targetId = 'callsPage';
    else if (tabName === 'story') targetId = 'storyPage';

    const targetEl = document.getElementById(targetId);
    if (targetEl) {
        targetEl.style.display = 'flex';
        targetEl.classList.add('active');
    }

    // ৬. বাটন একটিভ করি
    const activeBtn = document.querySelector(`.footer-btn[onclick="switchFooterTab('${tabName}')"]`);
    if (activeBtn) {
        activeBtn.classList.add('active');
        activeBtn.style.color = 'var(--primary-color)';
    }
}

// ==========================================
//  2. REELS OPEN/CLOSE LOGIC
// ==========================================

function openReels() {
    // মেইন ফুটার লুকানো
    document.querySelector('.footer').style.display = 'none';

    // রিলস পেজ চালু করা
    const reelsPage = document.getElementById('reelsPage');
    reelsPage.style.display = 'flex';
    reelsPage.classList.add('active');

    // প্রোফাইল চেক এবং হোম ফিড লোড
    checkReelsProfile();
    
    // নিশ্চিত করা যে Home Section দেখাচ্ছে
    switchTikTokNav('home');
}

function exitReels() {
    // ভিডিও পজ করা
    document.querySelectorAll('video').forEach(v => v.pause());

    // রিলস বন্ধ করা
    document.getElementById('reelsPage').style.display = 'none';
    
    // চ্যাট পেজে ফিরে যাওয়া এবং ফুটার দেখানো
    switchFooterTab('chat');
}

function switchTikTokNav(tab) {
    // সব Nav বাটন রিসেট
    document.querySelectorAll('.tt-nav-item').forEach(el => el.classList.remove('active'));
    
    // সব সেকশন লুকানো
    ['ttHomeSection', 'ttInboxPage', 'ttProfilePage'].forEach(id => {
        document.getElementById(id).style.display = 'none';
    });

    // নির্দিষ্ট ট্যাব ওপেন
    if(tab === 'home') {
        document.getElementById('ttNavHome').classList.add('active');
        document.getElementById('ttHomeSection').style.display = 'block';
        loadReelsFeed();
    } 
    else if(tab === 'inbox') {
        document.getElementById('ttNavInbox').classList.add('active');
        document.getElementById('ttInboxPage').style.display = 'flex';
        loadRealInbox();
    } 
    else if(tab === 'profile') {
        document.getElementById('ttNavProfile').classList.add('active');
        document.getElementById('ttProfilePage').style.display = 'flex';
        openTikTokProfile(currentUser.uid); // নিজের প্রোফাইল
    }
}

// ==========================================
//  3. VIDEO FEED & UPLOAD
// ==========================================

function switchReelsFeed(type) {
    document.getElementById('tabFriends').classList.toggle('active', type === 'friends');
    document.getElementById('tabForYou').classList.toggle('active', type === 'foryou');
    loadReelsFeed();
}

function loadReelsFeed() {
    const container = document.getElementById('reelsContainer');
    if(container.children.length === 0) {
        container.innerHTML = '<div style="color:white;margin-top:60%;text-align:center;"><i class="fas fa-spinner fa-spin"></i> Loading...</div>';
    }

    database.ref('reels_videos').limitToLast(50).once('value', snapshot => {
        container.innerHTML = '';
        if(!snapshot.exists()) {
             container.innerHTML = '<p style="color:white;text-align:center;margin-top:60%">No Videos Available</p>';
             return;
        }
        
        const allVideos = [];
        snapshot.forEach(c => allVideos.unshift(c.val()));
        
        // Friends Filter Logic
        if (document.getElementById('tabFriends').classList.contains('active')) {
            database.ref(`reels_follows/${currentUser.uid}`).once('value', s => {
                const following = s.val() || {};
                const friendVideos = allVideos.filter(v => following[v.userId]);
                if(friendVideos.length === 0) container.innerHTML = '<p style="color:white;text-align:center;margin-top:60%">Follow friends to see videos</p>';
                else friendVideos.forEach(v => renderReelItem(v, container));
            });
        } else {
            allVideos.forEach(v => renderReelItem(v, container));
        }
        
        setTimeout(startReelObserver, 500);
    });
}

// ==========================================
//  4. PROFILE SYSTEM
// ==========================================

function openTikTokProfile(uid) {
    viewingUid = uid;
    
    // পেজ ডিসপ্লে সেটআপ
    document.getElementById('ttHomeSection').style.display = 'none';
    document.getElementById('ttInboxPage').style.display = 'none';
    document.getElementById('ttProfilePage').style.display = 'flex';
    
    // বাটন কন্ট্রোল
    const actionContainer = document.getElementById('ttProfileActions');
    const uploadBtn = document.getElementById('ttFloatingUpload');
    const backBtn = document.getElementById('profileBackBtn');

    if(uid === currentUser.uid) {
        // নিজের প্রোফাইল
        uploadBtn.style.display = 'flex'; // (+) বাটন দেখাবে
        backBtn.style.display = 'none';   // ব্যাক বাটন লুকাবে
        
        // এডিট বাটন নিশ্চিত করা
        actionContainer.innerHTML = `<button class="tt-btn-edit" onclick="openEditReelsProfile()">Edit profile</button>`;
    } 
    else {
        // অন্যের প্রোফাইল
        uploadBtn.style.display = 'none'; // (+) বাটন লুকাবে
        backBtn.style.display = 'block';  // ব্যাক বাটন দেখাবে
        
        // ফলো বাটন চেক
        database.ref(`reels_follows/${currentUser.uid}/${uid}`).once('value', s => {
            if(s.exists()) {
                actionContainer.innerHTML = `
                    <button class="tt-btn-edit" style="width:45%" onclick="messageUser('${uid}')">Message</button> 
                    <button class="tt-btn-edit" style="width:45%" onclick="toggleFollow('${uid}', true)"><i class="fas fa-user-check"></i></button>
                `;
            } else {
                actionContainer.innerHTML = `<button class="tt-btn-follow" style="width:100%" onclick="toggleFollow('${uid}', false)">Follow</button>`;
            }
        });
    }

    // ডাটা লোড
    database.ref('reels_users/'+uid).once('value', s => {
        const u = s.val();
        if(u) {
            document.getElementById('ttProfileName').innerText = u.name;
            document.getElementById('ttProfileTopName').innerText = u.name;
            document.getElementById('ttProfileUsername').innerText = u.username;
            document.getElementById('ttProfilePic').src = u.profilePic;
            document.getElementById('ttProfileBio').innerText = u.bio || 'No bio yet.';
            document.getElementById('ttStatsFollowers').innerText = u.followers || 0;
            document.getElementById('ttStatsFollowing').innerText = u.following || 0;
            document.getElementById('ttStatsLikes').innerText = u.likes || 0;
        }
    });
    
    switchProfileTab('grid');
}

function checkReelsProfile() {
    if (!currentUser) return;
    database.ref('reels_users/' + currentUser.uid).once('value', snapshot => {
        if (snapshot.exists()) {
            currentReelsUser = snapshot.val();
        } else {
            // Create Default Profile
            const defProfile = {
                uid: currentUser.uid, name: currentUser.name, username: 'user'+Math.floor(Math.random()*10000),
                profilePic: currentUser.profilePic, followers:0, following:0, likes:0
            };
            database.ref('reels_users/' + currentUser.uid).set(defProfile);
            currentReelsUser = defProfile;
        }
    });
}

function saveReelsProfile() {
    const name = document.getElementById('editReelsName').value;
    const bio = document.getElementById('editReelsBio').value;
    const pic = document.getElementById('editReelsPic').src;

    if(bio.length > 100) return showToast("Bio max 100 chars");
    if(bio.toLowerCase().includes('ceo') && currentUser.uid !== ADMIN_UID) {
        return showToast("CEO title not allowed!");
    }

    database.ref('reels_users/'+currentUser.uid).update({ name: name, bio: bio, profilePic: pic })
        .then(() => {
            showToast("Profile Saved!");
            document.getElementById('editReelsProfileModal').classList.remove('active');
            openTikTokProfile(currentUser.uid); // Refresh
        });
}

function openEditReelsProfile() {
    document.getElementById('editReelsProfileModal').classList.add('active');
    // ইনপুট ফিল্ডে বর্তমান ভ্যালু বসানো
    document.getElementById('editReelsName').value = document.getElementById('ttProfileName').innerText;
    document.getElementById('editReelsBio').value = document.getElementById('ttProfileBio').innerText;
    document.getElementById('editReelsPic').src = document.getElementById('ttProfilePic').src;
}

// 4. FOLLOWERS / FOLLOWING LIST
function showFollowList(type) {
    // type = 'followers' or 'following'
    if(!viewingUid) return;
    
    document.getElementById('ttListModal').classList.add('active');
    document.getElementById('ttListTitle').innerText = (type === 'followers') ? 'Followers' : 'Following';
    const list = document.getElementById('ttListContent');
    list.innerHTML = 'Loading...';
    
    // Path: reels_follows/uid OR reels_followers/uid
    const dbPath = (type === 'followers') ? `reels_followers/${viewingUid}` : `reels_follows/${viewingUid}`;
    
    database.ref(dbPath).once('value', s => {
        list.innerHTML = '';
        if(!s.exists()) { 
            list.innerHTML = '<p style="text-align:center;padding:20px;color:#777;">Empty list</p>'; 
            return; 
        }
        
        s.forEach(c => {
            const targetUid = c.key;
            database.ref('reels_users/'+targetUid).once('value', uSnap => {
                const u = uSnap.val();
                if(u) {
                    const div = document.createElement('div');
                    div.className = 'user-item';
                    div.onclick = () => { 
                        document.getElementById('ttListModal').classList.remove('active');
                        openTikTokProfile(targetUid); 
                    };
                    div.innerHTML = `
                        <img src="${u.profilePic}" class="user-avatar-small">
                        <div class="user-details">
                            <div class="user-name">${u.name}</div>
                            <div class="user-status">@${u.username}</div>
                        </div>
                    `;
                    list.appendChild(div);
                }
            });
        });
    });
}

// 5. MESSAGE USER FROM PROFILE
function messageUser(targetUid) {
    database.ref('users/'+targetUid).once('value', s => {
        if(s.exists()) {
            exitReels(); // Close reels
            openChat(s.val()); // Open chat
        }
    });
}

// ==========================================
//  5. HELPERS (Search, Tabs, Etc)
// ==========================================

function openTikTokSearch() { document.getElementById('ttSearchPage').style.display = 'flex'; }
function closeReelsSearch() {
    // সার্চ পেজটি লুকানোর জন্য
    const searchPage = document.getElementById('ttSearchPage');
    searchPage.classList.remove('active');
    searchPage.style.display = 'none';
    
    // ইনপুট বক্স খালি করার জন্য
    document.getElementById('ttSearchInput').value = '';
    
    // আগের সার্চ রেজাল্ট মুছে ফেলার জন্য
    document.getElementById('ttSearchResults').innerHTML = '';
}
function searchReelsData() {
    const q = document.getElementById('ttSearchInput').value.toLowerCase().trim();
    const box = document.getElementById('ttSearchResults');
    
    if(q.length < 1) {
        box.innerHTML = '';
        return;
    }
    
    database.ref('reels_users').once('value', s => {
        box.innerHTML = '';
        if(!s.exists()) {
            box.innerHTML = '<p style="padding:10px; text-align:center;">No users found</p>';
            return;
        }

        s.forEach(c => {
            const u = c.val();
            // Name অথবা Username চেক করা হচ্ছে
            const nameMatch = u.name.toLowerCase().includes(q);
            const userMatch = (u.username && u.username.toLowerCase().includes(q));

            if(nameMatch || userMatch) {
                // সার্চ রেজাল্টে ক্লিক করলে প্রোফাইল ওপেন হবে এবং সার্চ পেজ বন্ধ হবে
                box.innerHTML += `
                <div class="user-item" onclick="closeReelsSearch(); openTikTokProfile('${u.uid}')">
                    <img src="${u.profilePic}" class="user-avatar-small">
                    <div class="user-details">
                        <div class="user-name">${u.name}</div>
                        <div class="user-status" style="font-size:12px; color:#666;">@${u.username || ''}</div>
                    </div>
                </div>`;
            }
        });
    });
}

function togglePlayPause(vid) { if(vid.paused) vid.play(); else vid.pause(); }

function toggleReelLike(vidId, btn) {
    const icon = btn.querySelector('i');
    const span = btn.querySelector('span');
    let count = parseInt(span.innerText);
    
    if(icon.style.color === 'white') {
        icon.style.color = 'red'; count++;
        database.ref(`reels_likes/${vidId}/${currentUser.uid}`).set(true);
        database.ref(`reels_user_likes/${currentUser.uid}/${vidId}`).set(true);
    } else {
        icon.style.color = 'white'; count--;
        database.ref(`reels_likes/${vidId}/${currentUser.uid}`).remove();
        database.ref(`reels_user_likes/${currentUser.uid}/${vidId}`).remove();
    }
    span.innerText = count;
    database.ref(`reels_videos/${vidId}/likesCount`).set(count);
}

function startReelObserver() {
    if(reelsObserver) reelsObserver.disconnect();
    
    reelsObserver = new IntersectionObserver(entries => {
        entries.forEach(e => {
            if(e.isIntersecting) { 
                e.target.currentTime = 0; 
                // Play promise handle করা হয়েছে ক্র্যাশ এড়ানোর জন্য
                var playPromise = e.target.play();
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        console.log("Auto-play prevented by browser/webview policy");
                    });
                }
            }
            else {
                e.target.pause();
            }
        });
    }, {threshold: 0.6});
    
    document.querySelectorAll('.reel-video').forEach(v => reelsObserver.observe(v));
}

// ভিডিওতে ক্লিক করলে সাউন্ড অন/অফ এবং প্লে/পজ হবে
function togglePlayPause(vid) { 
    if(vid.paused) {
        vid.play();
    } else {
        // যদি ভিডিও মিউট করা থাকে এবং চলছে, তাহলে ক্লিক করলে আনমিউট হবে
        if(vid.muted) {
            vid.muted = false;
            showToast("Sound On 🔊");
        } else {
            vid.pause();
        }
    }
}

// 6. INBOX & FOLLOW
function loadRealInbox() {
    const list = document.getElementById('ttInboxChatList');
    list.innerHTML = '<p style="text-align:center; padding:20px;">Loading...</p>';
    
    // আমার ফলোয়িং লিস্ট আনো
    database.ref(`reels_follows/${currentUser.uid}`).once('value', myFollowsSnap => {
        const myFollowing = myFollowsSnap.val() || {};
        const mutualFriends = [];

        if (!myFollowsSnap.exists()) {
            list.innerHTML = '<p style="text-align:center; padding:20px; color:#777;">No friends yet. Follow someone!</p>';
            return;
        }

        // প্রত্যেক ফলোয়িং চেক করো, সে আমাকে ফলো করে কিনা
        const promises = Object.keys(myFollowing).map(targetUid => {
            return database.ref(`reels_follows/${targetUid}/${currentUser.uid}`).once('value').then(checkSnap => {
                if (checkSnap.exists()) {
                    return targetUid; // ইয়েস, মিউচুয়াল ফ্রেন্ড
                }
                return null;
            });
        });

        Promise.all(promises).then(results => {
            const validFriends = results.filter(uid => uid !== null);
            
            if (validFriends.length === 0) {
                list.innerHTML = '<p style="text-align:center; padding:20px; color:#777;">No mutual friends found.</p>';
                return;
            }

            list.innerHTML = '';
            validFriends.forEach(uid => {
                database.ref('reels_users/' + uid).once('value', uSnap => {
                    const u = uSnap.val();
                    if (u) {
                        const div = document.createElement('div');
                        div.className = 'tt-inbox-item';
                        div.onclick = () => { exitReels(); openChat({uid: uid, name: u.name, profilePic: u.profilePic}); };
                        div.innerHTML = `
                            <img src="${u.profilePic}" class="tt-inbox-avatar">
                            <div class="tt-inbox-content">
                                <div class="tt-inbox-name">${u.name}</div>
                                <div class="tt-inbox-msg">Tap to chat</div>
                            </div>
                            <i class="fas fa-camera" style="color:#888;"></i>
                        `;
                        list.appendChild(div);
                    }
                });
            });
        });
    });
}

function toggleFollow(targetUid, isUnfollow) {
    if(isUnfollow) {
        database.ref(`reels_follows/${currentUser.uid}/${targetUid}`).remove();
        database.ref(`reels_followers/${targetUid}/${currentUser.uid}`).remove();
        showToast("Unfollowed");
    } else {
        database.ref(`reels_follows/${currentUser.uid}/${targetUid}`).set(true);
        database.ref(`reels_followers/${targetUid}/${currentUser.uid}`).set(true);
        showToast("Following");
    }
    setTimeout(()=>openTikTokProfile(targetUid), 500);
}

function switchProfileTab(type) {
    currentProfileTab = type;
    document.querySelectorAll('.tt-ptab').forEach(e => e.classList.remove('active'));
    const idx = type==='grid'?0:(type==='saved'?1:2);
    document.querySelectorAll('.tt-ptab')[idx].classList.add('active');
    
    const grid = document.getElementById('ttProfileGrid');
    grid.innerHTML = 'Loading...';
    
    let ref;
    if(type === 'grid') ref = database.ref('reels_videos').orderByChild('userId').equalTo(viewingUid);
    else if(type === 'saved') ref = database.ref(`reels_saves/${viewingUid}`);
    else ref = database.ref(`reels_user_likes/${viewingUid}`);

    ref.once('value', s => {
        grid.innerHTML = '';
        if(!s.exists()) { grid.innerHTML = '<p style="padding:20px;width:300%;text-align:center;">No videos</p>'; return; }
        
        s.forEach(c => {
            const val = c.val(); 
            // If Grid, val is video object. If Liked/Saved, check if video object exists or fetch by ID
            if(val.videoUrl) {
                 grid.innerHTML += `<div class="tt-grid-item"><video src="${val.videoUrl}#t=0.1" class="tt-grid-img"></video></div>`;
            } else {
                 // Fetch by Key if only ID is stored
                 database.ref('reels_videos/'+c.key).once('value', v => {
                     if(v.exists()) grid.innerHTML += `<div class="tt-grid-item"><video src="${v.val().videoUrl}#t=0.1" class="tt-grid-img"></video></div>`;
                 });
            }
        });
    });
}

// ==========================================
//  ADVANCED UPLOAD SYSTEM JS
// ==========================================

// Variables for Upload
let selectedReelFile = null;
let selectedAudioFile = null;
let reelOverlayText = "";
let reelType = 'video'; 

// 1. OPEN/CLOSE MODAL
function openReelsUploadModal() {
    const modal = document.getElementById('reelsUploadModal');
    modal.style.display = 'flex';
    modal.classList.add('active');
    
    // Reset UI
    selectedReelFile = null; 
    selectedAudioFile = null; 
    reelOverlayText = "";
    
    document.getElementById('previewImage').style.display = 'none';
    document.getElementById('previewVideo').style.display = 'none';
    document.getElementById('overlayTextInput').style.display = 'none';
    document.getElementById('btnUploadAudio').style.display = 'none';
    document.getElementById('uploadPlaceholder').style.display = 'block'; // দেখাবে যে মিডিয়া সিলেক্ট করা নেই
    document.getElementById('reelCaption').value = '';
    
    // অটোমেটিক গ্যালারি ওপেন করার চেষ্টা করবে
    setTimeout(() => {
        document.getElementById('reelMediaInput').click();
    }, 300);
}

// মিডিয়া হ্যান্ডেল ফাংশনে placeholder লুকানোর কোড যোগ করা হলো
function handleMediaSelect(input) {
    if (input.files && input.files[0]) {
        // ... (আগের কোড এখানে থাকবে) ...

        // নতুন লাইন: মিডিয়া সিলেক্ট হলে লেখাটি লুকিয়ে ফেলুন
        document.getElementById('uploadPlaceholder').style.display = 'none'; 

        const file = input.files[0];
        
        // বাকি লজিক আগের মতোই...
        // Video Size Check
        if(file.type.startsWith('video/') && file.size > 50 * 1024 * 1024) {
            alert("Video too large! Keep under 50MB.");
            return;
        }

        selectedReelFile = file;
        const url = URL.createObjectURL(file);
        const isVideo = file.type.startsWith('video');
        reelType = isVideo ? 'video' : 'image';

        const imgEl = document.getElementById('previewImage');
        const vidEl = document.getElementById('previewVideo');
        const audBtn = document.getElementById('btnUploadAudio');

        if (isVideo) {
            vidEl.src = url; vidEl.style.display = 'block'; vidEl.play();
            imgEl.style.display = 'none'; audBtn.style.display = 'none'; 
        } else {
            imgEl.src = url; imgEl.style.display = 'block';
            vidEl.style.display = 'none'; audBtn.style.display = 'block'; 
            
            compressImage(file).then(blob => { selectedReelFile = blob; });
        }
    }
}

function closeUploadModal() {
    const modal = document.getElementById('reelsUploadModal');
    modal.classList.remove('active');
    modal.style.display = 'none';
    document.getElementById('previewVideo').src = ""; // Stop playback
}

function handleAudioSelect(input) {
    if (input.files && input.files[0]) {
        selectedAudioFile = input.files[0];
        showToast("Audio added!");
        document.getElementById('btnUploadAudio').style.color = '#00F2EA'; 
    }
}

// --- NEW REELS LOGIC ---

// 1. Media Select & Fast Image Compression
function handleMediaSelect(input) {
    if (input.files && input.files[0]) {
        const file = input.files[0];
        
        // Video Size Check (Fast Upload এর জন্য ৫০MB এর বেশি ভিডিও আটকানো)
        if(file.type.startsWith('video/') && file.size > 50 * 1024 * 1024) {
            alert("Video too large! Please upload under 50MB for speed.");
            closeUploadModal();
            return;
        }

        selectedReelFile = file;
        const url = URL.createObjectURL(file);
        
        const isVideo = file.type.startsWith('video');
        reelType = isVideo ? 'video' : 'image';

        const imgEl = document.getElementById('previewImage');
        const vidEl = document.getElementById('previewVideo');
        const audBtn = document.getElementById('btnUploadAudio');
        const textInput = document.getElementById('overlayTextInput');

        // Reset Text
        textInput.value = "";
        textInput.style.display = 'none';

        if (isVideo) {
            vidEl.src = url; 
            vidEl.style.display = 'block'; 
            vidEl.play();
            imgEl.style.display = 'none';
            audBtn.style.display = 'none'; 
        } else {
            imgEl.src = url; 
            imgEl.style.display = 'block';
            vidEl.style.display = 'none';
            audBtn.style.display = 'block'; 
            
            // Image Compression (Speed Up)
            compressImage(file).then(compressedBlob => {
                selectedReelFile = compressedBlob; // Replace original with compressed
            });
        }
    } else {
        closeUploadModal();
    }
}

// 2. Facebook Style Text Toggle
// টেক্সট এডিটর এবং কালার বাটন টগল করার ফাংশন
function toggleTextEditor() {
    const input = document.getElementById('overlayTextInput');
    const colorBtn = document.getElementById('btnTextColor');

    if (input.style.display === 'none') {
        // টেক্সট বক্স এবং কালার বাটন দেখাও
        input.style.display = 'block';
        colorBtn.style.display = 'block'; 
        input.focus();
    } else {
        // যদি বক্স খালি থাকে, তাহলে সব লুকিয়ে ফেলো
        if(input.value.trim() === "") {
            input.style.display = 'none';
            colorBtn.style.display = 'none';
        } else {
            // লেখা থাকলে শুধু কালার বাটন লুকাও, টেক্সট থাক
            // অথবা আপনি চাইলে সব সময় কালার বাটন রাখতে পারেন।
            // আমি আপাতত টগল সিস্টেমে রাখলাম:
            input.focus(); // ফোকাস আবার ইনপুটে দিলাম
        }
    }
}

// কালার পরিবর্তন করার নতুন ফাংশন
function applyTextColor(picker) {
    const color = picker.value;
    const input = document.getElementById('overlayTextInput');
    
    if(input) {
        input.style.color = color;
        // টেক্সট শ্যাডো আপডেট করা যাতে লাইট কালারেও লেখা বোঝা যায়
        if (color.toLowerCase() === '#ffffff' || color.toLowerCase() === '#fff') {
            input.style.textShadow = '2px 2px 4px black';
        } else {
            input.style.textShadow = '1px 1px 1px rgba(0,0,0,0.8)';
        }
    }
}

// মিডিয়া হ্যান্ডেল ফাংশনে অডিও বাটন দেখানোর লজিক (আগের মতোই, শুধু নিশ্চিত করার জন্য)
// --- MEDIA & AUDIO HANDLING ---

function handleMediaSelect(input) {
    if (input.files && input.files[0]) {
        document.getElementById('uploadPlaceholder').style.display = 'none'; 
        const file = input.files[0];
        selectedReelFile = file;
        const url = URL.createObjectURL(file);
        
        const isVideo = file.type.startsWith('video');
        reelType = isVideo ? 'video' : 'image';

        const imgEl = document.getElementById('previewImage');
        const vidEl = document.getElementById('previewVideo');
        const audBtn = document.getElementById('btnUploadAudio');
        const audioPlayer = document.getElementById('previewAudioHidden');

        // রিসেট
        audioPlayer.pause();
        audioPlayer.src = "";

        if (isVideo) {
            vidEl.src = url; 
            vidEl.style.display = 'block'; 
            
            // ✅ AUDIO FIX: Muted false করে ভলিউম ১ করে দেওয়া
            vidEl.muted = false; 
            vidEl.volume = 1.0;
            
            var playPromise = vidEl.play();
            if (playPromise !== undefined) {
                playPromise.catch(error => console.log("Auto-play prevented"));
            }

            imgEl.style.display = 'none'; 
            audBtn.style.display = 'none'; 
        } else {
            imgEl.src = url; imgEl.style.display = 'block';
            vidEl.style.display = 'none'; vidEl.pause();
            audBtn.style.display = 'block'; 
            
            // ইমেজ কমপ্রেশন
            compressImage(file).then(blob => { selectedReelFile = blob; });
        }
    }
}

// অডিও সিলেক্ট এবং প্লে করা (Audio Fix)
function handleAudioSelect(input) {
    if (input.files && input.files[0]) {
        selectedAudioFile = input.files[0];
        const audioUrl = URL.createObjectURL(selectedAudioFile);
        
        const audioPlayer = document.getElementById('previewAudioHidden');
        audioPlayer.src = audioUrl;
        audioPlayer.volume = 1.0;
        
        // ✅ AUDIO FIX: সাথে সাথে প্লে করা
        audioPlayer.play().then(() => {
            showToast("Music Added & Playing! 🎵");
        }).catch(e => showToast("Tap to play music"));

        // আইকন কালার চেঞ্জ করে ইউজারকে বুঝানো
        document.querySelector('#btnUploadAudio i').style.color = '#00F2EA';
    }
}

// মডাল বন্ধ করার সময় অডিও বন্ধ করা
function closeUploadModal() {
    const modal = document.getElementById('reelsUploadModal');
    modal.classList.remove('active');
    modal.style.display = 'none';
    
    // ভিডিও এবং অডিও সব পজ করা
    document.getElementById('previewVideo').src = "";
    document.getElementById('previewAudioHidden').src = "";
}

// ==========================================
// 3. REELS UPLOAD FUNCTION (With Auto-Switch)
// ==========================================

// হেল্পার ফাংশন: এটি একটি নির্দিষ্ট অ্যাকাউন্টে আপলোড করার চেষ্টা করে
function uploadToCloudinaryAccount(account, file, progressText) {
    return new Promise((resolve, reject) => {
        const url = `https://api.cloudinary.com/v1_1/${account.cloudName}/auto/upload`;
        const formData = new FormData();
        formData.append("file", file);
        formData.append("upload_preset", account.preset);

        const xhr = new XMLHttpRequest();
        xhr.open("POST", url, true);

        xhr.upload.onprogress = (event) => {
            if (event.lengthComputable && progressText) {
                const p = (event.loaded / event.total) * 100;
                progressText.innerText = `Uploading to ${account.cloudName}: ${Math.round(p)}%`;
            }
        };

        xhr.onload = () => {
            if (xhr.status === 200) {
                resolve(JSON.parse(xhr.responseText)); // সাকসেস
            } else {
                reject(xhr.responseText); // ফেইল (স্টোরেজ ফুল বা অন্য এরর)
            }
        };

        xhr.onerror = () => reject("Network Error");
        xhr.send(formData);
    });
}

// Helper: Image Compressor (ছবি ছোট করে আপলোড স্পিড বাড়াবে)
function compressImage(file) {
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (event) => {
            const img = new Image();
            img.src = event.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const MAX_WIDTH = 1080; // HD Quality but lighter
                const scaleSize = MAX_WIDTH / img.width;
                canvas.width = MAX_WIDTH;
                canvas.height = img.height * scaleSize;

                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                
                // 0.7 means 70% quality (Good balance)
                canvas.toBlob((blob) => {
                    resolve(blob);
                }, 'image/jpeg', 0.7);
            };
        };
    });
}

// 4. UPDATED RENDER FUNCTION (View Logic)
// এই ফাংশনটি আগের renderReelItem কে প্রতিস্থাপন করবে
function renderReelItem(video, container) {
    database.ref('reels_users/' + video.userId).once('value', s => {
        const u = s.val() || {name:'Unknown', profilePic:'https://ui-avatars.com/api/?name=U'};
        
        const div = document.createElement('div');
        div.className = 'tt-video-item';
        
        // Media Content Logic
        let mediaHtml = '';
        if (video.type === 'image') {
            mediaHtml = `
                <img src="${video.videoUrl}" class="tt-video-player" style="object-fit:contain; background:#000;">
                ${video.audioUrl ? `<audio src="${video.audioUrl}" autoplay loop></audio>` : ''}
            `;
        } else {
            // FIX: added 'muted' attribute specifically for Native App/WebView compatibility
            mediaHtml = `<video class="tt-video-player reel-video" loop playsinline muted src="${video.videoUrl}" onclick="togglePlayPause(this)"></video>`;
        }

        let overlayHtml = video.textOverlay ? `<div class="reel-overlay-text">${video.textOverlay}</div>` : '';

        div.innerHTML = `
            ${mediaHtml}
            ${overlayHtml}
            
            <div class="tt-right-sidebar">
                <div class="tt-profile-bubble" onclick="openTikTokProfile('${video.userId}')">
                    <img src="${u.profilePic}">
                    ${video.userId !== currentUser.uid ? '<div class="tt-plus-badge"><i class="fas fa-plus"></i></div>' : ''}
                </div>
                
                <div class="tt-action-btn" onclick="toggleReelLike('${video.videoId}', this)">
                    <i class="fas fa-heart tt-icon-bg" style="color:white"></i>
                    <span class="tt-action-text">${video.likesCount || 0}</span>
                </div>
                
                <div class="tt-action-btn" onclick="openComments('${video.videoId}')">
                    <i class="fas fa-comment-dots tt-icon-bg"></i>
                    <span class="tt-action-text">${video.commentCount || 0}</span>
                </div>

                <div class="tt-action-btn" onclick="shareReel('${video.videoUrl}')">
                    <i class="fas fa-share tt-icon-bg"></i>
                    <span class="tt-action-text">Share</span>
                </div>
            </div>

            <div class="tt-bottom-info">
                <span class="tt-username">${u.name}</span>
                <span class="tt-caption">${video.caption}</span>
            </div>
        `;
        container.appendChild(div);
    });
}

function openMyFollowersList() {
    // নিজের UID সেট করে লিস্ট ওপেন করবে
    viewingUid = currentUser.uid; 
    showFollowList('followers');
}

function openActivityPage() {
    const modal = document.getElementById('ttActivityModal');
    const list = document.getElementById('ttActivityList');
    
    modal.classList.add('active');
    list.innerHTML = '<div style="text-align:center; padding:20px;"><i class="fas fa-spinner fa-spin"></i> Loading...</div>';

    // ১. ফলোয়ার ডাটা আনা
    database.ref(`reels_followers/${currentUser.uid}`).once('value', snapshot => {
        list.innerHTML = '';
        
        if (!snapshot.exists()) {
            list.innerHTML = `
                <div style="text-align:center; margin-top:50px; color:#666;">
                    <i class="far fa-bell" style="font-size:40px; margin-bottom:10px;"></i>
                    <p>No recent activity</p>
                </div>`;
            return;
        }

        // ডাটা লুপ করা
        snapshot.forEach(child => {
            const followerUid = child.key;
            
            // ইউজারের নাম ও ছবি আনা
            database.ref('reels_users/' + followerUid).once('value', uSnap => {
                const u = uSnap.val();
                if (u) {
                    const item = document.createElement('div');
                    item.className = 'tt-inbox-item'; // ইনবক্স আইটেম স্টাইল ব্যবহার করছি
                    item.style.padding = "10px 15px";
                    
                    // এখানে ক্লিক করলে প্রোফাইল ওপেন হবে
                    item.onclick = function() {
                        modal.classList.remove('active');
                        openTikTokProfile(followerUid);
                    };

                    item.innerHTML = `
                        <div style="position:relative;">
                            <img src="${u.profilePic}" class="tt-inbox-avatar">
                            <div style="position:absolute; bottom:0; right:10px; background:#ea4359; color:white; border-radius:50%; width:16px; height:16px; display:flex; justify-content:center; align-items:center; font-size:8px; border:1px solid white;">
                                <i class="fas fa-user-plus"></i>
                            </div>
                        </div>
                        <div class="tt-inbox-content">
                            <div class="tt-inbox-name" style="font-size:14px;">${u.name}</div>
                            <div class="tt-inbox-msg" style="color:#333;">started following you.</div>
                            <div style="font-size:10px; color:#999; margin-top:2px;">Recent</div>
                        </div>
                        <button style="background:#ea4359; color:white; border:none; padding:5px 15px; border-radius:4px; font-weight:600; font-size:12px;">Follow Back</button>
                    `;
                    list.appendChild(item);
                }
            });
        });
    });
}

// --- TEXT DRAGGING & RESIZING LOGIC ---

// টেক্সট বক্সকে ড্র্যাগাবল বানানোর জন্য ইভেন্ট লিসেনার সেট করা
document.addEventListener('DOMContentLoaded', () => {
    const textInput = document.getElementById('overlayTextInput');
    
    let isDragging = false;
    let startX, startY, initialLeft, initialTop;

    // টাচ শুরু হলে
    textInput.addEventListener('touchstart', (e) => {
        isDragging = true;
        const touch = e.touches[0];
        startX = touch.clientX;
        startY = touch.clientY;
        initialLeft = textInput.offsetLeft;
        initialTop = textInput.offsetTop;
    }, {passive: false});

    // টাচ মুভ হলে (ড্র্যাগ করা)
    textInput.addEventListener('touchmove', (e) => {
        if (!isDragging) return;
        e.preventDefault(); // স্ক্রল বন্ধ করা
        const touch = e.touches[0];
        const dx = touch.clientX - startX;
        const dy = touch.clientY - startY;

        // নতুন পজিশন সেট করা
        textInput.style.left = `${initialLeft + dx}px`;
        textInput.style.top = `${initialTop + dy}px`;
        textInput.style.transform = 'none'; // সেন্টার ট্রান্সফর্ম রিমুভ করা
    }, {passive: false});

    // টাচ শেষ হলে
    textInput.addEventListener('touchend', () => {
        isDragging = false;
        // বর্ডার মুছে দেওয়া যাতে প্রিভিউতে খারাপ না লাগে (অপশনাল)
        // textInput.style.border = 'none'; 
    });
    
    // লেখার সাথে সাথে হাইট বাড়া
    window.autoResizeText = function(elem) {
        elem.style.height = 'auto';
        elem.style.height = elem.scrollHeight + 'px';
    }
});

// টেক্সট এডিটর টগল (আপডেট করা)
function toggleTextEditor() {
    const input = document.getElementById('overlayTextInput');
    const colorBtn = document.getElementById('btnTextColor');
    const sizeControl = document.getElementById('textSizeControl');

    if (input.style.display === 'none') {
        input.style.display = 'block';
        colorBtn.style.display = 'block';
        sizeControl.style.display = 'block'; // সাইজ স্লাইডার দেখাবে
        input.focus();
    } else {
        if(input.value.trim() === "") {
            input.style.display = 'none';
            colorBtn.style.display = 'none';
            sizeControl.style.display = 'none';
        }
    }
}

// ফন্ট সাইজ চেঞ্জ ফাংশন
function changeFontSize(size) {
    const input = document.getElementById('overlayTextInput');
    input.style.fontSize = size + 'px';
    autoResizeText(input); // হাইট অ্যাডজাস্ট করা
}
    </script>
</body>
</html>